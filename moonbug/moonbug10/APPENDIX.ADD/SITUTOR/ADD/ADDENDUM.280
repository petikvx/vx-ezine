                 ПРИЛОЖЕНИЕ ДЛЯ SOFT-ICE (ДОС) ВЕРСИИ 2.8

Это приложение содержит все новые команды, особенности и исправления ошибок
в Soft-ICE для ДОС, начиная с версии 2.64.

                        УСТАНОВКА
                        ---------

Чтобы установить новую версию Soft-ICE для ДОС в вашей системе, вставьте
гибкий диск в ваш дисковод и:

 -Скопируйте все файлы с диска в каталог на вашем жестком диске.
 -Запустите EMMSETUP на S-ICE.EXE, чтобы сконфигурировать менеджер памяти.
  Синтаксис:
            EMMSETUP S-ICE.EXE

 -Создайте новый файл CONFIG.SYS для Soft-ICE для ДОС. Пример такого
  файла прилагается и называется CONFIG.ICE.



                     НОВЫЕ/ИЗМЕНЕННЫЕ КОМАНДЫ
                     ------------------------

---------------------------------------------------------------------

                     P

P -- Программный Шаг

Синтаксис:
          P [ RET ]

Комментарии:

Команда P - выполняет логический программный шаг. Выполняется одна команда
по текущим CS:IP, если эта команда - не вызов, прерывание, цикл или
повторяющаяся строковая команда. В этих случаях, до возврата управления
Soft-ICE, выполняется вся подпрограмма или итерация.

Команда P использует "одноразовую" точку останова на выполнение. "Нелипкая"
точка останова на выполнение использует один отладочный регистр 80386, пока
все отладочные регистры не заняты для "липких" точек останова. В этом случае
применяется точка останова в стиле INT 3. В такой ситуации команды P и G не
будут корректно работать в ПЗУ. При попытке их применения будет выдаваться
сообщение об ошибке.

В режиме исходного текста команда P переходит к следующему оператору в
исходном тексте. Если текущий оператор - процедура или вызов функции, команда
P ее "перешагивает".

Если указан параметр RET, команда P будет трассировать программу до следующей
инструкции RET или IRET.

----------------------------------------------------------------------

                     LINES

LINES -- Изменяет количество строк на экране Soft-ICE.

Синтаксис:
          LINES [ 25 | 43 | 50 ]

Комментарии:

Команда LINES изменяет текстовый режим экрана Soft-ICE. Она предоставляет
три различных экранных режима : 25 строк, 43 строки или режим 50 строк.
Режим с 43 строками допустим только на адаптерах VGA или EGA, а режим с
50 строками допустим только на адаптерах VGA.

По умолчанию число строк экрана - 25. Если ваш экран Soft-ICE находится на
другой ЭВМ, соединенной последовательным кабелем, экран фиксируется
на 25 строках.

----------------------------------------------------------------------

                     SERIAL

SERIAL -- Переназначает управление на последовательный терминал.

Синтаксис:
          SERIAL [ ON [ com-port] [ скорость бод] | OFF ]
          com-порт                Это - число от 1 до 4, соответствующее
                                  COM1 COM2, COM3 или COM4.
                                  По умолчанию - COM1.

          cкорость-бод            Это - скорость в бодах при использовании
                                  последовательной связи. По умолчанию
                                  Soft-ICE предоставляется возможность
                                  автоматически определить самую высокую
                                  возможную скорость в бодах, которую можно
                                  использовать.

Комментарии:

Отладка через последовательный терминал требует второго IBM-совместимого ПК
с запущеной MSDOS. Подойдет любой ПК, включая 8088, 8086 или 80286.
Вы должны сначала соединить компьютер с вашей главной ЭВМ по нуль-модемному
кабелю. Перед использованием команды SERIAL, вы должны выполнить программу
REMOTE.EXE на втором ПК. Синтаксис для REMOTE.EXE - следующий:

        REMOTE ON com-порт скорость-бод

-----------------------------------------------------------------------

                        WATCH

WATCH -- Добавить контрольное выражение.

Синтаксис:
          WATCH [ размер ] выражение

          размер    B,W,D,I,E,U,F,S,L,A

                    B - вывести байт в шестнадцатеричном формате
                    W - вывести слово в шестнадцатеричном формате
                    D - вывести двойное слово в шестнадцатеричном формате
                    I - вывести слово в десятичном формате (int)
                    E - вывести двойное слово в десятичном формате (long int)
                    U - вывести слово в беззнаковом десятичном формате
                    F - вывести двойное слово в беззнаковом десятичном формате
                    S - вывести 4-х байтовое (float) вещественное число
                    L - вывести 8-ми байтовое (double) вещественное число
                    A - вывести строку символов ASCII ( макс. 33 )

Комментарии:

Команды WATCH используются для просмотра результатов выражений. Результаты
выражения выводятся в формате указанного размера. Если размер не определен,
принимается размер - байт. Контролируемые выражения отображаются в конрольных
окнах. Могут конторолироваться до восьми выражений одновременно. Каждый раз
при вызове экрана Soft-ICE, в контрольном окне будут отображаться текущие
значения выражений.

Каждая строка в контрольных окнах содержит следующую информацию:

        Номер выражения от 0 до 7.

        Шестнадцатеричный адрес выражения.

        Текущее значение выражения, отображаемое в соответствующем формате.

        Оцениваемое выражение.

Примеры:

        WATCHW FooVariable
        WATCHD DS:ESI

----------------------------------------------------------------------

                        CWATCH

CWATCH -- Очистить контрольное выражение.

Синтаксис:
          CWATCH список | *

          список        Это - список номеров выражений от 0 до 7, разделенных
                        запятыми. Номера выражений - это номера, отображаемые
                        в начале каждой строки в контрольном окне.

          *             Очистить все контрольные выражения.

Комментарии:

Команда CWATCH используется для очистки одного или более выражений из
контрольного окна. После очистки выражений, оставшиеся в окне выражения
последовательно перенумеровываются, начиная с 0. Если контольных выражений
больше нет, окно исчезает.

-----------------------------------------------------------------------

                        STKWIN

STKWIN -- Вывести или очистить окно стека

Синтаксис:
          STKWIN [ ON | OFF ]

Комментарии:

Команда STKWIN добавляет к экрану Soft-ICE окно стека. Каждая строка
показывает 4-хзначное (шестнадцатеричное) смещение из BP и 4-хзначное
(шестнадцатеричное) значение слова по этому адресу. Вы можете прокручивать
окно стека при помощи клавиш ALT-Стрелка-Вниз. Вы можете редактировать только
подсвеченную строку. Чтобы изменить значение в окне стека, используйте
команду ES.

-------------------------------------------------------------------------

                        ES

ES -- Изменить подсвеченное значение в окне стека

Синтаксис:
          ES [ шестнадцатеричное значение ]

          Шестнадцатеричное значение      4-хзначный адрес для изменения

Комментарии:

Команда ES позволяет вам изменять значения стека,
относительно BP в окне стека. Аналогична команде E.

--------------------------------------------------------------------------

                        XRSET

XRSET -- Сбросить буфер обратной трассировки

Синтаксис:
          XRSET [ A | I | R ]

          A               Регистрирует только адреса.
          I               Регистрирует адреса и опкоды.
          R               Регистрирует адреса, опкоды и регистры.

Комментарии:

Команда XRSET сбрасывает буфер обратной трассировки. Эта команда должна
выполняться перед установкой диапазона обратной трассировки, если в буфере
обратной трассировки имеется нежелательная информация о командах.

При использовании параметров I и R, потребуется значительно больше памяти
для сохранения информации в буфере обратной трассировки. Эта память
резервируется в строке устройства Soft-ICE в CONFIG.SYS.

Программа (BTLOG.EXE) была добавлена чтобы записывать содержимое буфера
обратной трассировки в файл в формате текста ASCII. Количество записываемой
информации зависит от опции, выбранной в команде XRSET, использованной для
установки обратной трассировки. Синтаксис этой программы аналогичен команде
SHOW:

                  BTLOG имя-файла строка-начала L длина
                  
-------------------------------------------------------------------------

                        COLORS
                        
COLORS -- Изменить цвета информационных окон Soft-ICE

Синтаксис:
           COLORS [ цвет | * ]
        
           цвет      Шестнадцатеричное число, представляющее изменяемый цвет

           *         Пропустить изменение цвета для этого поля.
           
Комментарии:

Команда COLOR принимает до 12 параметров в следующем порядке:

        нормальный - подсветка - инвертированный       для Окна Регистров
        нормальный - подсветка - инвертированный       для Окна Данных
        нормальный - подсветка - инвертированный       для Окна Кода
        нормальный - подсветка - инвертированный       для Окна Команд
        
Цвета останутся такими как вы их изменили пока ЭВМ не будет перезагружена. В
этом случае, цвета будут возвращены к цветам по умолчанию.
Для постоянного изменения цветов, см. строку цветов в S-ICE.DAT.

Пример:

        COLORS * * * 4f 40 74 * * * 5d
        
        Оставит старые атрибуты окна регистров и кода,
        изменит атрибуты окна данных на 4F для нормального,
        40 для подсветки, и 74 для инвертированного, и
        изменит нормальный атрибут окна команд на 5D, оставив
        неизмененными атрибуты подсветки и инверсии.

        
        COLORS * * * * * * * * * 5d 40 74
        
        Оставит неизменными цвета во всех окнах, за исключением
        окна команд. Изменит нормальный цвет окна команды на 5d,
        подсветку - на 40 и инверсию - на 74.
        
-------------------------------------------------------------------------

                        R
                        
R - Вывод или изменение значений регистров

Синтаксис:
           R [ название регистра [[=]значение]]
           
           название регистра   Любое из следующих:
                               EAX, AX, AH, AL
                               EBX, BX, BH, BL
                               ECX, CX, CH, CL
                               EDX, DX, DH, DL
                               EDI, DI, ESI, SI
                               EBP, BP, ESP, SP
                               CS, DS, ES, SS
                               FS, GS, FL

           значение            Если название регистра - любое, кроме FL,
                               то значение - шестнадцатеричное число или
                               выражение. Если название регистра - FL, то
                               значение - ряд из одного или более следующих
                               символов флагов, с необязательно предшествующим
                               каждому знаком плюса или минуса:
                                       O ( Флаг Переполнения )
                                       D ( Флаг Направления )
                                       I ( Флаг Прерывания )
                                       S ( Флаг Знака )
                                       Z ( Флаг Нуля )
                                       A ( Дополнительный флаг переноса )
                                       P ( Флаг Четности )
                                       C ( Флаг Переноса )
                                       
Комментарии:

Если параметры не указаны, отображаются все значения регистров и флагов,
так же как и инструкция по текущиму адресу CS:IP.

Если указано и имя регистра и значение, то содержимое указанного регистра
заменяется на значение.

---------------------------------------------------------------------------

                        SL
                        
SL -  Выводит строки-разделители окон

Синтаксис:

        SL
        
Комментарии:

Команда SL помещает границы между каждым из окон данных внутри Soft-ICE.
Эта команда особенно полезна для отладки на монохромных мониторах.
По умолчанию, строки не выводятся.

===========================================================================



                        НОВЫЕ ОСОБЕННОСТИ
                        -----------------
                        
Вывод сегментных регистров FS и GS.

Подсветка регистров, которые  изменились со времени последнего вызова
Soft-ICE.

Вывод сообщений "ПЕРЕХОД" или " НЕТ ПЕРЕХОДА " во время пошагового
выполнения программы, если текущая команда - условный переход.

Возможность установки контрольных точек в оверлеях VROOM.

Вывод локальных (стековых) переменных по именам.

Изменена BPR ... TW, чтобы работать c областями данных; она будет
регистрировать все команды, которые записывают в эту область.

Использование файлов .PTH & .SRC

        Если в окружении нет выражения SET SRC=...,
        LDR.EXE попытается открыть файл с именем имя-программы.PTH
        Если такой файл существует, LDR прочтет его и будет
        использовать пути, указанные в нем для поиска исходных
        файлов. В версии 2.71 было изменение, чтобы заставить LDR.EXE
        сначала искать файл имя-программы.PTH, так что это перекроет
        любое выражение SET SRC.
        
        Перед загрузкой исходных файлов, LDR.EXE будет пытаться открыть
        файл с именем программа.SRC. В этом файле должен быть список
        исходных файлов для загрузки - если файл существует, будут
        загружены только те исходные файлы, которые в нем указаны.
        
        Файлы .PTH & .SRC должны быть в том же самом каталоге, что и файл
        имя-программы.EXE. Синтаксис .PTH файла - подобен оператору
        пути за исключением того, что нет "PATH = ", а есть только пути.
        Следующее выражение - пример:
        
                c:\ldr\new;d:\bcdos\engine;c:\sibcdos\ui;
                
        Формат файла .SRC - список имен исходных файлов,
        включая расширения, каждый в отдельной строке -
        например:
        
                asm.asm
                sym.asm
                volume.cpp
                mgraph.c
                
        Обратите внимание, что этот файл не содержит никакой
        информации о диске или каталоге.

        
Использование TDS файлов Borland для получения отладочных данных

        Если Borland файл .EXE не содержит отладочных данных, LDR.EXE
        попытается открыть файл с именем имя-программы.TDS в том же
        каталоге, что и файл .EXE. Если такой файл существует, она
        прочтет из него отладочные данные.
        
        Файл TDS может быть создан путем выполнения TDSTRIP с переключателем
        /s на .EXE файле, который содержит отладочные данные Borland.

        
Передача команд в Soft-ICE из LDR.EXE

        LDR.EXE может передавать команды в Soft-ICE одним из двух
        способов: прямо из командной строки или из файла, указанного
        в командной строке. В обоих случаях последовательность команд
        выполняется при "всплытии" Soft-ICE в начале выполнения
        прикладной программы. Если вы хотите, чтобы программа выполнялась
        без остановки на экране Soft-ICE, поместите "X" последней
        командой в строке.
        
        При передаче команд прямо из командной строки, вся
        последовательность команд должна быть заключена в
        косые черты. Последовательность команд может включать
        символьные имена и команды установки точек останова.
        Например, следующая строка установит точку останова на
        переменную "base", установит окно данных на вывод этой
        переменной в формате слова, а затем выйдет из Soft-ICE и
        начнет выполнять прикладную программу без "всплытия":
        
                ldr    /bpm base;dw base;x/     myprog
                
        Обратите внимание, что косая черта указана и перед и
        после последовательности команд - это позволяет использовать
        в командах пробелы. Также обратите внимание, что команды
        разделяются точками с запятой. Последняя команда в строке не
        нуждается в завершающей точке с запятой.
        
        Чтобы указать файл, содержащий команды Soft-ICE, используйте
        переключатель "/n" или "/N" в командной строке LDR (Нет
        никаких команд Soft-ICE, которые бы начинались с "n" или "N",
        так что это не может быть прямой командой). НЕ должно быть
        косой черты после имени файла - первый пробел после имени
        файла - завершающий символ.
        
        Файл команд должен быть в текущем каталоге, иначе должен быть
        указан полный путь. Последовательность команд в файле может
        использовать либо знак CR либо CRLF либо точки с запятой как
        разделители между командами. Размер буфера команд Soft-ICE
        ограничивает длину файла 200 символами.
        
        Синтаксис должен быть чем-то вроде следующего:
        
                ldr   /nc:\prog\softice.cmd     myprog

                
==========================================================================


                        ИСПРАВЛЕННЫЕ ОШИБКИ
                        -------------------
                        
Вывод текстового экрана приложения при просмотре
видеопамяти вместо текстового экрана Soft-ICE,
как было в более ранних версиях.

Вывод правильной длины программы в команде MAP, когда
драйверы или TSR'ы загружены в верхнюю память; также
вывод области HMA, и подсветка только одного блока как
текущей программы. Предыдущие версии испытывали затруднения,
когда что-либо загружалось в верхнюю память.

Добавлено дизассемблирование команды JECXZ. Также исправлен вывод
специальных 32-хбитных команд типа CWDE и STOSD, чтобы выводилась
правильная мнемоника.

Исправлен вывод ячейки, адресуемой для отображения двойного слова,
когда размер операнда - 32-х битный, а так же в командах LES, LDS,
LSS, LFS и LGS.

Исправлен вывод ячейки, адресуемой для отображения двойного слова,
когда команда - дальний переход или дальний вызов (опкод FF).

Решена проблема с установкой точек останова в оверлеях, которые
еще не загружены. Точки останова типа BPX теперь могут
устанавливаться на символьные имена в оверлеях. ОБРАТИТЕ ВНИМАНИЕ:
В приложении к версиям 2.5 и 2.6 указано, что для установки точек
останова могут использоваться имена модулей; это неверно. Должны
использоваться символьные имена в оверлеях.

Решена проблема с выводом исходного текста в оверлеях,
когда загружено больше одного оверлея.

Исправлена команда Assemble чтобы распознавать 32-х битные опкоды.

Решена проблема с клавиатурой вызываемая засылкой 60H в порт 64H.
Это приводило к зависанию любой системы, у которой нет мыши PS/2.

Исправлена ошибка Soft-ICE в ALTSCR, когда альтернативный экран был пуст.

Исправлена ошибка в 910H команде прграммного интерфейса, которая
помещает завершаемое нулем сообщение в окно команд Soft-ICE где
оно отображается при "всплытии" Soft-ICE. Ошибка вызывала вывод
только части сообщения.

Изменен LDR чтобы помещать публичные символы MSC7 в модуль, который
фактически их содержит. Это позволяет устанавливать точки останова
на символьные имена в оверлеях MSC7.

Решена проблема когда команды PUSHFD или POPFD вызывали в Soft-ICE
Общую Ошибку Защиты, если производилось выполнение с BREAK ON.

Изменена обработка символьных имен, чтобы позволять им
начинаться с "@", и распознавать полные имена так же как
и их сложные сокращенные эквиваленты.

Решена проблема когда регистр IP обрабатывался как байтовый
регистр при чтении его содержимого, так что команда типа
"U CS:IP" или "D CS:IP" считывала только младший байт IP,
устанавливала старший байт в 0 и выводила код или данные по
этому адресу.

Решена проблема в режиме маленького окна, когда некоторые
экраны не обновлялись, если пользователь выходил в ДОС и снова
вызывал Soft-ICE. Части экрана Soft-ICE все еще показывали
символы и атрибуты, которые были в этих местах на экране ДОС.

Исправлена ошибка, которая происходила только когда использовался
переключатель /EMM; если TSR загружался, используя LDR, и был использован
EXIT, когда он вызывался, и если потом TSR загружался без использования
LDR, Soft-ICE "всплывал" с Общей Ошибкой Защиты.

Исправлена ошибка когда экран Soft-ICE был пуст, если приложение
или ДОС устанавливало видеостраницу на что-либо кроме страницы 0.

Исправлена ошибка в команде A (транслировать), когда сгенерированный
код имел неправильные регистры.

Исправлена ошибка в обработчике BPIO, когда
операндом команды ВВОДА-ВЫВОДА был EAX.

Исправлена ошибка в команде MAP когда Soft-ICE "всплывал" при
загрузке драйвера (начальной загрузке или после команды BOOT).
Структуры DOS на этот момент были незавершены, и Soft-ICE
некорректно обрабатывал эту ситуацию.

Несколько проблем связанных с очень объемными отладочными данными,
когда превышались ограничения сегмента, вызывая Общую Ошибку Защиты.

~~\ Перевел Сергей Середа, 1999, Кишинев 24-71-96, /~~
  ~~\      e-mail: serge_sereda@hotmail.com      /~~