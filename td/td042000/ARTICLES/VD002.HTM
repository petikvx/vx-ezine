<html>

<head>
<meta http-equiv="Content-Type"
content="text/html; charset=windows-1251">
<meta name="GENERATOR" content="Microsoft FrontPage Express 2.0">
<title>Top Device</title>
</head>

<body bgcolor="#B1B1B1" text="#000000" topmargin="0"
leftmargin="3">

<p><STYLE> </p>

<p>INPUT { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt
}</p>

<p>SELECT { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } </p>

<p>OPTION { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } </p>

<p>TEXTAREA { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } </p>

<p>FORM { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt
} <br>
BODY { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt } <br>
P { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt }
TABLE { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt
}TR { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 8pt } TD
{ FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE: 10pt
}TEXTAREA { FONT-FAMILY: Tahoma, sans-serif, arial; FONT-SIZE:
8pt } A { COLOR: #005500; TEXT-DECORATION: none }A:hover {
TEXT-DECORATION: underline } A:link { TEXT-DECORATION: none
}A:visited { }text:unknown { FONT-SIZE: 8pt } } </STYLE> </p>

<table border="0" cellpadding="0" cellspacing="0" width="100%">
    <tr>
        <td>&nbsp;</td>
        <td valign="top"><div align="center"><center><table
        border="0" cellpadding="0" cellspacing="0" width="100%">
            <tr>
                <td width="100%" bgcolor="#000000"><img
                src="../-.gif" width="1" height="1"></td>
            </tr>
            <tr>
                <td width="100%" bgcolor="#808080"><strong>06.04.2000</strong>
                Kern32Vx - еще о нахождении
                kernel32.dll. <strong>[Voodoo]</strong></td>
            </tr>
            <tr>
                <td bgcolor="#000000"><img src="../-.gif"
                width="1" height="1"></td>
            </tr>
            <tr>
                <td><pre>

    Приветствую тебя уважаемый читатель-&quot;писатель&quot; ;). 
Речь сегодня пойдет о импорте функций из кернела для &quot;переносимого 
кода&quot;. Обычно импорт в &quot;переносимом коде&quot; происходит следующим способом:
получаем точку входа, по ней находим MZ заголовок, далее находим 
PE заголовок, там находим импорты кернела, по ним находим MZ заголовок 
кернела, далее PE заголовок, и наконец добираемся до таблицы экспортов
откуда сохраняем адреса нужных API. Во всяком случае этим алгоритмом 
пользовался я сам когда ваял Win32.Magic.1590. Написав DINA v2.0 я 
вспомнил о импорте. Когда код выполняется в стеке этот алгоритм уже не 
работает (&quot;код&quot; запускается вне приложения которое импортирует кернел).
    Существуют  и другие методы ипорта. Так  было предложено использовать
SEH, точнее последний указатель на обработчик исключения. Обычно (если 
прога его не переназначила) он находится внутри кернела, т.е. можно найти
сразу MZ кернела. Этот метод применим в &quot;коде&quot; который получает управление
первым. Если &quot;код&quot; получает управление методом OEP, то нет гарантии что 
к моменту получения управления &quot;final&quot; exception handler будет находиться 
в кернеле. Хотя если учесть этот факт то можно наряду с MZ кернела  
искать и MZ приложения.
   Еще одна вариация на тему SEH и импорты. При возникновении исключения 
получает управление первый обработчик. Он разбирает исключение и если он 
его не обрабатывает  выполняются следующий код:
<font color="#0000A0">MOV EAX,1
RET</font>
Это передача управления на следующий по цепочке обработчик. И так будет 
продолжаться до &quot;final&quot; exception handler. Он уже выведет сообщение 
типа &quot;Программа выполнила коректную операцию и будет выгружена&quot;.Если какой 
либо обработчик исправит аварийную ситуацию, выполняются следующий код:
<font color="#0000A0">MOV EAX,0
RET</font>
Что значит :reload context &amp; continue execution.
После исключения ss:[eps]= адрес процедуры которая определяет что делать:
&quot;выполнять&quot; или &quot;выгружать&quot;. Этими привилегиями обладает операционная 
система. В NT она (процедура) лежит в NTDLL.dll, в МД - в KERNELL32.dll.
Идея в том чтобы взять этот адрес за точку входа и двигаясь по уменьшению
искать MZ. При этом следует проверять имя длл`ки. В интишке за KERNEL32.dll
следует NTDLL.dll поэтому  после NTDLL мы найдем KERNEL32. Не знаю как 
дело обстоит в WIN2k но думаю что &quot;кто ищет тот всегда находит&quot;.Последний
алгоритм был реализован в процедуре GetKernelHandlerA в файле kernvx32.inc.
Она в EDI возвращает смещение на MZ кернела. Процедура KernVx32Init в том 
же kernvx32.inc настраивает механизм импорта через SEH. Ее параметром 
является регистр EDI в котором должен находится оффсет на MZ длл`ки. Далее 
мы просто пушим параметры API, пушим APINAMECRC32 и пишем EXEPTION.
EXEPTION - это переменная в файле exeption.inc. Она может принимать два 
значения: DEBUG и NODEBUG. В случае NODEBUG исключение вызывается с 
помощью db 0cch что затрудняет отладку. В случае DEBUG исключение 
вызывается с помощью  db 0ffh,0ffh,0ffh,0c3h,90h,90h,90h (хотя достаточно 
dw 0ffffh). Если APINAMECRC32 найдена в длл`ке (для которой  проинстален 
KernVx32) то выполняется API иначе  EAX=-1.  Для смены DLL следует 
выполнить код типа:
 <font color="#0000A0">call LockDLLName
 db 'NEWDLLNAME.dll',0
 LockDLLName:
 Push zGetModuleHandlerA
 EXIPTION
 xor edx,edx                  ;
 pop dword ptr fs:[edx]   ; 
 pop edx                        ;  
 mov edi,eax 
 call KernVx32Init</font>
Более подробно применение показано в примере kernvx32.asm 
PS.
Интересно как енто будет работать под win2k :


<a href="http://topdev.tsx.org"> Статья для журнала Top Device</a>                                     
             </pre>
                </td>
            </tr>
            <tr>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>&nbsp;</td>
            </tr>
        </table>
        </center></div></td>
        <td>&nbsp;</td>
    </tr>
</table>

<p>&nbsp;</p>
</body>
</html>
