▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
▓▓▓┌──────────────────────────────────────────────────────────────────────┐▓▓▓▓
▓▓▓│                                       ▄ ▄                            │░░▓▓
▓▓▓│ ▄██▄ ▄██▄  █ █  ▄▀▀▄ █  █ █  █ █▐▌█  ▄▄█▄▄ ▄██▄ █▀▀▄ █ █ █ ▄▀▀█ ▄▀▀█ │░░▓▓
▓▓▓│ ▄▄▄█ █▄▄▄ █ █ █ █    █  █ █  █ █  █  █ █ █ █▄▄▄ █  █ █ █ █ █  █ █  █ │░░▓▓
▓▓▓│ ▄▄▄█ █▄▄▄ █ █ █ █  ▄ █▄▀  █  █ █  █  █▄█▄█ █▄▄▄ █▀▀  ▀▄▀▄▀ █▄▄█ █  █ │░░▓▓
▓▓▓│  ▀▀   ▀▀  ▀ ▀ ▀  ▀▀  ▀ ▀▀  ▀▀▀  ▀▀▀    ▀    ▀▀  ▀     ▀ ▀  ▀  ▀ ▀  ▀ │░░▓▓
▓▓▓├──────────────────────────────────────────────────────────────────────┤░░▓▓
▓▓▓│                            В ы п у с к ∙2∙                           │░░▓▓
▓▓▓└──────────────────────────────────────────────────────────────────────┘░░▓▓
▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▓▓
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓


┌──┌─┐┌──
──┘├─┘──┘ Presents
┐  ┌┐┐┌─┤ VMag, Issue 2, 1 June 1998
└─┘┘ ┘└─┘ ──────────────────────────


Вирус Nutcracker.AB0: Атака на ADinf...
---------------------------------------


        В данной статье мы продолжаем знакомство с  интересными  приемами  и
алгоритмами, реализованными в вирусах семейства Nutcracker. Напомню, что ви-
русы  данного  семейства  являются  одними  из  наиболее  сложных,  а  вирус
Nutcracker.AB2 был поставлен Е.В.Касперским по сложности на второе  место  в
мире после Zhengxi.


Введение.

        Формально вирус Nutcracker.AB0 является загрузочным (бутовым)  виру-
сом, поражающим Главную Загрузочную Запись (MBR)  винчестера  и  Загрузочные
(BOOT) сектора дискет. Данный вирус можно отнести к категории очень  опасных
вирусов, т.к. вирусом в некоторых  рассмотренных  ниже  случаях  может  быть
стерто начало винчестера. Основной особенностью данного вируса является  его
способность скрываться от обнаружения популярным антивирусом-ревизором  дис-
ка ADinf Дмитрия Мостового. Причем для этого используется не  какие-то  кон-
кретные меры, направленные конкретно против алгоритма проверок дисков,  реа-
лизованного в ADinf, а оригинальный метод сокрытия  (стелсирования)  измене-
ния MBR винчестера вирусом. Примечательным является еще и тот факт, что учет
данной возможности для стелсирования вирусов был специально добавлен  Д.Мос-
товым в ADinf версию 11.03 в апреле 1997 года, именно исходя из описания ал-
горитма, реализованного в данном вирусе, а сам вирус был выловлен в  "диком"
виде в ноябре-декабре 1995 года. Т.о. около 1.5 года пользователи  ADinf  (и
не только они) находились под угрозой возможной эпидемии данного вируса,  но
почему-то об этом факте Д.Мостовой "забыл" упомянуть в документации к  своей
очередной версии ADinf... Ну, что же, оставим этот эпизод на его совести...


Атака на ADinf: как это работает?..

        Особенностью данного вируса является его алгоритм  сокрытия  искаже-
ния MBR на уровне Int 15, а не Int 13, как большинство загрузочных и  файло-
во-загрузочных стелс-вирусов. Классическая идея стелсирования на уровне  Int
13 состоит следующем: вирус, находясь в памяти,  осуществляет  перехват  Int
13/Fn=2 (чтение сектора) и при попытке прочитать инфицированный MBR подстав-
ляют в буфер чтения оригинальный код, таким образом скрывая свое наличие  на
винчестере. Принцип работы ревизора диска ADinf состоит в том, что  проверка
информации на дисках осуществляется на уровне BIOS Int 13, что не  позволяет
вирусу скрыть свое присутствие, т.к. на вирусный обработчик просто не  пере-
дается управление, что позволяет обнаруживать стелс-вирусы даже при их нали-
чии в памяти! Так что же позволяет остаться незамеченным  для  ADinf'а  рас-
сматриваемому вирусу? Вирус использует для  стелсирования  следующие  "дыры"
операционной системы:

- дело в том, что обработчик Int 13 BIOS перед началом  операции  с  диском,
  принтером и др. вызывает прерывание Int 15/Fn=90 (открыть  устройство).  А
  при окончании обработки - Int 15/Fn=91. Данные вызовы  были  предусмотреын
  для многозадачных операционных систем, чтобы во время обработки  обращения
  к диску операционная система смогла производить некоторые действия.  Вызы-
  вается данное прерывание и при обращении  к  винчестеру.  Вирусом  осущес-
  твляется перехват данного системного вызова и  осуществляется  стелсирова-
  ние, что позволяет ему оставаться "невидимым" даже при  чтении  винчестера
  прямым обращением к BIOS (подробнее см. Обработчик Int 15).

- способ инфицирования MBR, который не позволяет проверить диск  ADinf  даже
  при загрузке с чистой системной дискеты, но не приводит к каким-либо проб-
  лемам при работе с диском на уровне DOS (подробнее см. Инфицирование MBR).

- способ создания резидентной копии, не обнаруживаемый ADinf (подробнее  см.
  Резидентная копия).


Загрузка с инфицированного диска.

        Инфицирование MBR вирусом происходит только при попытке  загрузиться
с дискеты, с инфицированным BOOT сектором. В этом случае  производится  сле-
дующая последовательность операций:

- вирусный загрузчик проверяет: имеется ли копия вируса  в  памяти  (в  этом
  случае байт по адресу 0:87 будет иметь значение 7B), и, при наличии в  па-
  мяти резидентной копии (это может произойти, если вы уже один раз  попыта-
  лись загрузиться с инфицированной дискеты и после выдачи сообщения о заме-
  не незагрузочного диска на загрузочный нажали на клавишу, но не выняли не-
  загрузочный диск или вставили инфицированный новый и  произошла  повторная
  попытка загрузки с инфицированной дискеты) расшифровывает (NOT)  и  выдает
  на экран сообщение:

  Non-system disk or disk error.
  Replace and press any key when ready.

  После чего ждет нажатия на любую клавишу и вызывает Int 19h для  повторной
  попытки загрузки.

- в случае отсутствия в памяти резидентной копии вирус читает с диска 5 сек-
  торов своего кода, находящегося на нестандартно отформатированной инженер-
  ной дорожке дискеты или с инженерного цилиндра винчестера по адресу 7c00:0
  и, в случае успешного чтения, передает управление на свой код. При  ошибке
  чтения, вирус пытается повторить операцию 2 раза и при невозможности  про-
  читать с дискеты основной код производит  ту  же  последовательность  дей-
  ствий, что и при обнаружении в памяти своей активной копии (см.выше).

- получив управление, основной код вируса производит чтение по адресу 0:7c00
  кода оригинального загрузчика (при ошибке выдает сообщение "Non-system..."
  и т.д. [см.выше]) Затем вирус временно перехватывает  Int  15,  инициирует
  вызов Int 13/AX=201 и читает MBR первого винчестера, предварительно сохра-
  нив указатель на стек, чтобы выявить возможность стелсирования  на  уровне
  Int 15. При отсутствии указанной возможности вирус издает звуковой  сигнал
  и передает управление оригинальному загрузчику.  Если  же  BIOS-обработчик
  Int 13 вызывает перед началом операции чтения MBR Int 15/Fn=9000, то  дан-
  ный вызов перехватавается вирусом, вычисляется разность между текущим зна-
  чением стекового указателя и запомненным  и  вычисляется  смещение  адреса
  возврата из BIOS-обработчика Int 13 в стеке относительно значения стеково-
  го указателя при вызове Int 15/Fn=9000. После этого в стеке ищется  значе-
  ние 201 (значение р-ра AX на входе в Int 13) или 200 (если BIOS  сохраняет
  в стеке только номер обрабатываемой функции) и также запоминается его  от-
  носительное смещение. После прочтения MBR,  вирус  восстанавливает  ориги-
  нальный Int 15.

- вирус производит попытку инфицирования MBR первого винчестера и при невоз-
  можности его инфицирования (напр. отсутствии винчестера), а также  в  слу-
  чае ненахождения в стеке при обработке Int 15/Fn=9000 смещения с сохраняе-
  мым BIOS'ом номером обрабатываемой функции передает управление  на  ориги-
  нальный загрузочный код с выдачей звукового сигнала. В случае,  если  вин-
  честер был уже инфицирован, вирус запоминает оригинальные  значения  голо-
  ки/цилиндра начала активного раздела  винчестера,  сохраненные  вирусом  в
  псевдо-загрузочном секторе.

- при успешном инфицировании либо в случае, если MBR винчестера уже был  за-
  ражен, вирус формирует по адрусу 0:4F1 три межсегментных  прямых  перехода
  на собственные обработчики Int 8 (таймер), Int 40 (операции с дискетой)  и
  переход на оригинальный вектор Int 15, а затем перехватывает Int 8  и  Int
  40, устанавливая их адреса на сформированные межмегментные прямые переходы.

- передает управление на оригинальный код загрузчика.


Инфицирование Главной Загрузочной Записи (MBR).

        В вирусе Nutcracker.AB0 применен метод инфицирования MBR впервые ис-
пользованный в вирусе Starship, но имеющий свои  особенности.  Инфицирование
MBR происходит следующим образом:

- в память читается содержимое MBR,  в  Таблице  разделов  диска  (Partition
  table) ищется раздел, помеченный как загружаемый и в память  читается  ак-
  тивный BOOT сектор.

- вирус проверяет BOOT cектор на инфицированность и, если  он  уже  заражен,
  прекращает алгоритм инфицирования винчестера,  в  противном  случае  вирус
  проверяет доступность последних 5  секторов  первого  винчестера  на  чте-
  ние/запись и в случае успеха записывает копию BOOT сектора с внедренным  в
  нее кодом загрузки основного вирусного тела, находящегося в следующих сек-
  торах, и сами сектора основного кода. В зараженном псевдо-BOOT секторе ви-
  рус сохряняет оригинальные значения Цилиндр-Сектор Начала Активного разде-
  ла/Головка Начала Активного Раздела и  устанавливает  данные  параметры  в
  прочитанной копии MBR на инфицированный псевдо-BOOT сектор.

- пишет скорректированный MBR на диск. При наличии IDE вирус производит  за-
  пись MBR путем непосредственного программирования портов винчестера.


Инфицирование Загрузочных секторов дискет.

        Инфицирование дискет производится при чтении BOOT-сектора в физичес-
ком дисководе A: или B:. В этом случае:

- вирусом вычисляется значение инженерной дорожки дискеты (Количество
  Дорожек+1);

- формируется таблица для форматирования дорожки,  причем  номер  начального
  сектора для форматирования выбирается случайным образом в  зависимости  от
  значения таймера;

- форматируется (Int 40) инженерная дорожка дискеты;

- на нее записывается вирусное тело;

- в случае успешного выполнения всех указанных действий в  MBR  записывается
  код вирусного загрузчика, производящего загрузку основного вирусного  кода
  и осуществляющего передачу на него управления.


Резидентная копия.

        Данный вирус в отличие от большинства загрузочных  вирусов  является
резидентым в середине, а не в конце памяти. Данная особенность не  позволяет
обнаруживать его присутствие сравнением доступного при загрузке для DOS зна-
чения памяти с реальным (данный алгоритм проверки реализован в ADinf).  При-
чем вирус может оставаться резидентно и в области UMB, распределяемой  вызо-
вом XMS-драйвера. Причем в данном вирусе применен так  называемый  (Е.В.Кас-
перский) метод "паразитического" резидента. Он заключается в следующем:  ви-
рус не имеет собственного блока распределения памяти (MCB), а добавляет дли-
ну собственного блока к предыдущему, таким образом "паразитируя"  на  нем  и
скрывая свое присутствие в памяти.


Обработчик Int 8 (таймер).

        Данный обработчик используется вирусом для выполнения следующих дей-
ствий:

- на этапе загрузки DOS вирус "ждет" установки DOS-векторов и
  временно перехватывает Int 21.

- вирус постоянно проверяет первые 2 байта  начала  обработчика  Int  15  на
  соответствие CD,7E (Int 7E) и в случае не соответсвия записывает туда дан-
  ный код, сохраняя оригинальные 2 байта в собственном буфере. Вирусом  так-
  же проверяется смена адреса Int 15, и, в случае  смены  последнего,  вирус
  восстанавливает первые 2 байта "старого" обработчика  Int  15,  запоминает
  адрес нового и производит вышепроиведенную операцию.

- на этапе проявления вирус генерирует на экране движущееся изображение "ша-
  рика" со стуком отражающегося от краев экрана и некоторых букв.


Обработчик Int 15 (сервис AT).

        Вирусный обработчик этого прерывания выполняет следующие функции:

- вирусом перехватывается прерывание Int 7E, а вирусный обработчик Int 8 за-
  писывает в начало обработчика Int 15 вызов Int 7E, таким образом, при  вы-
  зове Int 15 срузу же вызывается Int 7E, т.е. вирус.  Данный  прием  позво-
  ляет исключить возможность вызова вирусного обработчика  через  Pushf/Call
  Old_Int15_Handler, если Int 15 будет перехвачен после перехвата Int 15 ви-
  русом, т.е. вирусный обработчик Int 15 _всегда_ получает управление первым.

- вирус обрабатывает вызовы Int 15/Fn=9000,9001,9100,9101 (open/close device
  hard disk/floppy disk). Данные функции вызываются BIOS при обработке  пре-
  рываний Int 13/Int 40. Вирус проверяет: осуществлялся ли вызов данных фун-
  кций BIOS'ом при обработке вирусных внутренних вызовов и, если да, то  пе-
  редает управление на оригинальный обработчик Int 15h, находящийся в  BIOS,
  т.о. вирус противодействует возможному перехвату Int 15h антивирусными мо-
  ниторами.

- вирусом также обрабатывается вызов функции 4F (get scancode), и  в  случае
  обнаружения нажатия комбинации Ctrl-Alt-Del на клавиатуре вирус  проверяет
  некоторые условия и в некоторых случаях осуществляет выполнения  троянской
  компоненты (см. Проявления).

- вирус восстанавливает первые 2 байта обработчика Int  15  и  вызывает  его
  Pushf/Call Old_15h_Hanler. Т.о., по  окончании  обработки  вызова  Int  15
  "старым" обработчиком управление снова получает вирусный код.

- если был осуществлен вызов функции 9000 и сброшен внутренний флаг, то  ви-
  рус проверяет нахождение в стеке по вычисленному на этапе загрузки  смеще-
  нию (см. Загрузка с инфицированного диска) значения 2  или  3,  т.е.  если
  BIOS обрабатывает операцию чтения/записи, вирус подставляет, исходя из вы-
  чесленного на этапе загрузке смещения, в стек адрес возврата из BIOS-обра-
  ботчика Int 13 на свой код и возводит внутренний флаг, чтобы исключить об-
  работку данной ситуации до тех пор, пока BIOS не возвратит  управление  из
  обработчика Int 13 на вирусный код.

- при получении управления данный вирусный код проверяет:  производились  ли
  эти операции с инфицированным MBR первого винчестера и, если  да,  осущес-
  твляет повторное заражение (при записи) или стелсирование начала  активно-
  го раздела в partition table (при чтении), затем передавая  управление  на
  оригинальный адрес возврата.


Обработчик Int 40 (операции с дискетой).

- выполняет вызов оригинального обработчика;

- в случае бессбойного выполнения проверяет: была ли это функция  чтения/за-
  писи и, если так, проверяет системное время и с определенной (довольно ма-
  лой) вероятностью активизирует в обработчике Int 8  генерацию  изображения
  "стучащего шарика", а также запоминает время активизации;

- после этого проверяет дискету на зараженность и, в  случае  необходимости,
  инфицирует ее


Проявления.

- генерация на экране движущегося "шарика" со стуком отражающегося от  краев
  экрана и некоторых букв (см. Обработчик Int 8). В данном режиме работы ви-
  рус отслеживает нажатие пользователем комбинации клавиш Ctrl-Alt-Del  и  в
  случае, если с момента "запуска" шарика прошло менее  5  минут,  отключает
  клавиатуру и затирает первые 100 секторов на двух винчестерских дисках. Ту
  же операцию вирус производит при обнаружении в буфере  данных,  записывае-
  мых на винчестер начало собственного кода, полагая, что он уже обнаружен.

- по 7-м апреля каждого года при загрузке с инфицированного диска вирус рас-
  шифровывает и выводит на экран следующий текст:

  ■S■U■P■E■R■U■N■K■N■O■W■N■ was done by Lord Nutcracker(AB0).

  Затем ждет нажатия на клавишу и продолжает загрузку системы.


Специально для LMD, Nice aka Psychomancer // SPS06.
                    ■ 2:454/5.9@FidoNet
