<html>

<head>
<title>Antiviral Toolkit Pro - как сделать из демо-версии
рабочую</title>
</head>

<body BGCOLOR="#F6F6F6" TEXT="#001010" VLINK="#D7AEAE" link="#800000" alink="#0000FF">

<p align="center"><img src="../pictures/xfiles.gif" alt="Секретные Материалы" WIDTH="625" HEIGHT="60"></p>

<table CELLPADDING="5" CELLSPACING="2" BORDER="1" WIDTH="100%" bgcolor="#FFFFFF">
  <tr>
    <th bgcolor="#E6E6FF"><p align="center"><font color="#000080">Department of Reverse
    Engineering (FBI)</font></th>
  </tr>
  <tr>
    <td align="center" checked="false" bgcolor="#E6E6FF"><font color="#800000"><strong><font size="6">Antiviral Toolkit Pro - как сделать из демо-версии
    рабочую</font><small><small><small><small><br>
    </small></small></small></small></strong><font size="4">Почти всегда
    демо-версия программы может работать как полная</font><small><small><small><small><small><small><small><small>
    </small></small></small></small></small></small></small></small></font></td>
  </tr>
  <tr>
    <td bgcolor="#E6E6FF"><p align="center">Автор статьи: <a href="mailto:ze_tty@yahoo.com"><font size="+3" color="#FF0000"><strong>Zet</strong></font></a></td>
  </tr>
  <tr>
    <td align="center" bgcolor="#E6E6FF"><font color="#000000">Дата
    опубликования</font><font COLOR="890000">: </font><font color="#408080"><strong>8.09.98
    </strong></font></td>
  </tr>
  <tr>
    <td VALIGN="MIDDLE" bgcolor="#E6E6FF"><p align="center"><font color="#000000">Стать
    ориентирована на</font><font color="blue"> <strong>средних</strong> </font><font color="#000000">и</font><font color="blue"> <strong>опытных</strong> </font><font color="#000000">исследователей</font></td>
  </tr>
</table>

<p>&nbsp;&nbsp;&nbsp;&nbsp; В этот раз потребуется внимание и
усидчивость, а так же знание некотрых функций Win32
API. Заодно придется использовать дизассемблер.</p>

<table CELLPADDING="10" CELLSPACING="2" BORDER="1" width="100%" bgcolor="#FFFFFF">
  <tr>
    <td bgcolor="#FFFFEA"><p align="center"><font size="5" color="#0000A0"><strong>Вступление</strong></font></p>
    <p align="left">&nbsp;&nbsp;&nbsp;&nbsp; Наверное, всем известен
    &quot;легендарный&quot; Евгений Касперский и его
    антивирусный пакет Antiviral Toolkit Pro. Не буду
    рассматривать его антивирусные свойства - каждый
    может оценить их сам. Это дело вкуса. В этой
    статье рассматриваются свойства защиты этого
    самого AVP. В исследуемой демо-версии отключена
    возможность лечения зараженных файлов,
    анализатор кода, проверка архивов и сжатых
    файлов. Также отсутсвует возможность проверки
    писем и почтовых баз данных.&nbsp; </td>
  </tr>
  <tr>
    <td bgcolor="#FFFFEA"><p align="center"><font size="5" color="#0000A0"><strong>Необходимые
    инструменты </strong></font></p>
    <ol>
      <li>SoftICE 3.23 for Win95</li>
      <li>Любой шестнадцатиричный редактор файлов</li>
      <li>IDA Pro версии выше 3.74</li>
    </ol>
    </td>
  </tr>
  <tr>
    <td bgcolor="#FFFFEA"><p align="center"><font size="5" color="#0000A0"><strong>Где
    можно достать эти программы?</strong></font></p>
    <p align="left">&nbsp;&nbsp;&nbsp;&nbsp; Программы <a href="../tools/tools.htm">SoftICE
    3.23 и IDA Pro</a> есть на нашем сервере. Получить
    свободно распространяемую демо-версию AVP можно
    на сервере компании Kaspersky Lab <a href="http://www.avp.ru">www.avp.ru</a>.</td>
  </tr>
  <tr>
    <td bgcolor="#FFFFEA"><p align="center"><font size="5" color="#0000A0"><strong>Статья</strong></font></p>
    <h3 align="center"><font color="#800000">Часть 1. Антивирус своими
    руками. </font></h3>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; Как я и говорил, для того, чтобы
    эту программу заставить заработать следует
    изучить функции Win32 API, связанные с отображением
    органов управления. Кроме того, сперва всегда
    следует выяснить, действительно ли перед нами
    урезанная и бесполезная демо-версия, или это
    полностью работоспособная программа с
    отключенными функциями. В данном случае для
    этого удобно использовать продукт The Customiser фирмы
    Wanga International.</p>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; Для проверки запустим AVP и
    посмотрим для начала закладку <u><i>Обьекты</i></u>.
    Сразу видно, что программа не проверяет архивы и
    упакованые исполняемые файлы. Выбрать эти пункты
    нельзя - они отключены (disabled) . Запустим The Customiser
    (который, кстати тоже защищен - возможно появится
    статья и о нем). Выберем <u><em>Edit Windows</em></u>... а там
    пометим <em><u>Enable</u></em> и нажмем кнопку ON. Теперь
    появившимся уродливым курсором щелкнем на
    затененном пункте <u><i>Упакованные Файлы</i></u>.
    Неожиданно он перестанет быть затененным и
    станет обычным, нормальным пунктом. То же
    проделайте со следующим пунктом (архивы). Теперь
    отключите Customiser и выберите эти возврещенные к
    жизни опции. Запустите антивирус, и убедитесь,
    что теперь он проверяет и архивы. Остановите
    проверку. Посмотрите на закладку <u><i>Обьекты</i></u>.
    Требуемые опции опять отключены. Ничего
    удивительного, с помощью Customiser'а мы лишь на время
    изменили их состояние.</p>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; Теперь, убедившись в том, что
    программа имеет требуемую функциональность
    продолжим исследование программы. Некоторые
    скажут, что мы проверили не все. Например мы не
    проверяли закладку <i><u>Действи</u>я</i>. Особенно
    пункт <u><i>Лечить без запроса</i></u>. Скажу сразу,
    лично я все это проверил. Попробуйте и Вы,
    поработайте немного самостоятельно.</p>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; Когда сомнения Вас покинут и Вы
    окончательно убедитесь, что программа в порядке,
    следует приниматься за более серьезные дела.
    Например запустить IDA Pro и дизассемблировать файл
    avp32.exe. Пока он дизассемблируется, откройте Win32 API
    Help и найдите функцию, отвечающую за состояние
    органов управления. Для тех, кто не знает такой
    функции, скажу - это <em>EnableWindow</em>. В <a href="ftp://rtuis.miem.edu.ru/docs/w32api/">файле помощи по
    API-функциям</a> (Microsoft) эта функция описана так:</p>
    <blockquote>
      <p><font color="#000000"><em>BOOL EnableWindow(</em></font></p>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p><font color="#000000"><em>HWND hWnd, // указатель на окно (орган
              управления)<br>
              BOOL bEnable // флаг возможности ввода</em></font></p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
      <blockquote>
        <blockquote>
          <blockquote>
            <blockquote>
              <p><font color="#000000"><em>);</em></font></p>
            </blockquote>
          </blockquote>
        </blockquote>
      </blockquote>
    </blockquote>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; В зависимости от значения <i>bEnable</i>
    компонент может быть в состоянии
    Включен/Отключен (Enabled/Disabled). В состоянии Отключен
    орган управления игнорирует сообщения,
    поступающие от мыши и клавиатуры. Нам требуется
    обратное. Если дизассемблирование закончилось,
    поищите, откуда вызывается функция <em>EnableWindow</em>.
    Таких мест в программе множество. Кстати,
    обратите внимание на типичные
    последовательности вызовов - при работе над
    другими программами с аналогичной защитой Вам
    это пригодится. Типичная последовательность
    такова: <ol>
      <li>Вызывается функция <em>GetDlgItem</em> [в качестве
        аргументов - указатель на окно диалога и
        идентификатор органа управления]. Функция
        возвращает указатель на этот орган управления.</li>
      <li>Вызывается функция <em>EnableWindow</em> [в качестве
        аргументов - указатель на орган управления и флаг
        <i>bEnable</i> (0 - Отключен, 1 - Включен)]. Функция делает
        орган управления неактивным (т.к. <i>bEnable</i> = 0).</li>
    </ol>
    <p align="left">&nbsp;&nbsp;&nbsp;&nbsp; Теперь у вас есть вся
    информация, необходимая для взлома. Как именно
    это сделать - Вы должны решать сами. Тем более, что
    взлом можно осуществить, минимум, пятью разными
    способами. Перечислю некоторые из них:</p>
    <ol>
      <li><p align="left">Найти функцию, в которой отключаются
        требуемые пункты меню, и сделать так, чтобы они
        включились. Сводится к поиску <em>EnableWindow</em> и
        замене предшествующей ей команды <strong><code>push 00</code></strong>
        на <strong><code>push 01</code></strong>. Подсказка: так как при
        отключении требуется заносить в стек 0, в этой
        программе обнуляется регистр ebx и выполняется
        команда <strong><code>push ebx</code></strong>. Все, что требуется -
        записать в ebx 1.<br>
        <b>Преимущества</b> - быстрота.<br>
        <b>Недостатки</b> - недостаточно корректный взлом
        (об этом позже).</p>
      </li>
      <li><p align="left">Исследовать алгоритм, проверяющий
        ключевой файл avp.key, и попытаться на основе этого
        алгоритма вычислить, какая информация в avp.key
        должна быть. Fox Mulder утверждает, что информация из
        ключевого файла нигде в программе не
        используется. То есть это действительно
        демо-версия. Не знаю, не проверял.<br>
        <b>Преимущества</b> - в случае успеха вы становитесь
        &quot;зарегистрированным&quot; пользователем этой, а
        возможно и будущих версий программы без всяких
        побочных эффектов.<br>
        <b>Недостатки</b> - медленно и сложно.</p>
      </li>
    </ol>
    <p align="left">&nbsp;&nbsp;&nbsp;&nbsp; Есть еще и&nbsp; другие
    варианты. Вы можете выбрать любой из них.</p>
    <p align="left">&nbsp;&nbsp;&nbsp;&nbsp; После того, как Вы все это
    сделали, осталась небольшая проблемка - при
    запуске появляется окно с напоминанием о том, что
    программу необходимо зарегистрировать. Решение:
    создайте в директории, в которой установлен AVP,
    файл avp.key с любым содержанием и все проблемы
    исчезнут.</p>
    <h3 align="center"><font color="#800000">Часть 2. Монитор, и как с ним
    бороться. </font></h3>
    <p align="left">&nbsp;&nbsp;&nbsp;&nbsp; Вторая важная часть
    системы AVP - это монитор. Он проверяет все
    файлы,&nbsp; которые открываются во время вашей
    работы, и если обнаруживается вирус, то имеется
    возможность предварительно его (вирус)
    обезвредить и продолжить работу. Лично я
    монитором не пользовался и не собираюсь - лучше
    один раз проверить, то что приносишь, чем
    постоянно сидеть под наблюдением, результатом
    чего является снижение производительности. Но
    надо довести начатое дело до конца. Получить
    рабочую версия AVP из нерабочей демо-версии.
    Вообще-то, ничего нового здесь нет.
    Функциональность монитора урезана точно так же,
    как и антивируса. Я сделал так. С помощью Borland Resource
    Workshop открыл файл avpm.exe и посмотрел на ресурсы. В
    данном случае меня интересовали окна диалогов.
    Например ресурс с номером 113, соответсвующий окну
    <em><u>Действия</u>. </em>Дважды щелкнув на нем,
    попадаем в окно редактировани диалога. Но
    редактировать ничего не будем. Двойным щелчком
    на RadioButton с текстом Disinifect Automatically откроем окно Button
    Style. В этом окне содержится некоторая необходимая
    информация. А именно <u>Control ID</u> . Для упомянутого
    элемента это значение равно 406h. Запомните это
    число - оно пригодится. Откроем IDA Pro и запустим
    дизассемблирование файла AVPM.EXE(если вы сами этого
    еще не сделали). Нажмем Alt+T для поиска текста и
    зададим 406h. После нескольких попыток мы
    обнаружим такой участок кода:</p>
    <blockquote>
      <p><b><code><samp><font color="#008000">loc_4023CE: ; CODE XREF: .text:004023C0<br>
      ; .text:004023C7<br>
      xor ebx, ebx<br>
      cmp dword_4122EC, ebx<br>
      jz short loc_40240E<br>
      push ebx<br>
      push 405h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; ID Number
      нашего компонента<br>
      push dword ptr [ebp+8]<br>
      call esi<br>
      push eax<br>
      call ds:EnableWindow ; Enable/disable mouse and keyboard input<br>
      push ebx<br>
      push 406h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; ID Number
      нашего компонента<br>
      push dword ptr [ebp+8]<br>
      call esi<br>
      push eax<br>
      call ds:EnableWindow ; Enable/disable mouse and keyboard input<br>
      push ebx<br>
      push 407h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ; ID Number
      нашего компонента<br>
      push dword ptr [ebp+8]<br>
      call esi<br>
      push eax<br>
      call ds:EnableWindow ; Enable/disable mouse and keyboard input</font></samp></code></b></p>
      <p><b><code><samp><font color="#008000">loc_40240E:</font></samp></code></b></p>
    </blockquote>
    <p>&nbsp;&nbsp;&nbsp;&nbsp; Надеюсь, всем ясно, что делает
    этот код. В общих чертах - обнуляется регистр EBX,
    сравнивается с некоторой переменной. В
    результате сравнение осуществляется переход на
    ту часть программы, где блокируются
    соответсвующие визуальные элементы(сторого
    говоря, <strong>не осуществляется</strong> переход на ту
    часть программы, котрая продолжает работу без
    блокировки). Вариантов взлома - множество. Я
    вданном случае заменил переход <font color="#000000">jz short
    loc_40240E&nbsp; на jmp short loc_40240E. Для этого следует
    поменять байт 074h(jz) на 0EBh(jmp).</font></p>
    <p><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp; Самостоятельно
    изучите листинг программы, найдите
    соответсвующие инструкции. С помощью IDA внесите
    изменения там, где посчитаете нужным. Запустите
    модифицированный файл. Посмотрите, работает ли
    то,что не работало. Если вы все сделали правильно,
    то вы должны получить возможность выбора лечения
    зараженных файлов. Остается проделать тот же
    трюк с закладкой <u>Обьекты</u> и<u> Настройки</u>. Это
    вы вполне можете сделать сами. Так же, в качестве
    упражения уберите собщение о том, что отсутсвует
    ключевой файл(наличие этого собщения наводит на
    мысли - для антивируса достаточно создать файл
    AVP.KEY как он сразу перестает выбрасывать это же
    сообщение, хотя и работать от этого не начинает.
    Для монитора этот номер не проходит. Может
    монитор все-таки использует информацию из
    ключевого файла - проверьте сами). Побочным
    эффектом данного метода является то, что
    устанавливаемые опции не сохраняются, и в
    следующей сессии их приходится устанавливать
    еще раз. Эта проблема тоже имеет решение. Но мне
    хватило того, что сделал себе рабочую версию. </font></td>
  </tr>
  <tr>
    <td bgcolor="#FFFFEA"><p align="center"><font size="5" color="#0000A0"><strong>Заметки</strong></font></p>
    <p align="left"><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp; Перед началом
    работы, всегда следует проанализировать и
    попытаться представить, как именно программа
    защищена. Это может сильно облегчить жизнь.</font></p>
    <p align="left"><font color="#000000">Выражаю благодарность Fox'у
    Mulder'у за то, что он указал мне на этот продукт. Сам
    бы я не стал его исследовать и ломать - пользуюсь
    другим анивирусом - он компактнее, быстрее и
    работает под DOS.</font></p>
    <p align="left"><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp; Для связи с
    автором пишите <a HREF="mailto:ze_tty@yahoo.com">ze_tty@yahoo.com </a>.
    Если вы с помощью этой статьи не смогли сделать
    для себя работающую версию то пишите, и посмотрю,
    и скажу в чем ваша проблема. Учтите, что я никогда
    не буду заниматься взломом программ по заказу.
    Меня интересует лишь внутренняя работа
    программы.</font></td>
  </tr>
  <tr>
    <td bgcolor="#FFFFEA"><p align="center"><font size="5" color="#0000A0"><strong>Легально
    ли это?</strong></font></p>
    <p align="left"><strong><font color="#FF0000">&nbsp;&nbsp;&nbsp; Я даже не хочу
    напоминать(вы должны знать и помнить это сами),
    что данный материал публикуется только в
    образовательных целях. Если вы хотите
    использовать этот програмный продукт, то вы
    обязаны купить его. Если же вы не желаете
    покупать его, то для этого вам достаточно
    поискать на серверах распространяющих пиратские
    программы. Для этого вовсе не надо понимать
    механизм работы программы и схему ее защиты.
    Ответственность за веши действия несете только
    вы сами.</font></strong></td>
  </tr>
</table>
</body>
</html>
