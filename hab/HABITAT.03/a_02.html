<HTML><HEAD>
<TITLE>HABITAT ZINE/ISSUE #3/JUNE 2002 [articles][delphi_goodies!]</TITLE>

<STYLE type=text/css>
BODY {
	FONT-SIZE: 8pt; BACKGROUND: #2c468d; COLOR: #c0c0c0; FONT-FAMILY: "verdana"
}
A:link {
	COLOR: #c0c0c0; TEXT-DECORATION: none;FONT-SIZE: 8pt;
}
A:visited {
	COLOR: #c0c0c0; TEXT-DECORATION: none;FONT-SIZE: 8pt;
}
A:active {
	COLOR: #24bdff; TEXT-DECORATION: none;FONT-SIZE: 8pt;
}
A:hover {
	FONT-SIZE: 8pt; COLOR: #d2e9f9; TEXT-DECORATION: none; font-syle: "verdana"
}
P  {
        FONT-SIZE: 8pt; BACKGROUND: #2c468d; COLOR: #c0c0c0; FONT-FAMILY: "verdana"
   }
P.code{
        FONT-SIZE: 11pt; BACKGROUND: #2c468d; COLOR: #c0c0c0; FONT-FAMILY: "courier"
   }
H1 {
	FONT-SIZE: 22pt; COLOR: silver; FONT-FAMILY: "Times New Roman"; TEXT-ALIGN: center
}
H3 {
	FONT-SIZE: 14pt; COLOR: silver; FONT-FAMILY: courier; 
}
H4 {
	FONT-SIZE: 12pt; COLOR: silver; FONT-FAMILY: courier; 
}
I {
	COLOR: silver
}
B {
	FONT-WEIGHT: normal; COLOR: silver;FONT-SIZE: 8pt;
}
LI {
	FONT-WEIGHT: bold; MARGIN-LEFT: 3pt; COLOR: silver
}
CITE {
	FONT-WEIGHT: bold; FONT-SIZE: 16pt; COLOR: silver; FONT-FAMILY: "Times New Roman"
}
STRONG {
	FONT-WEIGHT: bold; COLOR: silver
}
</STYLE>

</HEAD>
<BODY topmargin=0 leftmargin=0>

<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<TR>
		<TD>
			<IMG SRC="images/habmenu_01.gif" WIDTH=110 HEIGHT=79></TD>
		<TD>
			<IMG SRC="images/habmenu_02.gif" WIDTH=68 HEIGHT=79></TD>
		<TD>
			<IMG SRC="images/habmenu_03.gif" WIDTH=71 HEIGHT=79></TD>
		<TD>
			<IMG SRC="images/habmenu_04.gif" WIDTH=84 HEIGHT=79></TD>
		<TD>
			<IMG SRC="images/habmenu_05.gif" WIDTH=167 HEIGHT=79></TD>
	</TR>
	<TR>
		<TD><a href="hb_content.html"><IMG border=0 SRC="images/habmenu_06.gif" WIDTH=110 HEIGHT=21></a></TD>
		<TD><a href="hb_content.html#virus"><IMG border=0 SRC="images/habmenu_07.gif" WIDTH=68 HEIGHT=21></a></TD>
		<TD><a href="hb_content.html#article"><IMG border=0 SRC="images/habmenu_08.gif" WIDTH=71 HEIGHT=21></a></TD>
		<TD><a href="hb_content.html#rubric"><IMG border=0 SRC="images/habmenu_09.gif" WIDTH=84 HEIGHT=21></a></TD>
		<TD>
			<IMG SRC="images/habmenu_10.gif" WIDTH=167 HEIGHT=21></TD>
	</TR>
</TABLE>
<table width=500 cellspacing=0 cellpadding=10>
<tr><td align=left valign=top width=500>
<h3>Дельфийские полезности</h3>
<p align=justfy>
Автор: D`ART  ( Black Cat Virology Network ). Перевод NeKr0!
</p>
<p align=justfy>
Типа привет!
Сегодня я рад представить вам немного кода, который может быть очень полезен
для ВирМакеров.
</p>
<p align=justify>
1. Как скрыть вашу прогу от  Ctrl+Alt+Del ?
</p>
<img src="images/cuthere.gif">
<pre>
function RegisterServiceProcess(dwProcessID, dwType: integer): 
         integer; stdcall; external 'KERNEL32.DLL';

implementation

procedure TForm1.Button1Click(Sender: TObject);
begin //Спрятать
  if not (csDesigning in ComponentState) then
    RegisterServiceProcess(GetCurrentProcessID, 1);
end;

procedure TForm1.Button2Click(Sender: TObject);
begin //Показать
  if not (csDesigning in ComponentState) then
    RegisterServiceProcess(GetCurrentProcessID, 0);
end;
</pre>
<img src="images/cuthere.gif">
<p align=justfy>
2. Как перехватить выход из Виндов?
</p>
<img src="images/cuthere.gif">
<pre>
...
private 
  { Private declarations } 
  procedure WMQE(var Message: TMessage); message WM_QUERYENDSESSION; 
...


procedure TMesForm.WMQE(var Message: TMessage); 
begin 
  inherited; 
  { Тут ваш код, который будет исполняться при выходе из Виндов}
end; 
</pre>
<img src="images/cuthere.gif">
<p align=justify>
3. Как получить список активных програм/задач?
</p>
<img src="images/cuthere.gif">
<pre>
procedure TTaskListForm.FormShow(Sender: TObject);
var
  Wnd : hWnd;
  buff: array [0..127] of Char;
begin
  ListBox1.Clear;
  Wnd := GetWindow(Handle, gw_HWndFirst);
  while Wnd <> 0 do begin
    if (Wnd <> Application.Handle) and IsWindowVisible(Wnd) and
      (GetWindow(Wnd, gw_Owner) = 0) and
      (GetWindowText(Wnd, buff, sizeof(buff)) <> 0) then begin
      GetWindowText(Wnd, buff, sizeof(buff));
      ListBox1.Items.Add(StrPas(buff));
    end;
    Wnd := GetWindow(Wnd, gw_hWndNext);
  end;
  ListBox1.ItemIndex := 0;
end;
</pre>
<img src="images/cuthere.gif">
<p align=justify>
4. Как скопировать выполняемую прогу (самокопирование)?
</p>
<img src="images/cuthere.gif">
<pre>
CopyFile( paramstr(0) ,'E:\DDD\Proga2.exe',False);
</pre>
<img src="images/cuthere.gif">
<p align=justify>
5. Как выполнить дргую прогу и дождаться конца ее выполнения? 
</p>
<img src="images/cuthere.gif">
<pre>
procedure Start;
var
  si: TStartupInfo;
  p:  TProcessInformation;
begin
  FillChar(Si,SizeOf(Si),0);
  with Si do begin
    cb := SizeOf( Si);
    dwFlags := startf_UseShowWindow;
    wShowWindow := 4;
  end;
  Form1.WindowState:=wsMinimized;
  Createprocess(nil,'Your_program.exe',nil,nil,false,
    Create_default_error_mode,nil,nil,si);
  Waitforsingleobject(p.hProcess,infinite);
  Form1.WindowState:=wsNormal;
end;
</pre>
<img src="images/cuthere.gif">
<p align=justify>
6. Как выполнить дргую прогу и дождаться конца ее выполнения? (вариант 2)
</p>
<img src="images/cuthere.gif">
<pre>
procedure TForm1.BtnArchClick(Sender: TObject);
var
  lpApplicationName   : PChar;
  lpCommandLine       : PChar;
  lpThreadAttributes,
  lpProcessAttributes : PSECURITYATTRIBUTES;
  bInheritHandles     : BOOL;
  dwCreationFlags     : DWORD;
  lpEnvironment       : Pointer;
  lpCurrentDirectory  : PChar;
  lpStartupInfo       : TSTARTUPINFO;
  lpProcessInformation: TPROCESSINFORMATION;
  lpExitCode          : DWORD;
  hProcess            : THandle;

begin
  lpApplicationName   := NIL;
  lpCommandLine       := 'arj.exe a dbf *.dbf';
  lpThreadAttributes  := NIL;
  lpProcessAttributes := NIL;
  bInheritHandles     := true;
  dwCreationFlags     := NORMAL_PRIORITY_CLASS;
  lpEnvironment       := NIL;
  lpCurrentDirectory  := NIL;
  with lpStartupInfo do begin
    cb              := SizeOf(TStartupInfo);
    lpReserved      := NIL;
    lpDesktop       := NIL;
    lpTitle         := PChar('Archiving');
    dwX             := 0;
    dwY             := 0;
    dwXSize         := 0;
    dwYSize         := 0;
    dwXCountChars   := 0;
    dwYCountChars   := 0;
    dwFillAttribute := 0;
    dwFlags         := 0;
    wShowWindow     := SW_SHOWDEFAULT;
    cbReserved2     := 0;
    lpReserved2     := NIL;
    hStdInput       := 0;
    hStdOutput      := 0;
    hStdError       := 0;
  end;
  if (not CreateProcess(lpApplicationName,lpCommandLine,
             lpProcessAttributes,lpThreadAttributes,bInheritHandles,
             dwCreationFlags,lpEnvironment,lpCurrentDirectory,
             lpStartupInfo,lpProcessInformation)) then begin
     Application.MessageBox('          ERROR          ',
               'WARNING!!!',ID_OK);
   end;
   hProcess := lpProcessInformation.hProcess;
   repeat
     GetExitCodeProcess(hProcess,lpExitCode);
     Application.ProcessMessages;
   until (lpExitCode <> STILL_ACTIVE); //Waiting for enclosure
end;
</pre>
<img src="images/cuthere.gif">
<p align=justify>
Типа ВСЕ !!!.....?
</p>
</BODY>
</HTML>